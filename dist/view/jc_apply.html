<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>检查申请</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all" />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <link rel="stylesheet" href="../css/table/iframe.css" media="all" />
    <style>
      /* 确保固定列与其他列高度一致 */
      .layui-table-fixed-r .layui-table-body tr {
        height: auto !important;
      }

      .layui-table-fixed-r .layui-table-cell {
        height: auto !important;
        white-space: normal !important;
        padding: 12px 8px !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
      }

      /* 确保固定列头部单元格与普通列保持一致 */
      .layui-table-fixed-r .layui-table-header .layui-table-cell {
        font-size: 14px !important;
        font-weight: bold !important;
        background-color: #f8f9fa !important;
        /* padding: 12px 8px !important; */
      }

      /* 操作按钮样式优化 */
      .layui-table .layui-btn-xs {
        height: 24px !important;
        line-height: 24px !important;
        padding: 0 8px !important;
        font-size: 12px !important;
        margin: 2px !important;
      }

      /* 确保固定列不会产生滚动条 */
      .layui-table-fixed-r {
        box-shadow: -1px 0 8px rgba(0, 0, 0, 0.08);
      }

      /* 修正固定列的行高与主表格保持一致 */
      .layui-table-fixed-r tbody tr {
        height: auto !important;
      }

      /* 确保固定列的内容垂直居中 */
      .layui-table-fixed-r .layui-table-cell {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
      }
    </style>
  </head>
  <body>
    <div class="layui-container">
      <div class="layui-row">
        <div class="layui-col-md12">
          <!-- <blockquote class="layui-elem-quote">
                    <i class="layui-icon layui-icon-list" style="font-size: 18px; margin-right: 8px;"></i>
                    检查申请信息
                </blockquote> -->

          <!-- 检查申请表格 -->
          <!-- <div class="table-title">检查表单</div> -->
          <table
            class="layui-hide"
            id="jiancha-table"
            lay-filter="jiancha-table"
          ></table>

          <!-- 操作列模板 -->
          <script type="text/html" id="rowBar">
            <button
              class="layui-btn layui-btn-xs layui-btn-normal"
              lay-event="detail"
            >
              详情
            </button>
            <button
              class="layui-btn layui-btn-danger layui-btn-xs"
              lay-event="delRow"
            >
              删除
            </button>
          </script>

          <!-- 工具栏模板 -->
          <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-warm" lay-event="newApply">
                <i class="layui-icon layui-icon-add-1"></i> 新建申请
              </button>
              <button
                class="layui-btn layui-btn-danger layui-btn-xs"
                id="batch-delete-btn"
              >
                <i class="layui-icon layui-icon-delete"></i> 批量删除
              </button>
            </div>
          </script>

          <!-- 状态模板 -->
          <script type="text/html" id="statusTpl">
            {{# if(d.exam_status == '0'){ }} 申请 {{# } else if(d.exam_status ==
            '1'){ }} 已登记 {{# } else { }} 未保存 {{# } }}
          </script>

          <!-- 日期格式化模板 -->
          <script type="text/html" id="dateTpl">
            {{# if(d.apply_date){ }} {{# var date = new Date(d.apply_date); var
            year = date.getFullYear(); var month = (date.getMonth() +
            1).toString().padStart(2, '0'); var day =
            date.getDate().toString().padStart(2, '0'); var hours =
            date.getHours().toString().padStart(2, '0'); var minutes =
            date.getMinutes().toString().padStart(2, '0'); var seconds =
            date.getSeconds().toString().padStart(2, '0'); }}
            {{year}}-{{month}}-{{day}} {{hours}}:{{minutes}}:{{seconds}} {{# }
            else { }} - {{# } }}
          </script>
        </div>
      </div>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      layui.use(["table", "appconfig", "layer", "form"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;
        var layer = layui.layer;
        var form = layui.form;

        // 获取URL参数
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");
        // 获取患者信息 (已在顶部显示，此处不再重复)

        // 套餐数据变量
        var examPackages = [];
        var allExamItems = []; // 所有检查项目数据

        // 获取检查项目数据
        function loadExamItems(callback) {
          var wardData = localStorage.getItem("wardData");

          if (wardData === null) {
            layer.msg("请先选择病区！");
            location.href = "view/wardlist.html";
            return;
          }
          var jsonData = JSON.parse(wardData);
          localStorage.ward_sn = jsonData.ward_sn;

          $.ajax({
            url:
              appconfig.api +
              "/api/JcJy/GetJianChaList?ward_sn=" +
              (localStorage.ward_sn || ""),
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.Status === 1 && res.Data) {
                allExamItems = res.Data;
                callback(true);
              } else {
                layer.msg("获取检查项目数据失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取检查项目数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取套餐数据
        function loadPackages(callback) {
          var loginUser = localStorage.getItem("loginUser");

          if (loginUser === null) {
            location.href = "index.html";
            return;
          }
          var loginUserData = JSON.parse(loginUser);
          $.ajax({
            url:
              "http://10.102.41.142:5105" +
              "/api/jcjy/GetCustomerTemplates?type=jiancha&opera=" +
              loginUserData.user_mi,
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.status === 1 && res.data) {
                examPackages = res.data;
                callback(true);
              } else {
                layer.msg("获取套餐数据失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取套餐数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取申请单编号
        function getApplySn(callback) {
          $.ajax({
            url: appconfig.api + "/api/JcJy/GetApplySn",
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.Status === 1 && res.Data) {
                callback(true, res.Data);
              } else {
                layer.msg("获取申请单编号失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false, null);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取申请单编号", { icon: 5 });
              callback(false, null);
            },
          });
        }

        // 提交检查申请
        function submitExamApply(selectedItems, callback) {
          console.log("提交检查申请 - selectedItems:", selectedItems);
          console.log("提交检查申请 - allExamItems长度:", allExamItems.length);

          var loginUser = localStorage.getItem("loginUser");
          var patientData = JSON.parse(
            localStorage.getItem("patientData") || "{}"
          );

          if (!loginUser) {
            layer.msg("登录信息已过期，请重新登录", { icon: 5 });
            callback(false);
            return;
          }

          var loginUserData = JSON.parse(loginUser);
          var todoList = [];
          var completedCount = 0;
          var totalCount = selectedItems.length;

          console.log("开始处理 selectedItems，总数:", totalCount);

          // 为每个选中的项目创建申请记录
          selectedItems.forEach(function (selectedItem) {
            console.log("处理 selectedItem:", selectedItem);

            // 从allExamItems中找到完整的项目信息
            var fullItem = allExamItems.find(function (item) {
              return (
                item.id == selectedItem.id ||
                item.code == selectedItem.id ||
                item.sub_code == selectedItem.id ||
                item.item_id == selectedItem.id
              );
            });

            console.log("找到的 fullItem:", fullItem);

            if (!fullItem) {
              console.log(
                "未找到对应的 fullItem，selectedItem.id:",
                selectedItem.id
              );
              console.log("allExamItems 样例数据:", allExamItems.slice(0, 3));
              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
              return;
            }

            // 获取申请单编号
            getApplySn(function (success, applyData) {
              console.log(
                "getApplySn 结果 - success:",
                success,
                "applyData:",
                applyData
              );

              if (success && applyData) {
                var wardData = JSON.parse(
                  localStorage.getItem("wardData") || "{}"
                );

                // 获取当前本地时间
                var now = new Date();
                var localDateTime =
                  now.getFullYear() +
                  "-" +
                  (now.getMonth() + 1).toString().padStart(2, "0") +
                  "-" +
                  now.getDate().toString().padStart(2, "0") +
                  " " +
                  now.getHours().toString().padStart(2, "0") +
                  ":" +
                  now.getMinutes().toString().padStart(2, "0") +
                  ":" +
                  now.getSeconds().toString().padStart(2, "0");

                var applyModel = {
                  // 申请单编号相关
                  exam_serial:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  apply_date: localDateTime,

                  // 检查项目信息
                  exam_type: fullItem.type_code || fullItem.exam_type || "",
                  exam_type_name:
                    fullItem.type_code_name || fullItem.exam_type_name || "",
                  exam_sub_type: fullItem.sub_code || fullItem.code || "",
                  exam_sub_type_name:
                    fullItem.sub_code_name ||
                    fullItem.name ||
                    fullItem.item_name ||
                    "",
                  exec_unit: fullItem.exec_unit || "",
                  exec_unit_name: fullItem.exec_unit_name || "",

                  // 基础字段
                  exam_no:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  patient_id: patient_id,
                  admiss_times: admiss_times,
                  apply_doctor: loginUserData.user_mi,
                  scheduled_date: localDateTime,
                  inpatient_no: patientData.inpatient_no || "",
                  apply_unit: wardData.ward_sn || localStorage.ward_sn || "",
                  erem_flag: "0", // 默认非急诊
                  exam_status: "0",
                  add_new: true,
                  charge_amount: 1,
                  zy_mz_flag: "1",
                  // 第三方申请信息
                  third_apply_type: fullItem.third_apply_type || "",
                  third_apply_class: fullItem.third_apply_class || "",

                  // 检查附加信息
                  exam_add_info: " ",
                  exam_add_info2: patientData.admiss_diag_name || " ",
                  exam_add_info3: " ",
                  exam_add_info4: " ",
                };

                console.log("创建的 applyModel:", applyModel);
                todoList.push(applyModel);
                console.log("添加到 todoList 后，长度:", todoList.length);
              } else {
                console.log("获取申请单编号失败");
              }

              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
            });
          });

          // 提交所有申请
          function submitAllApplies() {
            console.log("submitAllApplies - todoList长度:", todoList.length);
            console.log("submitAllApplies - todoList内容:", todoList);

            if (todoList.length === 0) {
              layer.msg("没有有效的申请数据", { icon: 5 });
              callback(false);
              return;
            }

            $.ajax({
              url: appconfig.api + "/api/JcJy/JianchaSubmit",
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify(todoList),
              dataType: "json",
              success: function (res) {
                if (res.Status === 1) {
                  callback(true);
                } else {
                  layer.msg("提交申请失败: " + (res.Msg || "未知错误"), {
                    icon: 5,
                  });
                  callback(false);
                }
              },
              error: function () {
                layer.msg("网络错误，申请提交失败", { icon: 5 });
                callback(false);
              },
            });
          }
        }

        // 渲染表格
        table.render({
          elem: "#jiancha-table",
          url:
            appconfig.api +
            "/api/JcJy/GetJianChaApplys_JZZXYY?patient_id=" +
            patient_id +
            "&admiss_times=" +
            admiss_times +
            "&subsys_id=" +
            (localStorage.subsys_id || ""),
          toolbar: "#toolbarDemo",
          defaultToolbar: [],
          cellMinWidth: 50,
          cols: [
            [
              { type: "checkbox", width: 40 },
              { field: "exam_serial", title: "申请单号", width: 110 },
              {
                field: "exam_status",
                title: "检查状态",
                width: 80,
                templet: "#statusTpl",
              },
              { field: "exam_type_name", title: "检查类型", width: 100 },
              { field: "exam_sub_type_name", title: "检查项目", minWidth: 180 },
              { field: "charge_amount", title: "数量", width: 60 },
              {
                field: "apply_date",
                title: "申请日期",
                width: 200,
                sort: true,
                templet: "#dateTpl",
              },
              { field: "exam_flag_str", title: "增强或重建", width: 90 },
              { field: "parent_serial", title: "父申请号", width: 100 },
              {
                // fixed: "right",
                title: "操作",
                width: 200,
                align: "center",
                toolbar: "#rowBar",
              },
            ],
          ],
          height: "full-42",
          text: {
            none: '<div style="text-align: center; padding: 20px; color: #999; font-size: 13px;"><i class="layui-icon layui-icon-file" style="font-size: 36px; display: block; margin-bottom: 8px;"></i>暂无检查申请数据</div>',
          },
          parseData: function (res) {
            console.log("表格接口返回数据:", res);
            return {
              code: res.Status === 1 ? 0 : res.Status,
              msg: res.msg || "",
              count: res.Data ? res.Data.length : 0,
              data: res.Data || [],
            };
          },
        });

        // 头工具栏事件
        table.on("toolbar(jiancha-table)", function (obj) {
          switch (obj.event) {
            case "newApply":
              // 显示加载提示
              var loadingIndex = layer.msg("正在加载数据...", {
                icon: 16,
                shade: 0.3,
                time: 0,
              });

              // 先加载检查项目数据，再加载套餐数据
              loadExamItems(function (itemsSuccess) {
                if (!itemsSuccess) {
                  layer.close(loadingIndex);
                  return;
                }

                // 加载套餐数据
                loadPackages(function (packagesSuccess) {
                  layer.close(loadingIndex);

                  if (!packagesSuccess) {
                    return;
                  }

                  // 生成套餐选择HTML
                  var packageHtml = "";
                  examPackages.forEach(function (pkg) {
                    packageHtml +=
                      '<div class="package-item" data-id="' +
                      pkg.id +
                      '">' +
                      '<div class="package-title">' +
                      (pkg.name || "未命名套餐") +
                      "</div>" +
                      '<div class="package-desc">' +
                      (pkg.value || "无描述") +
                      "</div>" +
                      "</div>";
                  });

                  layer.open({
                    type: 1,
                    title:
                      '<i class="layui-icon layui-icon-add-1"></i> 选择检查项目',
                    area: ["85%", "380px"],
                    maxmin: true,
                    resize: false,
                    content:
                      '<div class="package-form">' +
                      '<div class="package-content">' +
                      '<div class="package-selector">' +
                      '<div class="package-left">' +
                      '<div style="padding: 8px; background: #1e9fff; color: #fff; font-weight: bold; text-align: center; font-size: 13px;">检查套餐</div>' +
                      '<div class="package-list">' +
                      packageHtml +
                      "</div>" +
                      "</div>" +
                      '<div class="package-right">' +
                      '<div class="items-container">' +
                      '<div class="no-package-selected">' +
                      '<i class="layui-icon layui-icon-file" style="font-size: 36px; display: block; margin-bottom: 8px;"></i>' +
                      "请先选择左侧的检查套餐" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      '<div class="dialog-buttons">' +
                      '<button class="layui-btn layui-btn-normal" id="confirm-items">' +
                      '<i class="layui-icon layui-icon-ok"></i> 确认申请' +
                      "</button>" +
                      '<button class="layui-btn layui-btn-primary" id="cancel-items">' +
                      '<i class="layui-icon layui-icon-close"></i> 取消' +
                      "</button>" +
                      "</div>" +
                      "</div>",
                    success: function (layero, index) {
                      var selectedPackage = null;
                      var selectedItems = [];

                      // 显示项目列表
                      function showItems(pkg) {
                        var pkgTitle = pkg.title || pkg.name || "未命名套餐";
                        var itemsHtml =
                          '<div class="items-header">' +
                          pkgTitle +
                          " - 检查项目</div>" +
                          '<div class="items-list">';

                        // 根据套餐的value值过滤项目
                        var packageItems = [];
                        if (pkg.value && allExamItems.length > 0) {
                          var valueIds = pkg.value.split(",");
                          valueIds.forEach(function (id) {
                            var trimmedId = id.trim();
                            var item = allExamItems.find(function (examItem) {
                              return (
                                examItem.id == trimmedId ||
                                examItem.code == trimmedId
                              );
                            });
                            if (item) {
                              packageItems.push(item);
                            }
                          });
                        }
                        console.log("过滤后的项目数据:", packageItems);
                        if (packageItems.length > 0) {
                          packageItems.forEach(function (item) {
                            console.log("生成checkbox的item数据:", item);

                            // 尝试多个可能的id字段名
                            var itemId =
                              item.id ||
                              item.code ||
                              item.sub_code ||
                              item.item_id ||
                              "";
                            console.log("使用的itemId:", itemId);

                            itemsHtml +=
                              '<label class="item-checkbox">' +
                              '<input type="checkbox" value="' +
                              itemId +
                              '" data-name="' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              '" data-price="' +
                              (item.price || item.charge_amount || "0.00") +
                              '">' +
                              '<span class="item-name">' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              "</span>" +
                              "</label>";
                          });
                        } else {
                          itemsHtml +=
                            '<div style="text-align: center; padding: 50px; color: #999;">该套餐暂无项目数据</div>';
                        }

                        itemsHtml += "</div>";

                        $(layero).find(".items-container").html(itemsHtml);

                        // 监听项目选择
                        $(layero)
                          .find(".item-checkbox input")
                          .change(function () {
                            updateSelectedItems();
                          });
                      }

                      // 更新选中项目列表
                      function updateSelectedItems() {
                        selectedItems = [];
                        $(layero)
                          .find(".item-checkbox input:checked")
                          .each(function () {
                            selectedItems.push({
                              id: $(this).val(),
                              name: $(this).data("name"),
                              price: $(this).data("price"),
                            });
                          });
                      }

                      // 套餐选择事件
                      $(layero)
                        .find(".package-item")
                        .click(function () {
                          $(layero)
                            .find(".package-item")
                            .removeClass("selected");
                          $(this).addClass("selected");
                          selectedPackage = examPackages.find(
                            (pkg) => pkg.id == $(this).data("id")
                          );
                          selectedItems = []; // 切换套餐时清空已选项目
                          showItems(selectedPackage);
                        });

                      // 确认申请
                      $(layero)
                        .find("#confirm-items")
                        .click(function () {
                          if (!selectedPackage) {
                            layer.msg("请先选择一个检查套餐", { icon: 5 });
                            return;
                          }

                          if (selectedItems.length === 0) {
                            layer.msg("请至少选择一个检查项目", { icon: 5 });
                            return;
                          }

                          // 显示提交进度
                          var submitIndex = layer.msg("正在提交申请...", {
                            icon: 16,
                            shade: 0.3,
                            time: 0,
                          });

                          // 提交申请
                          submitExamApply(selectedItems, function (success) {
                            layer.close(submitIndex);
                            if (success) {
                              layer.msg("检查项目申请成功！", {
                                icon: 1,
                                time: 2000,
                                end: function () {
                                  layer.close(index);
                                  table.reload("jiancha-table");
                                },
                              });
                            }
                          });
                        });

                      // 取消申请
                      $(layero)
                        .find("#cancel-items")
                        .click(function () {
                          layer.close(index);
                        });
                    },
                  });
                });
              });
              break;
          }
        });

        // 操作列模板
        table.on("tool(jiancha-table)", function (obj) {
          var data = obj.data;
          var layEvent = obj.event;
          var loginUser = localStorage.getItem("loginUser");
          var patientData = JSON.parse(
            localStorage.getItem("patientData") || "{}"
          );

          if (!loginUser) {
            layer.msg("登录信息已过期，请重新登录", { icon: 5 });
            return;
          }

          var loginUserData = JSON.parse(loginUser);
          if (layEvent === "detail") {
            // 详情弹窗：请求接口获取报告URL并直接新标签页打开（SPA）
            var url =
              "http://10.101.199.142:5130/api/Third/GetTag20012?patient_id=001015074100&exam_no=2025072115484&exam_type=01";

            $.ajax({
              url: url,
              type: "GET",
              dataType: "json",
              timeout: 15000, // 15秒超时
              success: function (res) {
                if (res.status === 1 && res.data) {
                  var reportUrl = res.data;
                  if (reportUrl.indexOf("?") > -1) {
                    reportUrl += "&view=inline&display=web";
                  } else {
                    reportUrl += "?view=inline&display=web";
                  }
                  // 统一用window.open新标签页打开，无论PC还是移动端
                  window.open(reportUrl, "_blank", "noopener,noreferrer");
                } else {
                  layer.alert("未获取到有效的报告链接", { icon: 5 });
                }
              },
              error: function (xhr) {
                layer.alert(
                  "获取报告链接失败：" + (xhr.statusText || "网络错误"),
                  { icon: 5 }
                );
              },
            });
          } else if (layEvent === "delRow") {
            // 删除前先检查状态
            if (data.exam_status == 0) {
              layer.confirm(
                "确定删除该申请吗？",
                { icon: 3, title: "提示" },
                function (index) {
                  // 执行删除操作的代码
                  $.ajax({
                    url: appconfig.api + "/api/JcJy/DelJianCha",
                    type: "GET",
                    contentType: "application/json",
                    data: {
                      patient_id: data.patient_id,
                      admiss_times: data.admiss_times,
                      exam_no: data.exam_no,
                      sybsys_id: loginUserData.subsys_id,
                      opera: loginUserData.user_mi,
                    },
                    dataType: "json",
                    success: function (res) {
                      if (res.Status === 1) {
                        layer.msg("删除成功", { icon: 1 });
                        table.reload("jiancha-table");
                      } else {
                        layer.msg("删除失败: " + (res.msg || "未知错误"), {
                          icon: 5,
                        });
                      }
                    },
                    error: function () {
                      layer.msg("网络错误，删除失败", { icon: 5 });
                    },
                  });
                  layer.close(index);
                }
              );
            } else {
              layer.msg("该申请状态不可删除！", { icon: 5 });
            }
          }
        });
        // 批量删除按钮事件
        $(document).on("click", "#batch-delete-btn", function () {
          var checkStatus = table.checkStatus("jiancha-table");
          var selected = checkStatus.data;
          if (!selected || selected.length === 0) {
            layer.msg("请先勾选要删除的记录", { icon: 5 });
            return;
          }
          layer.confirm(
            "确定批量删除选中的申请吗？",
            { icon: 3, title: "提示" },
            function (index) {
              // 这里只做前端演示，实际应循环调用删除接口或提供批量接口
              var successCount = 0;
              var failCount = 0;
              var total = selected.length;
              var finished = 0;
              selected.forEach(function (row) {
                $.ajax({
                  url: appconfig.api + "/api/JcJy/DelJianCha",
                  type: "GET",
                  contentType: "application/json",
                  data: {
                    patient_id: row.patient_id,
                    admiss_times: row.admiss_times,
                    exam_no: row.exam_no,
                    sybsys_id: localStorage.loginUser
                      ? JSON.parse(localStorage.loginUser).subsys_id
                      : "",
                    opera: localStorage.loginUser
                      ? JSON.parse(localStorage.loginUser).user_mi
                      : "",
                  },
                  dataType: "json",
                  success: function (res) {
                    if (res.status === 1) {
                      successCount++;
                    } else {
                      failCount++;
                    }
                    finished++;
                    if (finished === total) {
                      layer.msg(
                        "批量删除完成，成功：" +
                          successCount +
                          "，失败：" +
                          failCount,
                        { icon: 1 }
                      );
                      table.reload("jiancha-table");
                    }
                  },
                  error: function () {
                    failCount++;
                    finished++;
                    if (finished === total) {
                      layer.msg(
                        "批量删除完成，成功：" +
                          successCount +
                          "，失败：" +
                          failCount,
                        { icon: 1 }
                      );
                      table.reload("jiancha-table");
                    }
                  },
                });
              });
              layer.close(index);
            }
          );
        });
      });
    </script>
  </body>
</html>
