<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>åŒ»å˜±ä¿¡æ¯</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="../lib/layui-v2.6.3/css/layui.css" media="all" />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <link rel="stylesheet" href="../css/table/iframe.css" media="all" />
    <!-- <style>
      body {
        background-color: transparent;
        padding: 0;
        margin: 0;
        font-size: 16px;
      }
      .layui-table-cell {
        height: auto;
        white-space: normal;
        padding: 4px 8px;
      }
      /* ç§»é™¤å®¹å™¨è¾¹è·ï¼Œä½¿ç”¨å…¨å®½ */
      .layui-container {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }
      .layui-row,
      .layui-col-md12 {
        padding: 0;
        margin: 0;
      }
      /* è¡¨æ ¼è¡Œè§¦æ‘¸æ•ˆæœ */
      .layui-table tbody tr:active {
        background-color: #f0f0f0;
      }
      /* è®©è¡¨æ ¼æ»šåŠ¨æ›´æµç•… */
      .layui-table-body {
        -webkit-overflow-scrolling: touch;
      }
      /* å¢å¤§æŒ‰é’®è§¦æ‘¸åŒºåŸŸ */
      .layui-btn {
        height: 40px;
        line-height: 40px;
      }
      
      /* æŒ‰é’®é€‰ä¸­çŠ¶æ€æ ·å¼ */
      
      
      /* æŒ‰é’®é»˜è®¤çŠ¶æ€ */
      .layui-btn {
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }
      
      /* æŒ‰é’®å®¹å™¨æ ·å¼ä¼˜åŒ– */
      .filter-buttons {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      /* è¡¨æ ¼æ ‡é¢˜æ ·å¼ */
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      .layui-table-tool-temp {
        padding-right: 0;
      }

      .layui-table-tool {
        padding: 5px;
      }

      .layui-table-view {
        margin: 0;
        width: 100%;
        height: calc(100% - 50px);
      }

      .layui-table-box,
      .layui-table-body {
        height: 100%;
      }

      .layui-table {
        margin: 0;
      }

      /* ç»Ÿä¸€è¡¨å¤´æ ·å¼ */
      .layui-table thead tr {
        background-color: #f2f2f2;
      }
      .layui-table thead th {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        padding: 8px 0;
        line-height: 1.2;
      }
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      /* æ ¹æ®åŒ»å˜±ç±»å‹è®¾ç½®è¡ŒèƒŒæ™¯è‰² */
      /* .order-type-long {
        background-color: #e6f7ff !important;
      }
      .order-type-once {
        background-color: #fffbe6 !important;
      }
      .order-type-temp {
        background-color: #ffeaea !important;
      }
      .order-type-other {
        background-color: #f4f4f4 !important;
      } */
    </style> -->
    <style>
      /* .myorder {
        background-color: skyblue;
      } */
      /* é€‰ä¸­æŒ‰é’®é«˜äº®æ ·å¼ï¼Œå…¼å®¹ä¸åŒè‰²ç³» */
      .btn-active {
        position: relative;
        z-index: 1;
        font-weight: bold !important;
        border-width: 2.5px !important;
        box-shadow: 0 2px 8px rgba(30, 185, 90, 0.18), 0 0 0 2px #b2f0c0 inset !important;
        outline: none !important;
      }
      /* é’ˆå¯¹ç»¿è‰²æŒ‰é’®ï¼ˆlayui-btn-warmï¼‰é€‰ä¸­æ—¶åŠ æ·±è‰² */
      .layui-btn-warm.btn-active {
        background-color: #3ec97c !important;
        border-color: #1eae5b !important;
        color: #fff !important;
      }
      /* é’ˆå¯¹çº¢è‰²æŒ‰é’®ï¼ˆlayui-btn-dangerï¼‰é€‰ä¸­æ—¶åŠ æ·±è‰² */
      .layui-btn-danger.btn-active {
        background-color: #e74c3c !important;
        border-color: #c0392b !important;
        color: #fff !important;
      }
      /* é’ˆå¯¹è“è‰²æŒ‰é’®ï¼ˆlayui-btn-primary/normal/cyanï¼‰é€‰ä¸­æ—¶åŠ æ·±è‰² */
      .layui-btn-primary.btn-active,
      .layui-btn-normal.btn-active,
      .layui-btn-cyan.btn-active {
        background-color: #1e9fff !important;
        border-color: #1786d4 !important;
        color: #fff !important;
      }
      /* å…¼å®¹å°å±å¹•æŒ‰é’®ç‚¹å‡»åé¦ˆ */
      .btn-active:active {
        box-shadow: 0 1px 4px rgba(30, 185, 90, 0.12) !important;
      }

      /* æŒ‰é’®æ‚¬åœæ•ˆæœ */
      .layui-btn:not(.btn-active):hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
      }

      /* selectæ¡†æ ·å¼ä¼˜åŒ– */
      .layui-form-select {
        height: 34px !important;
        width: 100px !important;
      }

      .layui-form-select .layui-select-title {
        height: 34px !important;
        line-height: 34px !important;
        font-size: 13px !important;
        color: #333 !important;
        border: 1px solid #e6e6e6 !important;
        border-radius: 2px !important;
      }

      .layui-form-select .layui-select-title input {
        height: 32px !important;
        line-height: 32px !important;
        font-size: 13px !important;
        color: #333 !important;
      }

      .layui-form-select dl {
        font-size: 13px !important;
      }

      .layui-form-select dl dd {
        line-height: 36px !important;
        color: #333 !important;
      }

      /* æ¨¡æ¿é€‰æ‹©æ¡†ç‰¹æ®Šæ ·å¼ - è¦†ç›–é»˜è®¤å®½åº¦é™åˆ¶ */
      #template-category,
      #template-detail {
        width: 100% !important;
        min-width: 300px !important;
      }

      /* é’ˆå¯¹æ¨¡æ¿é€‰æ‹©æ¡†çš„çˆ¶å®¹å™¨ */
      #template-category + .layui-form-select,
      #template-detail + .layui-form-select {
        width: 100% !important;
        min-width: 300px !important;
      }

      /* æ¨¡æ¿é€‰æ‹©æ¡†çš„æ ‡é¢˜åŒºåŸŸ */
      #template-category + .layui-form-select .layui-select-title,
      #template-detail + .layui-form-select .layui-select-title {
        width: 100% !important;
        min-width: 300px !important;
      }

      /* æ¨¡æ¿é€‰æ‹©æ¡†çš„è¾“å…¥æ¡† */
      #template-category + .layui-form-select .layui-select-title input,
      #template-detail + .layui-form-select .layui-select-title input {
        width: 100% !important;
        min-width: 290px !important;
      }
    </style>
  </head>
  <body>
    <div class="layui-container">
      <!-- æ“ä½œæ  -->
      <form class="layui-form">
        <div
          class="layui-btn-container filter-buttons"
          style="
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
          "
        >
          <!-- æ–°å¢åŒ»å˜±æŒ‰é’® -->
          <div style="display: flex; align-items: center; gap: 8px">
            <button
              type="button"
              id="btn-add-order"
              class="layui-btn layui-btn-sm layui-btn-primary"
            >
              <i class="layui-icon layui-icon-add-1"></i> æ–°å¢åŒ»å˜±
            </button>
          </div>
          <!-- åŒ»å˜±ç±»å‹ç­›é€‰ -->
          <div style="display: flex; gap: 8px; align-items: center">
            <span
              style="
                font-size: 13px;
                color: #666;
                font-weight: bold;
                white-space: nowrap;
                text-overflow: ellipsis;
              "
              >åŒ»å˜±ç±»å‹ï¼š</span
            >
            <select
              id="order-type-select"
              lay-filter="order-type-select"
              class="layui-select"
              style="font-size: 13px; width: 80px"
            >
              <option value="long">é•¿æœŸåŒ»å˜±</option>
              <option value="temp">ä¸´æ—¶åŒ»å˜±</option>
              <option value="all" selected>å…¨éƒ¨åŒ»å˜±</option>
            </select>
          </div>
          <!-- å¼€å˜±äººç­›é€‰ -->
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              margin-left: 20px;
            "
          >
            <span
              style="
                font-size: 13px;
                color: #666;
                font-weight: bold;
                white-space: nowrap;
                text-overflow: ellipsis;
              "
              >å¼€å˜±äººï¼š</span
            >
            <select
              id="role-type-select"
              lay-filter="role-type-select"
              class="layui-select"
              style="font-size: 13px; width: 120px"
            >
              <option value="doctor" selected>åŒ»ç”Ÿ</option>
              <option value="nurse">æŠ¤å£«</option>
              <option value="mine">æˆ‘çš„åŒ»å˜±</option>
              <option value="all-role">å…¨éƒ¨</option>
            </select>
          </div>
        </div>
      </form>
      <!-- åŒ»å˜±è¡¨æ ¼å®¹å™¨ -->
      <div class="table-container">
        <table
          class="layui-hide"
          id="yizhu-table"
          lay-filter="yizhu-table"
        ></table>
      </div>

      <!-- è¡Œå·¥å…·æ  -->
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="detail">è¯¦æƒ…</a>
      </script>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      // æ‰“å°æŒ‰é’®äº‹ä»¶
      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("btn-print");
        if (btn) {
          btn.onclick = function () {
            window.print();
          };
        }
      });
      layui.use(["table", "appconfig", "form"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;
        var form = layui.form;

        // ç«‹å³æ¸²æŸ“è¡¨å•å…ƒç´ ï¼Œç¡®ä¿selectæ¡†èƒ½æ­£å¸¸å·¥ä½œ
        form.render();

        // è·å–URLå‚æ•°
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");

        // è·å–æ‚£è€…ä¿¡æ¯å’Œç—…åŒºä¿¡æ¯
        var patientData = JSON.parse(
          localStorage.getItem("patientData") || "{}"
        );
        var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");
        var ward_sn = wardData.ward_sn || localStorage.ward_sn || "";
        var userData = localStorage.getItem("userData");
        var loginUser = JSON.parse(localStorage.getItem("loginUser") || "{}");
        if (userData === null) {
          layer.msg("è¯·å…ˆé€‰æ‹©æ‚£è€…ï¼");
          return;
        }
        var jsonData = JSON.parse(userData);

        // ç¼“å­˜å…¨éƒ¨åŒ»å˜±æ•°æ®
        var allYizhuData = [];

        // åŒ»å˜±æ¨¡æ¿æ•°æ® - ä»APIè·å–
        var orderTemplates = [];

        // å­˜å‚¨é€‰æ‹©çš„æ¨¡æ¿æ•°æ®
        var selectedCategoryData = null; // ä¸€çº§åˆ†ç±»æ•°æ®
        var selectedDetailData = null; // äºŒçº§åˆ†ç±»æ•°æ®

        // å½“å‰ç­›é€‰æ¡ä»¶
        var currentFilters = {
          orderType: "all", // 'long', 'temp', 'all'
          roleType: "doctor", // 'doctor', 'nurse',"mine", 'all-role'
        };
        var tableCols = [
          [
            { title: "å¼€å§‹", colspan: 7, align: "center" },
            { title: "å½•å…¥", colspan: 1, align: "center" },
            { title: "åœæ­¢", colspan: 1, align: "center" },
            { title: "æ“ä½œ", colspan: 1, align: "center" },
          ],
          [
            { field: "long_once_flag", title: "åŒ»å˜±ç±»å‹", width: 100 },
            { field: "start_time_mm_dd", title: "æ—¥æœŸ", width: 80 },
            {
              field: "order_name",
              title: "åŒ»å˜±",
              align: "center",
            },
            { field: "charge_amount", title: "æ•°é‡", width: 80 },
            { field: "frequ_name", title: "é¢‘ç‡", width: 80 },
            { field: "supply_name", title: "ç”¨æ³•", width: 80 },
            { field: "order_doctor_name", title: "åŒ»ç”Ÿ", width: 80 },
            { field: "enter_time_mm_dd", title: "æ—¥æœŸ", width: 80 },
            { field: "end_time_mm_dd", title: "æ—¥æœŸ", width: 80 },
            {
              // fixed: "right",
              title: "æ“ä½œ",
              toolbar: "#rowActionBar",
              width: 120,
              align: "center",
            },
          ],
        ];
        // è¡Œæ“ä½œæ æ¨¡æ¿
        var rowActionBar = `
          <div class="layui-btn-group">
            <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="revoke">æ’¤é”€</button>
            <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="stop">åœæ­¢</button>
          </div>
        `;
        // åŠ¨æ€æ’å…¥æ¨¡æ¿åˆ°é¡µé¢åº•éƒ¨
        if (!document.getElementById("rowActionBar")) {
          var tpl = document.createElement("script");
          tpl.type = "text/html";
          tpl.id = "rowActionBar";
          tpl.innerHTML = rowActionBar;
          document.body.appendChild(tpl);
        }

        // é¦–æ¬¡åŠ è½½æ•°æ®
        function loadYizhuData(callback) {
          $.ajax({
            url:
              appconfig.api +
              "/api/MobileWard/GetYzManageEOPOrders?ward_sn=" +
              ward_sn +
              "&inpatient_no=" +
              jsonData.inpatient_no,
            method: "GET",
            dataType: "json",
            success: function (res) {
              allYizhuData = res.Data || [];
              renderYizhuTable(allYizhuData);
              if (typeof callback === "function") callback();
            },
            error: function () {
              allYizhuData = [];
              renderYizhuTable([]);
              if (typeof callback === "function") callback();
            },
          });
        }

        // åœæ­¢åŒ»å˜±åŠŸèƒ½
        function stopMedicalOrder(orderData) {
          console.log("orderData:", orderData);

          // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var doctorName =
            currentUser.name || currentUser.user_name || "ç³»ç»Ÿç”¨æˆ·";
          var doctorCode = currentUser.user_mi || "00000";
          // è·å–å½“å‰æ—¶é—´
          var now = new Date();
          var stopTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // ç¡®è®¤å¯¹è¯æ¡†
          layer.confirm(
            "ç¡®å®šè¦åœæ­¢æ­¤åŒ»å˜±å—ï¼Ÿ<br>" +
              '<span style="color: #666; font-size: 12px;">åŒ»å˜±å†…å®¹ï¼š' +
              (orderData.order_name || "æœªçŸ¥") +
              "</span>",
            {
              icon: 3,
              title: "åœæ­¢åŒ»å˜±ç¡®è®¤",
              btn: ["ç¡®å®šåœæ­¢", "å–æ¶ˆ"],
            },
            function (index) {
              // æ„å»ºAPIå‚æ•°
              var apiParams = {
                patient_id: patient_id || orderData.patient_id,
                admiss_times: admiss_times || orderData.admiss_times,
                act_order_no: orderData.act_order_no || orderData.order_no,
                stop_doctor: doctorCode,
                stop_time: stopTime,
              };

              // è°ƒè¯•ä¿¡æ¯
              console.log("åœæ­¢åŒ»å˜±APIå‚æ•°:", apiParams);
              console.log("åŒ»å˜±æ•°æ®:", orderData);

              // éªŒè¯å¿…è¦å‚æ•°
              if (
                !apiParams.patient_id ||
                !apiParams.admiss_times ||
                !apiParams.act_order_no
              ) {
                layer.msg(
                  "ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œæ— æ³•åœæ­¢åŒ»å˜±<br>è¯·æ£€æŸ¥æ‚£è€…IDã€ä½é™¢æ¬¡æ•°å’ŒåŒ»å˜±ç¼–å·",
                  {
                    icon: 2,
                    time: 3000,
                  }
                );
                console.error("å‚æ•°éªŒè¯å¤±è´¥:", apiParams);
                return;
              }

              // æ˜¾ç¤ºåŠ è½½æç¤º
              var loadingIndex = layer.load(1, { shade: [0.3, "#000"] });
              console.log("apiParams:", apiParams);

              // è°ƒç”¨åœæ­¢åŒ»å˜±API
              $.ajax({
                url: appconfig.api + "/api/MobileWard/StopActYz",
                method: "GET",
                data: apiParams,
                dataType: "json",
                success: function (response) {
                  layer.close(loadingIndex);

                  if (response && response.Status) {
                    layer.msg("åŒ»å˜±åœæ­¢æˆåŠŸ", { icon: 1 });

                    // åˆ·æ–°è¡¨æ ¼æ•°æ®
                    loadYizhuData(function () {
                      applyFilters(); // é‡æ–°åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
                    });
                  } else {
                    var errorMsg =
                      response && response.Message
                        ? response.Message
                        : "åœæ­¢åŒ»å˜±å¤±è´¥";
                    layer.msg(errorMsg, { icon: 2, time: 4000 });
                    console.error("APIå“åº”é”™è¯¯:", response);
                  }

                  layer.close(index);
                },
                error: function (xhr, status, error) {
                  layer.close(loadingIndex);
                  layer.close(index);

                  var errorMsg = "ç½‘ç»œé”™è¯¯ï¼Œåœæ­¢åŒ»å˜±å¤±è´¥";

                  // è¯¦ç»†çš„é”™è¯¯å¤„ç†
                  if (xhr.responseJSON && xhr.responseJSON.Message) {
                    errorMsg = xhr.responseJSON.Message;

                    // ç‰¹æ®Šå¤„ç†SQLæ–‡ä»¶ç¼ºå¤±é”™è¯¯
                    if (
                      errorMsg.indexOf("Could not find file") !== -1 &&
                      errorMsg.indexOf("yz_stop_order.sql") !== -1
                    ) {
                      errorMsg =
                        "æœåŠ¡å™¨é…ç½®é”™è¯¯ï¼šç¼ºå°‘åœæ­¢åŒ»å˜±çš„SQLæ–‡ä»¶\nè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜æ£€æŸ¥æœåŠ¡å™¨é…ç½®";
                    }
                  } else if (xhr.status === 401) {
                    errorMsg = "æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•";
                  } else if (xhr.status === 500) {
                    errorMsg = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯";
                  } else if (xhr.status === 404) {
                    errorMsg = "APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®";
                  }

                  layer.msg(errorMsg, { icon: 2, time: 5000 });
                  console.error("AJAXé”™è¯¯è¯¦æƒ…:", {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error,
                  });
                },
              });
            }
          );
        }

        // åŠ è½½åŒ»å˜±æ¨¡æ¿æ•°æ®
        function loadOrderTemplates(callback) {
          // è·å–ç—…åŒºä¿¡æ¯ç”¨äºAPIè°ƒç”¨
          var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");
          var dept_sn = wardData.dept_sn || "1010300"; // é»˜è®¤ç§‘å®¤ç¼–å·ï¼Œå®é™…åº”ä»ç”¨æˆ·æ•°æ®è·å–

          $.ajax({
            url:
              appconfig.api +
              "/api/MobileWard/GetYzPatternList?dept_sn=" +
              dept_sn,
            method: "GET",
            dataType: "json",
            success: function (res) {
              if (res && res.Status && res.Data) {
                // è½¬æ¢APIæ•°æ®æ ¼å¼ä¸ºæ¨¡æ¿æ ¼å¼
                orderTemplates = res.Data.map(function (item) {
                  return {
                    id: item.pattern_code,
                    name: item.pattern_name,
                    code: item.pattern_code,
                    py_code: item.py_code,
                    d_code: item.d_code,
                    dept_sn: item.dept_sn,
                    ward_sn: item.ward_sn,
                    create_name: item.create_name,
                    // é»˜è®¤æ•°æ®ç»“æ„ï¼Œå®é™…ä½¿ç”¨æ—¶å¯èƒ½éœ€è¦è°ƒç”¨è¯¦æƒ…APIè·å–å…·ä½“åŒ»å˜±å†…å®¹
                    data: {
                      long_once_flag: "0",
                      order_type: "3",
                      order_name: item.pattern_name,
                      charge_amount: "1",
                      frequ_code: "ONCE",
                      supply_code: "",
                      exec_unit: item.ward_sn || ward_sn,
                      drug_specification: "",
                      order_code: item.pattern_code,
                      doseage: "",
                      doseage_unit: "",
                      instruction: "",
                      self_buy: "0",
                      skin_test_flag: "",
                    },
                  };
                });

                console.log("åŠ è½½åŒ»å˜±æ¨¡æ¿æˆåŠŸ:", orderTemplates);
              } else {
                console.warn("åŒ»å˜±æ¨¡æ¿æ•°æ®æ ¼å¼å¼‚å¸¸:", res);
                orderTemplates = [];
              }

              if (typeof callback === "function") callback();
            },
            error: function (xhr, status, error) {
              console.error("åŠ è½½åŒ»å˜±æ¨¡æ¿å¤±è´¥:", error);
              // æä¾›ä¸€äº›é»˜è®¤æ¨¡æ¿ä½œä¸ºå¤‡ç”¨
              orderTemplates = [
                {
                  id: "default_1",
                  name: "è¡€å¸¸è§„æ£€æŸ¥",
                  code: "default_1",
                  data: {
                    long_once_flag: "0",
                    order_type: "3",
                    order_name: "è¡€å¸¸è§„æ£€æŸ¥",
                    charge_amount: "1",
                    frequ_code: "ONCE",
                    supply_code: "",
                    exec_unit: ward_sn,
                    drug_specification: "",
                    order_code: "500001",
                    doseage: "",
                    doseage_unit: "",
                    instruction: "",
                    self_buy: "0",
                    skin_test_flag: "",
                  },
                },
              ];
              if (typeof callback === "function") callback();
            },
          });
        }

        // æ–°å¢åŒ»å˜±åŠŸèƒ½
        function addMedicalOrder() {
          // æ¸…ç©ºä¹‹å‰çš„æ¨¡æ¿æ•°æ®
          selectedCategoryData = null;
          selectedDetailData = null;

          // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var doctorCode = currentUser.user_mi || "00000";
          var doctorName =
            currentUser.user_mi || currentUser.user_name || "ç³»ç»Ÿç”¨æˆ·";

          // è·å–å½“å‰æ—¶é—´
          var now = new Date();
          var currentTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // å¼¹å‡ºæ–°å¢åŒ»å˜±è¡¨å•
          layer.open({
            type: 1,
            title: "æ–°å¢åŒ»å˜±",
            area: ["600px", "500px"],
            content: `
              <form class="layui-form" style="padding: 20px;" id="add-order-form">
                <!-- æ¨¡æ¿é€‰æ‹©åŒºåŸŸ - ä¸¤çº§é€‰æ‹© -->
                <div class="layui-form-item">
                  <label class="layui-form-label" style="color: #1e9fff; font-weight: bold;">é€‰æ‹©æ¨¡æ¿åˆ†ç±»</label>
                  <div class="layui-input-block">
                    <select name="template_category" lay-filter="template-category" id="template-category" style="width: 100%; min-width: 300px;">
                      <option value="">è¯·å…ˆé€‰æ‹©æ¨¡æ¿åˆ†ç±»</option>
                      ${orderTemplates
                        .map(
                          (template) =>
                            `<option value="${template.id}" title="${
                              template.create_name
                                ? "åˆ›å»ºè€…ï¼š" + template.create_name
                                : ""
                            }">${template.name}</option>`
                        )
                        .join("")}
                    </select>
                  </div>
                </div>
                
                <div class="layui-form-item" id="template-detail-row" style="display: none;">
                  <label class="layui-form-label" style="color: #1e9fff; font-weight: bold;">é€‰æ‹©å…·ä½“æ¨¡æ¿</label>
                  <div class="layui-input-block">
                    <select name="template_detail" lay-filter="template-detail" id="template-detail" style="width: 100%; min-width: 300px;">
                      <option value="">è¯·å…ˆé€‰æ‹©æ¨¡æ¿åˆ†ç±»</option>
                    </select>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <div class="layui-input-block">
                    <div style="background: #f0f9ff; padding: 10px; border-radius: 4px; font-size: 12px; color: #666; border-left: 3px solid #1e9fff;">
                      ğŸ’¡ æç¤ºï¼š<br>
                      1ï¸âƒ£ å…ˆé€‰æ‹©æ¨¡æ¿åˆ†ç±»ï¼Œç³»ç»Ÿä¼šåŠ è½½è¯¥åˆ†ç±»ä¸‹çš„å…·ä½“æ¨¡æ¿<br>
                      2ï¸âƒ£ ç„¶åé€‰æ‹©å…·ä½“æ¨¡æ¿ï¼Œä¼šè‡ªåŠ¨å¡«å……åŒ»å˜±ä¿¡æ¯<br>
                      ğŸ“‹ æ¨¡æ¿æ•°æ®æ¥æºï¼š${
                        orderTemplates.length > 0
                          ? "å·²ä»æœåŠ¡å™¨åŠ è½½ " +
                            orderTemplates.length +
                            " ä¸ªæ¨¡æ¿åˆ†ç±»"
                          : "æš‚æ— å¯ç”¨æ¨¡æ¿åˆ†ç±»"
                      }
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">åŒ»å˜±ç±»å‹</label>
                      <div class="layui-input-block">
                        <select name="long_once_flag" lay-verify="required">
                          <option value="">è¯·é€‰æ‹©</option>
                          <option value="1">é•¿æœŸåŒ»å˜±</option>
                          <option value="0">ä¸´æ—¶åŒ»å˜±</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">åŒ»å˜±ç±»å‹ä»£ç </label>
                      <div class="layui-input-block">
                        <input type="text" name="order_type" placeholder="å¦‚ï¼š3" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <label class="layui-form-label">åŒ»å˜±å†…å®¹</label>
                  <div class="layui-input-block">
                    <input type="text" name="order_name" lay-verify="required" placeholder="è¯·è¾“å…¥åŒ»å˜±å†…å®¹" class="layui-input">
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">æ•°é‡</label>
                      <div class="layui-input-block">
                        <input type="text" name="charge_amount" placeholder="å¦‚ï¼š1" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">é¢‘ç‡ä»£ç </label>
                      <div class="layui-input-block">
                        <input type="text" name="frequ_code" placeholder="å¦‚ï¼šONCE" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">ç”¨æ³•ä»£ç </label>
                      <div class="layui-input-block">
                        <input type="text" name="supply_code" placeholder="ç”¨æ³•ä»£ç " class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">æ‰§è¡Œç§‘å®¤</label>
                      <div class="layui-input-block">
                        <input type="text" name="exec_unit" placeholder="å¦‚ï¼š2020100" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">è¯ç‰©è§„æ ¼</label>
                      <div class="layui-input-block">
                        <input type="text" name="drug_specification" placeholder="è¯ç‰©è§„æ ¼" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">åŒ»å˜±ä»£ç </label>
                      <div class="layui-input-block">
                        <input type="text" name="order_code" placeholder="å¦‚ï¼š500004" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">å‰‚é‡</label>
                      <div class="layui-input-block">
                        <input type="number" name="doseage" placeholder="å‰‚é‡" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">å‰‚é‡å•ä½</label>
                      <div class="layui-input-block">
                        <input type="text" name="doseage_unit" placeholder="å‰‚é‡å•ä½" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <label class="layui-form-label">è¯´æ˜</label>
                  <div class="layui-input-block">
                    <textarea name="instruction" placeholder="è¯·è¾“å…¥è¯´æ˜" class="layui-textarea"></textarea>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">æ˜¯å¦è‡ªè´¹</label>
                      <div class="layui-input-block">
                        <select name="self_buy">
                          <option value="0">å¦</option>
                          <option value="1">æ˜¯</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">æ˜¯å¦çš®è¯•</label>
                      <div class="layui-input-block">
                        <select name="skin_test_flag">
                          <option value="">æ— éœ€çš®è¯•</option>
                          <option value="1">éœ€è¦çš®è¯•</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="add-order">ç«‹å³æäº¤</button>
                    <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">å–æ¶ˆ</button>
                  </div>
                </div>
              </form>
            `,
            success: function (layero, index) {
              // é‡æ–°æ¸²æŸ“è¡¨å•
              form.render();

              // ç›‘å¬æ¨¡æ¿åˆ†ç±»é€‰æ‹©äº‹ä»¶
              form.on("select(template-category)", function (data) {
                if (data.value) {
                  // ä¿å­˜é€‰æ‹©çš„ä¸€çº§åˆ†ç±»æ•°æ®
                  selectedCategoryData = orderTemplates.find(
                    (t) => t.id === data.value
                  );
                  console.log("ä¿å­˜çš„ä¸€çº§åˆ†ç±»æ•°æ®:", selectedCategoryData);

                  loadTemplateDetails(data.value);
                } else {
                  // æ¸…ç©ºåˆ†ç±»æ•°æ®
                  selectedCategoryData = null;
                  selectedDetailData = null;

                  // æ¸…ç©ºå…·ä½“æ¨¡æ¿é€‰æ‹©å¹¶éšè—
                  $("#template-detail").html(
                    '<option value="">è¯·å…ˆé€‰æ‹©æ¨¡æ¿åˆ†ç±»</option>'
                  );
                  $("#template-detail-row").hide();
                  form.render("select");
                }
              });

              // ç›‘å¬å…·ä½“æ¨¡æ¿é€‰æ‹©äº‹ä»¶
              form.on("select(template-detail)", function (data) {
                if (data.value) {
                  // è§£ææ¨¡æ¿è¯¦æƒ…IDè·å–äºŒçº§åˆ†ç±»æ•°æ®
                  var parts = data.value.split("_");
                  if (parts.length >= 2) {
                    var detailIndex = parseInt(parts[1]);
                    if (
                      selectedCategoryData &&
                      selectedCategoryData.details &&
                      selectedCategoryData.details[detailIndex]
                    ) {
                      selectedDetailData =
                        selectedCategoryData.details[detailIndex];
                      console.log("ä¿å­˜çš„äºŒçº§åˆ†ç±»æ•°æ®:", selectedDetailData);
                    }
                  }

                  fillTemplateData(data.value);
                } else {
                  selectedDetailData = null;
                }
              });

              // ç›‘å¬è¡¨å•æäº¤
              form.on("submit(add-order)", function (data) {
                submitNewOrder(data.field, index);
                return false;
              });
            },
          });
        }

        // åŠ è½½æ¨¡æ¿è¯¦æƒ…åˆ—è¡¨ï¼ˆç¬¬äºŒçº§ï¼‰
        function loadTemplateDetails(categoryId) {
          var category = orderTemplates.find((t) => t.id === categoryId);
          if (!category) return;

          var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");
          var loginUser = JSON.parse(localStorage.getItem("loginUser") || "{}");
          var dept_sn = wardData.dept_sn || "1010300";
          var emp_sn = loginUser.user_mi || loginUser.user_id || "1010302";
          var pattern_code = category.code;

          // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
          $("#template-detail").html(
            '<option value="">æ­£åœ¨åŠ è½½æ¨¡æ¿è¯¦æƒ…...</option>'
          );
          $("#template-detail-row").show();
          form.render("select");

          // è¯·æ±‚æ¨¡æ¿è¯¦æƒ…åˆ—è¡¨
          $.ajax({
            url: appconfig.api + "/api/MobileWard/GetYzPatternDetail",
            method: "GET",
            dataType: "json",
            data: {
              dept_sn: dept_sn,
              emp_sn: emp_sn,
              pattern_code: pattern_code,
            },
            success: function (res) {
              if (res && res.Status && res.Data && res.Data.length > 0) {
                // æ„å»ºå…·ä½“æ¨¡æ¿é€‰é¡¹
                var options = '<option value="">è¯·é€‰æ‹©å…·ä½“æ¨¡æ¿</option>';
                res.Data.forEach(function (detail, index) {
                  var templateName = detail.order_name || "æ¨¡æ¿" + (index + 1);
                  options += `<option value="${pattern_code}_${index}" title="åŒ»å˜±ï¼š${templateName}">${templateName}</option>`;
                });

                $("#template-detail").html(options);

                // ç¼“å­˜è¯¦æƒ…æ•°æ®ä¾›åç»­ä½¿ç”¨
                category.details = res.Data;

                console.log("åŠ è½½æ¨¡æ¿è¯¦æƒ…æˆåŠŸ:", res.Data);
                layer.msg("å·²åŠ è½½ " + res.Data.length + " ä¸ªå…·ä½“æ¨¡æ¿", {
                  icon: 1,
                  time: 1500,
                });
              } else {
                $("#template-detail").html(
                  '<option value="">è¯¥åˆ†ç±»ä¸‹æš‚æ— å¯ç”¨æ¨¡æ¿</option>'
                );
                console.warn("æ¨¡æ¿è¯¦æƒ…æ•°æ®æ ¼å¼å¼‚å¸¸:", res);
              }

              form.render("select");
            },
            error: function (xhr, status, error) {
              $("#template-detail").html(
                '<option value="">åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥</option>'
              );
              form.render("select");
              console.error("åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥:", error);
              layer.msg("åŠ è½½æ¨¡æ¿è¯¦æƒ…å¤±è´¥ï¼Œè¯·é‡è¯•", { icon: 2, time: 2000 });
            },
          });
        }

        // æ ¹æ®æ¨¡æ¿å¡«å……è¡¨å•æ•°æ®ï¼ˆä¿®æ”¹åçš„ç‰ˆæœ¬ï¼‰
        function fillTemplateData(templateDetailId) {
          // è§£ææ¨¡æ¿è¯¦æƒ…ID: pattern_code_index
          var parts = templateDetailId.split("_");
          if (parts.length < 2) return;

          var categoryId = parts[0];
          var detailIndex = parseInt(parts[1]);

          var category = orderTemplates.find((t) => t.code === categoryId);
          if (
            !category ||
            !category.details ||
            !category.details[detailIndex]
          ) {
            layer.msg("æ¨¡æ¿æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°é€‰æ‹©", { icon: 2, time: 2000 });
            return;
          }

          var templateData = category.details[detailIndex];
          var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");

          // å¡«å……è¡¨å•æ•°æ®
          $('select[name="long_once_flag"]').val(
            templateData.order_type === "3" ? "1" : "0"
          );
          $('input[name="order_type"]').val(templateData.order_type || "3");
          $('input[name="order_name"]').val(templateData.order_name || "");
          $('input[name="charge_amount"]').val(
            templateData.charge_amount || "1"
          );
          $('input[name="frequ_code"]').val(
            (templateData.frequ_code || "ONCE").trim()
          );
          $('input[name="supply_code"]').val(templateData.supply_code || "");
          $('input[name="exec_unit"]').val(wardData.ward_sn || "");
          $('input[name="drug_specification"]').val(
            templateData.drug_specification || ""
          );
          $('input[name="order_code"]').val(templateData.order_code || "");
          $('input[name="doseage"]').val(templateData.doseage || "");
          $('input[name="doseage_unit"]').val(templateData.doseage_unit || "");
          $('textarea[name="instruction"]').val(templateData.instruction || "");

          form.render();
          layer.msg("å·²åº”ç”¨æ¨¡æ¿ï¼š" + (templateData.order_name || "æ¨¡æ¿æ•°æ®"), {
            icon: 1,
            time: 2000,
          });
        }

        // æäº¤æ–°å¢åŒ»å˜±
        function submitNewOrder(formData, layerIndex) {
          // å¯ç”¨çš„æ¨¡æ¿æ•°æ®
          var categoryData = selectedCategoryData; // ä¸€çº§åˆ†ç±»æ•°æ®
          var detailData = selectedDetailData; // äºŒçº§åˆ†ç±»æ•°æ®

          console.log("è¡¨å•æ•°æ® formData:", formData);
          console.log("ä¸€çº§åˆ†ç±»æ•°æ® categoryData:", categoryData);
          console.log("äºŒçº§åˆ†ç±»æ•°æ® detailData:", detailData);

          // è·å–å½“å‰ç”¨æˆ·å’Œæ—¶é—´ä¿¡æ¯
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var patientData = JSON.parse(
            localStorage.getItem("userData") || "{}"
          );
          var doctorCode = currentUser.user_id || "00000";
          var doctorName =
            currentUser.user_mi || currentUser.user_name || "ç³»ç»Ÿç”¨æˆ·";
          var patient_id = patientData.patient_id || "00000";
          var admiss_times = patientData.admiss_times || "1";

          var now = new Date();
          var currentTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // æ„å»ºAPIå‚æ•°
          var apiParams = {
            act_order_no: detailData.act_order_no || "", // åç«¯ç”Ÿæˆ
            add_opera: doctorCode,
            // add_time: "",
            admiss_times: admiss_times,
            alter_print_order: "",
            ca_id_doctor: "05596",
            charge_amount: detailData.charge_amount || "1",
            discription: "",
            // doseage: "",
            // doseage_unit: detailData.doseage_unit || "",
            drop_speed: "",
            drug_occ: detailData.drug_occ || "",
            drug_specification: detailData.drug_specification || "",
            end_time: "",
            end_time_2: "",
            enter_oper: doctorCode,
            enter_time: currentTime,
            exec_unit: categoryData.data.exec_unit || "",
            exclusive_type: "1",
            fit_flag: "1",
            frequ_code: detailData.frequ_code || "ONCE",
            group_no: detailData.group_no || "000000",
            instruction: detailData.instruction || "",
            is_new: true,
            long_once_flag: categoryData.data.long_once_flag || "",
            modify_price: "",
            order_code: detailData.order_code || "",
            order_doctor: doctorCode,
            order_name: detailData.order_name || "",
            order_time: currentTime,
            order_type: detailData.order_type || "",
            parent_no: "",
            patient_id: patient_id,
            prev_flag: "",
            Serial: "**",
            self_buy: categoryData.data.self_buy || "",
            skin_test_flag: categoryData.data.skin_test_flag || "",
            spinfo_type: formData.self_buy === "1" ? "0" : "1",
            start_time: currentTime,
            status_flag: "0",
            supply_code: detailData.supply_code || "",
            ward_sn: categoryData.ward_sn || "",
          };

          console.log("æ–°å¢åŒ»å˜±APIå‚æ•°:", apiParams);

          // æ˜¾ç¤ºåŠ è½½æç¤º
          var loadingIndex = layer.load(1, { shade: [0.3, "#000"] });

          // è°ƒç”¨æ–°å¢åŒ»å˜±API
          $.ajax({
            url: appconfig.api + "/api/MobileWard/AddActYz",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify([apiParams]),
            dataType: "json",
            success: function (response) {
              layer.close(loadingIndex);

              if (response && response.Status) {
                layer.msg("åŒ»å˜±æ–°å¢æˆåŠŸ", { icon: 1 });
                layer.close(layerIndex); // å…³é—­è¡¨å•å¼¹çª—

                // åˆ·æ–°è¡¨æ ¼æ•°æ®
                loadYizhuData(function () {
                  applyFilters(); // é‡æ–°åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
                });
              } else {
                var errorMsg =
                  response && response.Message
                    ? response.Message
                    : "æ–°å¢åŒ»å˜±å¤±è´¥";
                layer.msg(errorMsg, { icon: 2, time: 4000 });
                console.error("APIå“åº”é”™è¯¯:", response);
              }
            },
            error: function (xhr, status, error) {
              layer.close(loadingIndex);

              var errorMsg = "ç½‘ç»œé”™è¯¯ï¼Œæ–°å¢åŒ»å˜±å¤±è´¥";

              if (xhr.responseJSON && xhr.responseJSON.Message) {
                errorMsg = xhr.responseJSON.Message;
              } else if (xhr.status === 401) {
                errorMsg = "æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•";
              } else if (xhr.status === 500) {
                errorMsg = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯";
              } else if (xhr.status === 404) {
                errorMsg = "APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®";
              }

              layer.msg(errorMsg, { icon: 2, time: 5000 });
              console.error("AJAXé”™è¯¯è¯¦æƒ…:", {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error,
              });
            },
          });
        }

        // æ’¤é”€åŒ»å˜±åŠŸèƒ½
        function revokeMedicalOrder(orderData) {
          console.log("æ’¤é”€åŒ»å˜± orderData:", orderData);

          // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var operatorCode = currentUser.user_mi || "00000";

          // ç¡®è®¤å¯¹è¯æ¡†
          layer.confirm(
            "ç¡®å®šè¦æ’¤é”€æ­¤åŒ»å˜±å—ï¼Ÿ<br>" +
              '<span style="color: #ff5722; font-size: 12px;">æ³¨æ„ï¼šæ’¤é”€ååŒ»å˜±å°†è¢«æ°¸ä¹…åˆ é™¤</span><br>' +
              '<span style="color: #666; font-size: 12px;">åŒ»å˜±å†…å®¹ï¼š' +
              (orderData.order_name || "æœªçŸ¥") +
              "</span>",
            {
              icon: 3,
              title: "æ’¤é”€åŒ»å˜±ç¡®è®¤",
              btn: ["ç¡®å®šæ’¤é”€", "å–æ¶ˆ"],
            },
            function (index) {
              // æ„å»ºAPIå‚æ•°
              var apiParams = {
                patient_id: patient_id || orderData.patient_id,
                admiss_times: admiss_times || orderData.admiss_times,
                act_order_no: orderData.act_order_no || orderData.order_no,
                opera: loginUser.user_mi,
                cancel_mode: "1", // æ’¤é”€æ¨¡å¼ï¼Œ1è¡¨ç¤ºæ’¤é”€
                pre_cancel_step: "2", // é¢„æ’¤é”€æ­¥éª¤ï¼Œ1è¡¨ç¤ºç›´æ¥æ’¤é”€
              };

              // è°ƒè¯•ä¿¡æ¯
              console.log("æ’¤é”€åŒ»å˜±APIå‚æ•°:", apiParams);
              console.log("åŒ»å˜±æ•°æ®:", orderData);

              // éªŒè¯å¿…è¦å‚æ•°
              if (
                !apiParams.patient_id ||
                !apiParams.admiss_times ||
                !apiParams.act_order_no
              ) {
                layer.msg(
                  "ç¼ºå°‘å¿…è¦å‚æ•°ï¼Œæ— æ³•æ’¤é”€åŒ»å˜±<br>è¯·æ£€æŸ¥æ‚£è€…IDã€ä½é™¢æ¬¡æ•°å’ŒåŒ»å˜±ç¼–å·",
                  {
                    icon: 2,
                    time: 3000,
                  }
                );
                console.error("å‚æ•°éªŒè¯å¤±è´¥:", apiParams);
                return;
              }

              // æ˜¾ç¤ºåŠ è½½æç¤º
              var loadingIndex = layer.load(1, { shade: [0.3, "#000"] });

              // è°ƒç”¨æ’¤é”€åŒ»å˜±API
              $.ajax({
                url: appconfig.api + "/api/MobileWard/CancelActYz",
                method: "GET",
                data: apiParams,
                dataType: "json",
                success: function (response) {
                  layer.close(loadingIndex);

                  if (response && response.Status) {
                    layer.msg("åŒ»å˜±æ’¤é”€æˆåŠŸ", { icon: 1 });

                    // åˆ·æ–°è¡¨æ ¼æ•°æ®
                    loadYizhuData(function () {
                      applyFilters(); // é‡æ–°åº”ç”¨å½“å‰ç­›é€‰æ¡ä»¶
                    });
                  } else {
                    var errorMsg =
                      response && response.Message
                        ? response.Message
                        : "æ’¤é”€åŒ»å˜±å¤±è´¥";
                    layer.msg(errorMsg, { icon: 2, time: 4000 });
                    console.error("APIå“åº”é”™è¯¯:", response);
                  }

                  layer.close(index);
                },
                error: function (xhr, status, error) {
                  layer.close(loadingIndex);
                  layer.close(index);

                  var errorMsg = "ç½‘ç»œé”™è¯¯ï¼Œæ’¤é”€åŒ»å˜±å¤±è´¥";

                  // è¯¦ç»†çš„é”™è¯¯å¤„ç†
                  if (xhr.responseJSON && xhr.responseJSON.Message) {
                    errorMsg = xhr.responseJSON.Message;
                  } else if (xhr.status === 401) {
                    errorMsg = "æƒé™ä¸è¶³ï¼Œè¯·é‡æ–°ç™»å½•";
                  } else if (xhr.status === 500) {
                    errorMsg = "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯";
                  } else if (xhr.status === 404) {
                    errorMsg = "APIæ¥å£ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®";
                  }

                  layer.msg(errorMsg, { icon: 2, time: 5000 });
                  console.error("AJAXé”™è¯¯è¯¦æƒ…:", {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error,
                  });
                },
              });
            }
          );
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderYizhuTable(data) {
          table.render({
            elem: "#yizhu-table",
            data: data,
            defaultToolbar: [],
            cols: tableCols,
            height: "full-60", // å‡å»è¿‡æ»¤æŒ‰é’®åŒºåŸŸçš„é«˜åº¦
            text: {
              none: "æš‚æ— åŒ»å˜±æ•°æ®",
            },
            done: function (res, curr, count) {
              // æ ¹æ®åŒ»å˜±ç±»å‹è®¾ç½®è¡ŒèƒŒæ™¯è‰²
              $("#yizhu-table")
                .next(".layui-table-view")
                .find("tbody tr")
                .each(function (i, tr) {
                  var row = data[i];
                  if (!row) return;
                  var type = (row.long_once_flag || "").toLowerCase();
                  if (type.indexOf("é•¿") !== -1 || type === "long") {
                    $(tr).addClass("order-type-long");
                  } else if (type.indexOf("ä¸´") !== -1 || type === "once") {
                    $(tr).addClass("order-type-once");
                  } else if (type.indexOf("å¤‡") !== -1 || type === "temp") {
                    $(tr).addClass("order-type-temp");
                  } else {
                    $(tr).addClass("order-type-other");
                  }
                  if (row.order_doctor_name) {
                    $(tr).addClass("myorder");
                  }
                });
            },
          });
        }

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilters() {
          var filtered = allYizhuData.filter(function (item) {
            var matchOrderType = true;
            var matchRoleType = true;

            // åŒ»å˜±ç±»å‹ç­›é€‰
            if (currentFilters.orderType === "long") {
              matchOrderType = String(item.long_once_flag) === "1";
            } else if (currentFilters.orderType === "temp") {
              matchOrderType = String(item.long_once_flag) === "0";
            }
            // 'all' ä¸éœ€è¦ç­›é€‰æ¡ä»¶

            // å¼€å˜±äººç±»å‹ç­›é€‰
            if (currentFilters.roleType === "doctor") {
              matchRoleType = String(item.fit_flag) === "1";
            } else if (currentFilters.roleType === "nurse") {
              matchRoleType = String(item.fit_flag) === "0";
            } else if (currentFilters.roleType === "mine") {
              matchRoleType = item.order_doctor === loginUser.user_mi;
            }
            // 'all-role' ä¸éœ€è¦ç­›é€‰æ¡ä»¶

            return matchOrderType && matchRoleType;
          });

          renderYizhuTable(filtered);

          // æ˜¾ç¤ºç­›é€‰ç»“æœæç¤º
          var orderTypeText =
            currentFilters.orderType === "long"
              ? "é•¿æœŸåŒ»å˜±"
              : currentFilters.orderType === "temp"
              ? "ä¸´æ—¶åŒ»å˜±"
              : "å…¨éƒ¨åŒ»å˜±";
          var roleTypeText =
            currentFilters.roleType === "doctor"
              ? "åŒ»ç”ŸåŒ»å˜±"
              : currentFilters.roleType === "nurse"
              ? "æŠ¤å£«åŒ»å˜±"
              : currentFilters.roleType === "mine"
              ? "æˆ‘çš„åŒ»å˜±"
              : "å…¨éƒ¨";

          if (
            currentFilters.orderType !== "all" ||
            currentFilters.roleType !== "all-role"
          ) {
            layer.msg(`å·²ç­›é€‰ï¼š${orderTypeText} - ${roleTypeText}`, {
              icon: 1,
              time: 1500,
            });
          } else {
            layer.msg("å·²æ˜¾ç¤ºå…¨éƒ¨åŒ»å˜±", { icon: 1, time: 1000 });
          }
        }

        // selectæ¡†ç­›é€‰äº‹ä»¶ - åŒ»å˜±ç±»å‹
        form.on("select(order-type-select)", function (data) {
          console.log("åŒ»å˜±ç±»å‹selectè§¦å‘äº†:", data.value);
          currentFilters.orderType = data.value;
          applyFilters();
        });

        // selectæ¡†ç­›é€‰äº‹ä»¶ - å¼€å˜±äººç±»å‹
        form.on("select(role-type-select)", function (data) {
          console.log("å¼€å˜±äººç±»å‹selectè§¦å‘äº†:", data.value);
          currentFilters.roleType = data.value;
          applyFilters();
        });

        // æ–°å¢åŒ»å˜±æŒ‰é’®äº‹ä»¶
        $(document).on("click", "#btn-add-order", function () {
          addMedicalOrder();
        });

        // é»˜è®¤åŠ è½½å…¨éƒ¨å¹¶è®¾ç½®é»˜è®¤é€‰ä¸­çŠ¶æ€ï¼Œé¦–æ¬¡åŠ è½½åç«‹å³åº”ç”¨ç­›é€‰æ¡ä»¶
        loadOrderTemplates(function () {
          loadYizhuData(applyFilters);
        });

        // å¤´å·¥å…·æ äº‹ä»¶
        table.on("toolbar(yizhu-table)", function (obj) {
          switch (obj.event) {
            case "refresh":
              table.reload("yizhu-table");
              break;
            case "export":
              layer.msg("å¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...");
              break;
          }
        });

        // è¡Œå·¥å…·æ äº‹ä»¶
        table.on("tool(yizhu-table)", function (obj) {
          var data = obj.data;
          if (obj.event === "detail") {
            layer.open({
              type: 1,
              title: "åŒ»å˜±è¯¦æƒ…",
              area: ["600px", "400px"],
              content:
                '<div style="padding: 20px;">' +
                "<p><strong>åŒ»å˜±æ—¥æœŸï¼š</strong>" +
                data.order_date +
                " " +
                data.order_time +
                "</p>" +
                "<p><strong>åŒ»å˜±ç±»å‹ï¼š</strong>" +
                data.order_type_name +
                "</p>" +
                "<p><strong>åŒ»å˜±å†…å®¹ï¼š</strong>" +
                data.order_text +
                "</p>" +
                "<p><strong>å‰‚é‡ï¼š</strong>" +
                (data.dosage || "") +
                "</p>" +
                "<p><strong>é¢‘æ¬¡ï¼š</strong>" +
                (data.frequency || "") +
                "</p>" +
                "<p><strong>ç”¨æ³•ï¼š</strong>" +
                (data.usage || "") +
                "</p>" +
                "<p><strong>å¼€å˜±åŒ»ç”Ÿï¼š</strong>" +
                data.doctor_name +
                "</p>" +
                "<p><strong>çŠ¶æ€ï¼š</strong>" +
                data.status_name +
                "</p>" +
                "</div>",
            });
          } else if (obj.event === "revoke") {
            revokeMedicalOrder(data);
          } else if (obj.event === "stop") {
            stopMedicalOrder(data);
          }
        });
      });
    </script>
  </body>
</html>
