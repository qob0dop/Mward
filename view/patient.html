<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>患者信息</title>
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> -->
    <!-- <meta http-equiv="Access-Control-Allow-Origin" content="*"> -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <link
      rel="stylesheet"
      href="../lib/layui-v2.6.3/css/layui.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <link rel="stylesheet" href="../css/patient.css" media="all" />
    <style>
      .layui-btn:not(.layui-btn-lg):not(.layui-btn-sm):not(.layui-btn-xs) {
        height: 34px;
        line-height: 34px;
        padding: 0 8px;
      }

      .layui-input {
        color: dodgerblue;
      }

      .layui-btn-radius {
        width: 80px;
      }

      body {
        background-color: transparent;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      .layui-elem-quote {
        padding: 5px 15px;
        margin: 0;
        font-weight: bold;
        font-size: 1.1rem;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .layui-layer-setwin a {
        height: 26px;
        transform: scale(1.5);
      }

      /* 页面布局样式 */
      .main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        /* 为底部栏留出空间，避免内容被遮挡 */
        padding-bottom: 60px;
      }

      .layuimini-container {
        padding: 0;
        margin: 0;
        border: none;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .layuimini-main {
        padding: 0;
        margin: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* 底部选项卡样式 */
      .bottom-tabs {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        border-top: 2px solid #e6e6e6;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        /* height: 60px; */
        margin: 0;
        padding: 0;
      }

      .bottom-tabs .layui-tab-title {
        margin: 0;
        background: #fff;
        border: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        height: 100%;
        align-items: center;
        overflow-x: visible;
        overflow-y: visible;
        white-space: normal;
        min-width: 0;
        width: 100%;
      }
      .bottom-tabs .layui-tab-title::-webkit-scrollbar {
        display: none;
      }
      .bottom-tabs .layui-tab-title li {
        position: relative;
        background: transparent;
        border: none;
        margin: 0.3rem 0.6rem;
        padding: 0.7rem 1.2rem;
        transition: all 0.3s ease;
        border-radius: 0;
        flex: none;
        height: auto;
        line-height: 1.2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        white-space: nowrap;
      }

      .bottom-tabs .layui-tab-title li:hover {
        background: #e8f4fd;
        color: #1e9fff;
        border-radius: 6px;
      }

      .bottom-tabs .layui-tab-title li.layui-this {
        background: linear-gradient(135deg, #1e9fff 0%, #1890ff 100%);
        color: #fff;
        font-weight: bold;
        box-shadow: 0 -2px 8px rgba(30, 159, 255, 0.3);
        border-radius: 8px;
      }

      @media (max-width: 800px) {
        .bottom-tabs {
          height: 48px;
        }
        .main-content {
          padding-bottom: 48px;
        }
        .bottom-tabs .layui-tab-title li {
          padding: 0.4rem 0.7rem;
          font-size: 0.85rem;
        }
      }

      /* 选项卡内容区域 */
      .tab-content-area {
        flex: 1;
        overflow-y: auto;
        margin: 0;
        position: relative;
        background: #fff;
      }

      .layui-tab-content {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      .layui-tab-item {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      /* iframe容器样式 */
      .tab-iframe-container {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      /* 确保iframe填满容器 */
      .tab-content-area iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      /* 患者信息表单样式 */
      .layui-form {
        margin: 0;
        padding: 10px 15px;
        height: 100%;
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
      }

      .layui-form-item {
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .option-bar {
        width: 100vw;
        overflow-x: auto;
        white-space: nowrap;
        background: #fff;
        padding: 0 0 0 8px;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
        display: flex;
        gap: 12px;
        border-top: 2px solid #e6e6e6;
      }
      .tab-btn {
        min-width: 120px;
        max-width: 120px;
        height: 48px;
        background: #fff;
        border: none;
        border-radius: 6px 6px 0 0;
        font-size: 16px;
        color: #333;
        margin: 0;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 3px rgba(30, 159, 255, 0.04);
        outline: none;
      }
      .tab-btn.layui-this,
      .tab-btn.active {
        background: linear-gradient(135deg, #1e9fff 0%, #1890ff 100%);
        color: #fff;
        font-weight: bold;
        box-shadow: 0 -2px 8px rgba(30, 159, 255, 0.3);
      }
      .tab-btn:hover {
        background: #e8f4fd;
        color: #1e9fff;
      }
      .option-bar::-webkit-scrollbar {
        display: none;
      }
      .bottom-tab-placeholder {
        height: 60px; /* 或底部栏实际高度 */
        background: transparent; /* 或#fff，视你页面风格而定 */
        width: 100%;
        pointer-events: none;
      }
      #patient-header-info {
        margin: 0 auto;
        display: inline-block;
        text-align: center;
      }
      @media (max-width: 800px) {
        .bottom-tab-placeholder {
          height: 48px;
        }
      }
    </style>
  </head>
  <body>
    <div class="layuimini-container">
      <div class="layuimini-main main-content">
        <blockquote class="layui-elem-quote">
          <button
            type="button"
            class="layui-btn layui-btn-sm layui-btn-warm btn-switch-patient"
            id="btn-switch-patient"
          >
            切换患者
          </button>

          <span id="patient-header-info">患者详细信息</span>
          <button
            type="button"
            class="layui-btn layui-btn-sm layui-btn-normal btn-back"
            onclick="javascrript:window.history.back()"
          >
            <i class="layui-icon"></i>返回
          </button>
          <!--<button class="layui-btn layui-btn-sm" onclick="javascrript:location.reload()" style="float: right;">刷新</button>-->
          <!--<button class="layui-btn layui-btn-normal" id="btn-fold">全部折叠</button>
                <button type="button" class="layui-btn layui-btn-primary" id="test-page-title">剔除默认标题栏</button>-->
          <br />
        </blockquote>

        <!-- 选项卡内容显示区域 -->
        <div id="patient-switch-list">
          <div class="list-header">
            <span>病人列表</span>
            <span class="close-btn" id="close-patient-list">✕</span>
          </div>
          <table
            class="layui-table"
            id="switch-patient-table"
            lay-filter="switch-patient-table"
          ></table>
        </div>
        <div class="tab-content-area">
          <div class="layui-tab-content">
            <!-- 患者信息选项卡 -->
            <div class="layui-tab-item layui-show" id="tab-patient">
              <form class="layui-form layui-form-pane" action="">
                <div class="layui-form-item">
                  <label class="layui-form-label">患者姓名</label>
                  <div class="layui-input-inline">
                    <!--<div class="layui-input-block">-->
                    <input
                      type="text"
                      name="pname"
                      autocomplete="off"
                      placeholder=""
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">次数</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="admiss_times"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">入院日期</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="admiss_date"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">入院天数</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="admiss_days"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">性别</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="sex_name"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">年龄</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="ages"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">住院号</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="inpatient_no"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">床号</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="bed_no"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">管床医生</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="refer_physician_name"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">管床护士</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="refer_nurse_name"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>

                <div class="layui-form-item">
                  <label class="layui-form-label">诊断代码</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="admiss_diag"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">诊断名称</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="admiss_diag_name"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
                <div class="layui-form-item">
                  <label class="layui-form-label">护理级别</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="nursing"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                  <label class="layui-form-label">身份</label>
                  <div class="layui-input-inline">
                    <input
                      type="text"
                      name="responce_type_name"
                      lay-verify="required"
                      placeholder=""
                      autocomplete="off"
                      class="layui-input"
                      readonly
                    />
                  </div>
                </div>
              </form>
            </div>
            <!-- 医嘱选项卡 -->
            <div class="layui-tab-item" id="tab-yizhu">
              <div id="yizhu-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载医嘱信息...</div>
                </div>
              </div>
            </div>
            <!-- 检验选项卡 -->
            <div class="layui-tab-item" id="tab-jianyan">
              <div id="jianyan-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载检验信息...</div>
                </div>
              </div>
            </div>
            <!-- 检查选项卡 -->
            <div class="layui-tab-item" id="tab-jiancha">
              <div id="jiancha-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载检查信息...</div>
                </div>
              </div>
            </div>
            <!-- 电子病历选项卡 -->
            <div class="layui-tab-item" id="tab-dianzibingli">
              <div id="dianzibingli-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载电子病历信息...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 底部选项卡 -->
        <div class="bottom-tabs">
          <div class="option-bar" id="tab-btn-bar">
            <button class="tab-btn layui-this" data-index="0">患者信息</button>
            <button class="tab-btn" data-index="1">医嘱</button>
            <button class="tab-btn" data-index="2">检验</button>
            <button class="tab-btn" data-index="3">检查</button>
            <button class="tab-btn" data-index="4">电子病历</button>
            <button class="tab-btn" data-index="5">医生文书</button>
            <button class="tab-btn" data-index="6">护理文书</button>
            <button class="tab-btn" data-index="7">护理记录</button>
            <button class="tab-btn" data-index="8">体温单</button>
            <button class="tab-btn" data-index="9">手术信息</button>
          </div>
        </div>
      </div>
      <div class="bottom-tab-placeholder"></div>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      layui.use(
        ["table", "treetable", "appconfig", "element", "layer"],
        function () {
          var $ = layui.jquery;
          var table = layui.table;
          var treetable = layui.treetable;
          var appconfig = layui.appconfig;
          var element = layui.element;
          var layer = layui.layer;
          var userData = localStorage.getItem("userData");

          if (userData === null) {
            layer.msg("请先选择患者！");
            return;
          } else {
            var jsonData = JSON.parse(userData);
            $("#patient-header-info").html(
              '<i class="layui-icon layui-icon-username" style="font-size: 18px; margin-right: 8px;"></i>' +
                jsonData.name +
                " &nbsp;|&nbsp; " +
                jsonData.inpatient_no +
                " &nbsp;|&nbsp; " +
                jsonData.sex_name +
                " &nbsp;|&nbsp; " +
                jsonData.ages +
                " &nbsp;|&nbsp; " +
                jsonData.bed_no +
                "床"
            );

            $("input[name='pname']").val(jsonData.name);
            $("input[name='admiss_times']").val(jsonData.admiss_times);
            $("input[name='admiss_date']").val(jsonData.admiss_date_text2);
            $("input[name='admiss_days']").val(jsonData.admiss_days);
            $("input[name='sex_name']").val(jsonData.sex_name);
            $("input[name='ages']").val(jsonData.ages);
            $("input[name='inpatient_no']").val(jsonData.inpatient_no);
            $("input[name='bed_no']").val(jsonData.bed_no);
            $("input[name='refer_physician_name']").val(
              jsonData.refer_physician_name
            );
            $("input[name='refer_nurse_name']").val(jsonData.refer_nurse_name);
            $("input[name='admiss_diag']").val(jsonData.admiss_diag);
            $("input[name='admiss_diag_name']").val(jsonData.admiss_diag_name);
            $("input[name='nursing']").val(jsonData.nursing);
            $("input[name='responce_type_name']").val(
              jsonData.responce_type_name
            );

            var _twdurl =
              appconfig.twd_webpage +
              "/?patient_id=" +
              jsonData.patient_id +
              "&admiss_times=" +
              jsonData.admiss_times +
              "&api_host=" +
              appconfig.api +
              "/";
            //var _dzblurl = appconfig.twd_webpage + "/test.pdf";
            var _dzblurl = "/lib/pdfjs/test1.pdf";
            //体温单点击
            $("button[name='tiwendan']")
              .off("click")
              .on("click", function () {
                var userData = localStorage.getItem("userData");
                if (!userData) {
                  layer.msg("请先选择患者！");
                  return;
                }
                var jsonData = JSON.parse(userData);
                var _twdurl =
                  appconfig.twd_webpage +
                  "/?patient_id=" +
                  jsonData.patient_id +
                  "&admiss_times=" +
                  jsonData.admiss_times +
                  "&api_host=" +
                  appconfig.api +
                  "/";
                var now = new Date();
                var ticks = now.getTime();
                window.parent.layui.layer.open({
                  type: 2,
                  area: ["100%", "100%"],
                  title:
                    "体温单" +
                    " - " +
                    jsonData.name +
                    " - " +
                    jsonData.inpatient_no +
                    " - " +
                    jsonData.sex_name +
                    " - " +
                    jsonData.ages,
                  closeBtn: 1,
                  shadeClose: true,
                  content: _twdurl + "&ticks=" + ticks,
                });
              });
            //电子病历点击
            //            $("button[name='dianzibingli']").click(function(){
            //            const now = new Date();
            //            const ticks = now.getTime();
            //    //_dzblurl = _dzblurl+"?ticks="+ticks
            //    //alert(_dzblurl);
            //            //console.log(ticks);
            //                window.parent.layui.layer.open({
            //                    type: 1,
            //                    area: ['100%', '100%'],
            //                    title: "电子病历" + " - " +jsonData.name + " - " +jsonData.inpatient_no + " - " +jsonData.sex_name+ " - " +jsonData.ages,
            //                    closeBtn: 1,
            //                    shadeClose: true, // 点击遮罩关闭层
            //                    content:  "<iframe src='../../lib/pdf6/web/viewer.html?file=" +
            //                    //content:  "<iframe src='../../lib/pdf5/pdf.html?file=" +
            //            _dzblurl +
            //            "' style='width:100%;height:100%'></iframe>"//+"?ticks="+ticks //这里content是一个URL，如果你不想让iframe出现滚动条，你还可以content: ['http://sentsin.com', 'no']
            //                });
            //            });

            $(".layuimini-container").show();
          }

          // 替换底部选项卡切换事件为按钮栏
          $("#tab-btn-bar").on("click", ".tab-btn", function () {
            var index = $(this).data("index");
            // 判断点击前是否已激活
            var isCurrent =
              $(this).hasClass("layui-this") || $(this).hasClass("active");
            // 切换按钮样式
            $("#tab-btn-bar .tab-btn").removeClass("layui-this active");
            $(this).addClass("layui-this active");
            // 切换内容显示
            $(".tab-content-area .layui-tab-item").removeClass("layui-show");
            var jsonData = JSON.parse(localStorage.getItem("userData"));
            var patientParams =
              "?patient_id=" +
              jsonData.patient_id +
              "&admiss_times=" +
              jsonData.admiss_times +
              "&ticks=" +
              new Date().getTime();
            switch (index) {
              case 0: // 患者信息
                $("#tab-patient").addClass("layui-show");
                if (isCurrent) {
                  // 对于患者信息选项卡，刷新表单数据而不是重新加载页面
                  var userData = localStorage.getItem("userData");
                  if (userData) {
                    var currentData = JSON.parse(userData);
                    // 重新填充表单数据
                    $("input[name='pname']").val(currentData.name);
                    $("input[name='admiss_times']").val(
                      currentData.admiss_times
                    );
                    $("input[name='admiss_date']").val(
                      currentData.admiss_date_text2
                    );
                    $("input[name='admiss_days']").val(currentData.admiss_days);
                    $("input[name='sex_name']").val(currentData.sex_name);
                    $("input[name='ages']").val(currentData.ages);
                    $("input[name='inpatient_no']").val(
                      currentData.inpatient_no
                    );
                    $("input[name='bed_no']").val(currentData.bed_no);
                    $("input[name='refer_physician_name']").val(
                      currentData.refer_physician_name
                    );
                    $("input[name='refer_nurse_name']").val(
                      currentData.refer_nurse_name
                    );
                    $("input[name='admiss_diag']").val(currentData.admiss_diag);
                    $("input[name='admiss_diag_name']").val(
                      currentData.admiss_diag_name
                    );
                    $("input[name='nursing']").val(currentData.nursing);
                    $("input[name='responce_type_name']").val(
                      currentData.responce_type_name
                    );
                  }
                }
                break;
              case 1: // 医嘱
                $("#tab-yizhu").addClass("layui-show");
                // 总是重新加载iframe，确保显示最新数据
                $("#yizhu-content").html(
                  '<iframe src="yizhu.html' + patientParams + '"></iframe>'
                );
                break;
              case 2: // 检验
                $("#tab-jianyan").addClass("layui-show");
                // 总是重新加载iframe，确保显示最新数据
                $("#jianyan-content").html(
                  '<iframe src="jy_apply.html' + patientParams + '"></iframe>'
                );
                break;
              case 3: // 检查
                $("#tab-jiancha").addClass("layui-show");
                // 总是重新加载iframe，确保显示最新数据
                $("#jiancha-content").html(
                  '<iframe src="jc_apply.html' + patientParams + '"></iframe>'
                );
                break;
              case 4: // 电子病历
                $("#tab-dianzibingli").addClass("layui-show");
                // 总是重新加载iframe，确保显示最新数据
                $("#dianzibingli-content").html(
                  '<iframe src="edoclist.html' + patientParams + '"></iframe>'
                );
                break;
              case 8: // 体温单
                // 体温单弹窗逻辑
                var userData = localStorage.getItem("userData");
                if (!userData) {
                  layer.msg("请先选择患者！");
                  break;
                }
                var jsonData = JSON.parse(userData);
                var _twdurl =
                  appconfig.twd_webpage +
                  "/?patient_id=" +
                  jsonData.patient_id +
                  "&admiss_times=" +
                  jsonData.admiss_times +
                  "&api_host=" +
                  appconfig.api +
                  "/";
                var now = new Date();
                var ticks = now.getTime();
                window.parent.layui.layer.open({
                  type: 2,
                  area: ["100%", "100%"],
                  title:
                    "体温单" +
                    " - " +
                    jsonData.name +
                    " - " +
                    jsonData.inpatient_no +
                    " - " +
                    jsonData.sex_name +
                    " - " +
                    jsonData.ages,
                  closeBtn: 1,
                  shadeClose: true,
                  content: _twdurl + "&ticks=" + ticks,
                });
                break;
              case 9: // 手术信息
                if ($("#tab-opinfo").length === 0) {
                  $(".layui-tab-content").append(
                    '<div class="layui-tab-item" id="tab-opinfo"><div id="opinfo-content" class="tab-iframe-container"></div></div>'
                  );
                }
                $("#tab-opinfo").addClass("layui-show");
                // 总是重新加载iframe，确保显示最新数据
                $("#opinfo-content").html(
                  '<iframe src="oplist.html' + patientParams + '"></iframe>'
                );
                break;
              // 其他case可按需补充
            }
          });

          // 切换患者功能
          $("#btn-switch-patient").on("click", function () {
            var $btn = $(this);
            var $list = $("#patient-switch-list");
            var $body = $("body");

            if ($list.hasClass("show")) {
              // 隐藏列表
              $list.removeClass("show");
              $btn.removeClass("active");
              $body.removeClass("patient-list-open");
            } else {
              // 显示列表并加载数据
              $list.addClass("show");
              $btn.addClass("active");
              $body.addClass("patient-list-open");
              loadPatientList();
            }
          });

          // 关闭病人列表
          $("#close-patient-list").on("click", function () {
            $("#patient-switch-list").removeClass("show");
            $("#btn-switch-patient").removeClass("active");
            $("body").removeClass("patient-list-open");
          });

          // 加载病人列表
          function loadPatientList() {
            var wardSn = localStorage.getItem("ward_sn");
            if (!wardSn) {
              layer.msg("未找到病区信息，请重新登录");
              return;
            }

            table.render({
              elem: "#switch-patient-table",
              url:
                appconfig.api +
                "/api/MobileWard/GetActPatientLists?ward=" +
                wardSn +
                "&inout=I",
              response: {
                statusCode: 1,
              },
              parseData: function (res) {
                return {
                  code: res.status,
                  msg: res.message,
                  count: res.total,
                  data: res.data,
                };
              },
              cellMinWidth: 60,
              size: "sm",
              cols: [
                [
                  { field: "bed_no", title: "床号", width: 60 },
                  { field: "name", title: "姓名", width: 80 },
                  { field: "sex_name", title: "性别", width: 50 },
                  { field: "ages", title: "年龄", width: 60 },
                  { field: "admiss_days", title: "住院天数", width: 80 },
                ],
              ],
              done: function (res, curr, count) {
                // 高亮当前患者
                var currentPatient = JSON.parse(
                  localStorage.getItem("userData")
                );
                if (currentPatient) {
                  var trs = document.querySelectorAll(
                    "#switch-patient-table+div .layui-table-body table tbody tr"
                  );
                  res.data.forEach(function (row, i) {
                    var tr = trs[i];
                    if (tr && row.patient_id === currentPatient.patient_id) {
                      tr.classList.add("selected");
                    }
                  });
                }
              },
            });

            // 监听行点击事件
            table.on("row(switch-patient-table)", function (obj) {
              var data = obj.data;
              var currentPatient = JSON.parse(localStorage.getItem("userData"));

              // 检查是否点击的是当前患者
              if (data.patient_id === currentPatient.patient_id) {
                // 如果是当前患者，仅关闭列表
                $("#patient-switch-list").removeClass("show");
                $("#btn-switch-patient").removeClass("active");
                $("body").removeClass("patient-list-open");
                return;
              }

              // 立即高亮选中行
              var $trs = $(
                "#switch-patient-table+div .layui-table-body table tbody tr"
              );
              $trs.removeClass("selected");
              $trs.eq(obj.tr.data("index")).addClass("selected");

              // 显示切换中的加载提示
              var loadingIndex = layer.load(1, {
                shade: [0.3, "#000"],
                content:
                  '<div style="text-align:center; padding:20px;">正在切换患者...</div>',
                success: function (layero) {
                  layero.find(".layui-layer-content").css({
                    "padding-top": "40px",
                    width: "200px",
                  });
                },
              });

              // 保存新的患者数据
              localStorage.setItem("userData", JSON.stringify(data));
              // 动态更新患者信息而不刷新页面
              switchPatientDynamic(data, loadingIndex);
            });
          }

          // 动态切换患者函数
          function switchPatientDynamic(newPatientData, loadingIndex) {
            try {
              // 1. 更新顶部患者信息显示
              $("#patient-header-info").html(
                '<i class="layui-icon layui-icon-username" style="font-size: 18px; margin-right: 8px;"></i>' +
                  newPatientData.name +
                  " &nbsp;|&nbsp; " +
                  newPatientData.inpatient_no +
                  " &nbsp;|&nbsp; " +
                  newPatientData.sex_name +
                  " &nbsp;|&nbsp; " +
                  newPatientData.ages +
                  " &nbsp;|&nbsp; " +
                  newPatientData.bed_no +
                  "床"
              );

              // 2. 更新患者信息表单
              $("input[name='pname']").val(newPatientData.name);
              $("input[name='admiss_times']").val(newPatientData.admiss_times);
              $("input[name='admiss_date']").val(
                newPatientData.admiss_date_text2
              );
              $("input[name='admiss_days']").val(newPatientData.admiss_days);
              $("input[name='sex_name']").val(newPatientData.sex_name);
              $("input[name='ages']").val(newPatientData.ages);
              $("input[name='inpatient_no']").val(newPatientData.inpatient_no);
              $("input[name='bed_no']").val(newPatientData.bed_no);
              $("input[name='refer_physician_name']").val(
                newPatientData.refer_physician_name
              );
              $("input[name='refer_nurse_name']").val(
                newPatientData.refer_nurse_name
              );
              $("input[name='admiss_diag']").val(newPatientData.admiss_diag);
              $("input[name='admiss_diag_name']").val(
                newPatientData.admiss_diag_name
              );
              $("input[name='nursing']").val(newPatientData.nursing);
              $("input[name='responce_type_name']").val(
                newPatientData.responce_type_name
              );

              // 3. 清空所有iframe内容，重置为加载状态
              var iframeContainers = [
                { id: "#yizhu-content", text: "正在加载医嘱信息..." },
                { id: "#jianyan-content", text: "正在加载检验信息..." },
                { id: "#jiancha-content", text: "正在加载检查信息..." },
                {
                  id: "#dianzibingli-content",
                  text: "正在加载电子病历信息...",
                },
                { id: "#opinfo-content", text: "正在加载手术信息..." },
              ];

              iframeContainers.forEach(function (container) {
                if ($(container.id).length > 0) {
                  $(container.id).html(
                    '<div class="loading-container">' +
                      '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"></i>' +
                      '<div class="loading-text">' +
                      container.text +
                      "</div>" +
                      "</div>"
                  );
                }
              });

              // 4. 如果当前显示的是非患者信息选项卡，重新加载该选项卡的内容
              var activeTabBtn = $(
                "#tab-btn-bar .tab-btn.layui-this, #tab-btn-bar .tab-btn.active"
              );
              var activeIndex = activeTabBtn.data("index");

              if (activeIndex !== 0) {
                // 延迟一点时间再重新加载iframe，确保DOM更新完成
                setTimeout(function () {
                  // 触发当前激活选项卡的重新加载
                  activeTabBtn.trigger("click");
                }, 100);
              }

              // 5. 显示切换成功提示并关闭加载
              setTimeout(function () {
                layer.close(loadingIndex);
                layer.msg("患者切换成功", { icon: 1, time: 1500 });
              }, 800);
            } catch (error) {
              console.error("切换患者时出错:", error);
              layer.close(loadingIndex);
              layer.msg("切换患者失败，请重试", { icon: 2, time: 2000 });
            }
          }
        }
      );
    </script>
  </body>
</html>
