<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>患者信息</title>
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> -->
    <!-- <meta http-equiv="Access-Control-Allow-Origin" content="*"> -->
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <link
      rel="stylesheet"
      href="../lib/layui-v2.6.3/css/layui.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <link rel="stylesheet" href="../css/patient.css" media="all" />
    <style>
      .layui-btn:not(.layui-btn-lg):not(.layui-btn-sm):not(.layui-btn-xs) {
        height: 34px;
        line-height: 34px;
        padding: 0 8px;
      }

      .layui-input {
        color: dodgerblue;
      }

      .layui-btn-radius {
        width: 80px;
      }

      body {
        background-color: transparent;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }
      .layui-elem-quote {
        height: 40px;
        min-height: 5%;
        padding: 5px 15px;
        margin: 0;
        font-weight: bold;
        font-size: 1.1rem;
        border: none;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .layui-layer-setwin a {
        height: 26px;
        transform: scale(1.5);
      }

      /* 页面布局样式 */
      .main-content {
        height: 100vh;
        display: flex;
        flex-direction: column;
        /* 为底部栏留出空间，避免内容被遮挡 */
        /* padding-bottom: 60px; */
      }

      .layuimini-container {
        padding: 0;
        margin: 0;
        border: none;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .layuimini-main {
        padding: 0;
        margin: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      /* 底部选项卡样式 */
      .bottom-tabs,
      .bottom-tab-placeholder {
        min-height: 5%;
        /* position: fixed; */
        left: 0;
        right: 0;
        bottom: 0;
        background: #fff;
        border-top: 2px solid #e6e6e6;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        /* height: 60px; */
        margin: 0;
        padding: 0;
      }
      .bottom-tab-placeholder {
        border: none;
        box-shadow: none;
        position: static;
        height: auto;
        min-height: 5%;
      }

      .bottom-tabs .layui-tab-title {
        margin: 0;
        background: #fff;
        border: none;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        height: 100%;
        align-items: center;
        overflow-x: visible;
        overflow-y: visible;
        white-space: normal;
        min-width: 0;
        width: 100%;
      }

      @media (max-width: 800px) {
        .bottom-tabs,
        .bottom-tab-placeholder {
          height: 48px;
        }
      }

      /* 选项卡内容区域 */
      .tab-content-area {
        flex: 1;
        overflow-y: auto;
        margin: 0;
        position: relative;
        background: #fff;
      }

      .layui-tab-content {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      .layui-tab-item {
        height: 100%;
        padding: 0;
        margin: 0;
      }

      /* iframe容器样式 */
      .tab-iframe-container {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      /* 确保iframe填满容器 */
      .tab-content-area iframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
      }

      /* 患者信息表单样式 */
      .layui-form {
        margin: 0;
        padding: 0px 0px;
        height: 100%;
        max-width: 800px;
        margin: 0 auto;
        text-align: center;
      }

      .layui-form-item {
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .option-bar {
        width: 100vw;
        overflow-x: auto;
        white-space: nowrap;
        background: #fff;
        padding: 0 0 0 8px;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.04);
        display: flex;
        gap: 12px;
        border-top: 2px solid #e6e6e6;
      }
      .tab-btn {
        min-width: 160px;
        max-width: 160px;
        height: 100%;
        background: #fff;
        border: none;
        border-radius: 6px 6px 0 0;
        font-size: 1.5rem;
        color: #333;
        margin: 0;
        cursor: pointer;
        transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        box-shadow: 0 1px 3px rgba(30, 159, 255, 0.04);
        outline: none;
        padding: 5px;
      }
      .option-bar {
        height: 100%;
      }
      .tab-btn.layui-this,
      .tab-btn.active {
        background: linear-gradient(135deg, #1e9fff 0%, #1890ff 100%);
        color: #fff;
        font-weight: bold;
        box-shadow: 0 -2px 8px rgba(30, 159, 255, 0.3);
      }
      .tab-btn:hover {
        background: #e8f4fd;
        color: #1e9fff;
      }
      .option-bar::-webkit-scrollbar {
        display: none;
      }
      .bottom-tab-placeholder {
        background: transparent;
        width: 100%;
        pointer-events: none;
        /* 移除固定高度，让它自动跟随 bottom-tabs */
      }
      #patient-header-info {
        margin: 0 auto;
        display: inline-block;
        text-align: center;
        max-width: 80vw;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* 患者列表样式优化 */
      #switch-patient-table + div .layui-table-body table tbody tr.selected {
        background-color: #e8f4fd !important;
        color: #1e9fff;
        font-weight: bold;
      }

      #switch-patient-table + div .layui-table-body table tbody tr:hover {
        background-color: #f5f5f5 !important;
        cursor: pointer;
      }
      /* 患者详情页专用样式 */

      /* 病人切换列表样式 */
      #patient-switch-list {
        display: none;
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: #fff;
        z-index: 999;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: width 0.3s ease;
      }

      #patient-switch-list.show {
        display: block;
        width: 30%;
        overflow-y: auto;
      }

      @media (max-width: 600px) {
        /* 窄屏时取消列表宽度限制，主内容也不再右移 */
        #patient-switch-list.show,
        #patient-switch-list {
          width: auto;
        }
        body.patient-list-open .layui-tab-content {
          margin-left: 0 !important;
        }
      }

      /* 当列表显示时，主内容区域向右偏移 */
      body.patient-list-open .layui-tab-content {
        margin-left: 30%;
        transition: margin-left 0.3s ease;
      }

      #patient-switch-list .list-header {
        padding: 12px 16px;
        font-weight: bold;
        font-size: 1.1rem;
        border-bottom: 1px solid #eee;
        background: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      #patient-switch-list .list-header .close-btn {
        cursor: pointer;
        font-size: 18px;
        color: #666;
        padding: 2px 8px;
        border-radius: 3px;
      }

      #patient-switch-list .list-header .close-btn:hover {
        background: #e9ecef;
        color: #000;
      }

      /* 病人列表表格样式优化 */
      #patient-switch-list .layui-table {
        margin: 0;
      }

      #patient-switch-list .layui-table th,
      #patient-switch-list .layui-table td {
        padding: 8px 10px;
        font-size: 14px;
      }

      #patient-switch-list .layui-table tbody tr:hover {
        background: #f0f7ff !important;
        cursor: pointer;
      }

      #patient-switch-list .layui-table tbody tr.selected {
        background: #e3f2fd !important;
      }

      /* 按钮样式优化 */
      .btn-switch-patient {
        float: left;
        font-size: 14px;
        margin-right: 8px;
        font-weight: normal;
        transition: all 0.3s ease;
      }

      .btn-switch-patient.active {
        background: #ff5722 !important;
        border-color: #ff5722 !important;
      }

      .btn-back {
        float: right;
        font-size: 14px;
        margin-right: 20px;
        font-weight: normal;
      }

      /* 加载状态样式 */
      .loading-container {
        text-align: center;
        padding: 40px;
        color: #999;
      }

      .loading-icon {
        font-size: 40px;
      }

      .loading-text {
        margin-top: 20px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="layuimini-container">
      <div class="layuimini-main main-content">
        <blockquote class="layui-elem-quote">
          <button
            type="button"
            class="layui-btn layui-btn-sm layui-btn-warm btn-switch-patient"
            id="btn-switch-patient"
            style="height: 80%"
          >
            <i class="layui-icon layui-icon-form"></i>切换患者
          </button>

          <span id="patient-header-info">患者详细信息</span>
          <button
            type="button"
            style="height: 80%"
            class="layui-btn layui-btn-sm layui-btn-normal btn-back"
            onclick="javascrript:window.history.back()"
          >
            <i
              class="layui-icon layui-icon-return"
              style="font-size: 18px; margin-right: 6px"
            ></i
            >返回
          </button>
          <!--<button class="layui-btn layui-btn-sm" onclick="javascrript:location.reload()" style="float: right;">刷新</button>-->
          <!--<button class="layui-btn layui-btn-normal" id="btn-fold">全部折叠</button>
                <button type="button" class="layui-btn layui-btn-primary" id="test-page-title">剔除默认标题栏</button>-->
          <br />
        </blockquote>

        <!-- 选项卡内容显示区域 -->

        <div class="tab-content-area">
          <div id="patient-switch-list">
            <div class="list-header">
              <span>病人列表</span>
              <span class="close-btn" id="close-patient-list">✕</span>
            </div>
            <table
              class="layui-table"
              id="switch-patient-table"
              lay-filter="switch-patient-table"
            ></table>
            <table
              class="layui-table"
              id="switch-patient-table-simple"
              lay-filter="switch-patient-table-simple"
            ></table>
          </div>
          <div class="layui-tab-content">
            <!-- 患者信息选项卡 -->
            <div class="layui-tab-item layui-show" id="tab-patient">
              <form
                class="layui-form layui-form-pane"
                action=""
                id="patient-info-form"
              >
                <!-- 动态生成的表单项将插入这里 -->
              </form>
            </div>
            <!-- 医嘱选项卡 -->
            <div class="layui-tab-item" id="tab-yizhu">
              <div id="yizhu-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载医嘱信息...</div>
                </div>
              </div>
            </div>
            <!-- 检验选项卡 -->
            <div class="layui-tab-item" id="tab-jianyan">
              <div id="jianyan-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载检验信息...</div>
                </div>
              </div>
            </div>
            <!-- 检查选项卡 -->
            <div class="layui-tab-item" id="tab-jiancha">
              <div id="jiancha-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载检查信息...</div>
                </div>
              </div>
            </div>
            <!-- 电子病历选项卡 -->
            <div class="layui-tab-item" id="tab-dianzibingli">
              <div id="dianzibingli-content" class="tab-iframe-container">
                <div class="loading-container">
                  <i
                    class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"
                  ></i>
                  <div class="loading-text">正在加载电子病历信息...</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 底部选项卡 -->
        <div class="bottom-tabs">
          <div class="option-bar" id="tab-btn-bar">
            <!-- 动态生成的选项卡按钮将插入这里 -->
          </div>
        </div>
      </div>
      <!-- <div class="bottom-tab-placeholder"></div> -->
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      layui.use(
        ["table", "treetable", "appconfig", "element", "layer"],
        function () {
          var $ = layui.jquery;
          var table = layui.table;
          var treetable = layui.treetable;
          var appconfig = layui.appconfig;
          var element = layui.element;
          var layer = layui.layer;
          var userData = localStorage.getItem("userData");

          // 患者列表缓存变量
          var patientListData = null;
          var patientListLoaded = false;

          // 患者信息字段配置 - 用于动态生成表单
          var patientFields = [
            [
              { label: "患者姓名", name: "pname", dataKey: "name" },
              { label: "次数", name: "admiss_times", dataKey: "admiss_times" },
            ],
            [
              {
                label: "入院日期",
                name: "admiss_date",
                dataKey: "admiss_date_text2",
              },
              {
                label: "入院天数",
                name: "admiss_days",
                dataKey: "admiss_days",
              },
            ],
            [
              { label: "性别", name: "sex_name", dataKey: "sex_name" },
              { label: "年龄", name: "ages", dataKey: "ages" },
            ],
            [
              {
                label: "住院号",
                name: "inpatient_no",
                dataKey: "inpatient_no",
              },
              { label: "床号", name: "bed_no", dataKey: "bed_no" },
            ],
            [
              {
                label: "管床医生",
                name: "refer_physician_name",
                dataKey: "refer_physician_name",
              },
              {
                label: "管床护士",
                name: "refer_nurse_name",
                dataKey: "refer_nurse_name",
              },
            ],
            [
              {
                label: "诊断代码",
                name: "admiss_diag",
                dataKey: "admiss_diag",
              },
              {
                label: "诊断名称",
                name: "admiss_diag_name",
                dataKey: "admiss_diag_name",
              },
            ],
            [
              { label: "护理级别", name: "nursing", dataKey: "nursing" },
              {
                label: "身份",
                name: "responce_type_name",
                dataKey: "responce_type_name",
              },
            ],
          ];

          // 选项卡配置 - 用于动态生成选项卡和处理逻辑
          var tabConfigs = [
            {
              index: 0,
              title: "患者信息",
              type: "form",
              tabId: "tab-patient",
              active: true,
            },
            {
              index: 1,
              title: "医嘱",
              type: "iframe",
              tabId: "tab-yizhu",
              contentId: "yizhu-content",
              src: "yizhu.html",
            },
            {
              index: 2,
              title: "检验",
              type: "iframe",
              tabId: "tab-jianyan",
              contentId: "jianyan-content",
              src: "jy_apply.html",
            },
            {
              index: 3,
              title: "检查",
              type: "iframe",
              tabId: "tab-jiancha",
              contentId: "jiancha-content",
              src: "jc_apply.html",
            },
            {
              index: 4,
              title: "电子病历",
              type: "iframe",
              tabId: "tab-dianzibingli",
              contentId: "dianzibingli-content",
              src: "edoclist.html",
            },
            {
              index: 5,
              title: "医生文书",
              type: "iframe",
              tabId: "tab-yishengwenshu",
              contentId: "yishengwenshu-content",
              src: "yswslist.html",
            },
            {
              index: 6,
              title: "护理文书",
              type: "iframe",
              tabId: "tab-huliwenshu",
              contentId: "huliwenshu-content",
              src: "hlwslist.html",
            },
            {
              index: 7,
              title: "护理记录",
              type: "iframe",
              tabId: "tab-hulijilu",
              contentId: "hulijilu-content",
              src: "hljllist.html",
            },
            {
              index: 8,
              title: "体温单",
              type: "popup",
              handler: function (jsonData) {
                var _twdurl =
                  appconfig.twd_webpage +
                  "/?patient_id=" +
                  jsonData.patient_id +
                  "&admiss_times=" +
                  jsonData.admiss_times +
                  "&api_host=" +
                  appconfig.api +
                  "/";
                var now = new Date();
                var ticks = now.getTime();
                window.parent.layui.layer.open({
                  type: 2,
                  area: ["100%", "100%"],
                  title:
                    "体温单 - " +
                    jsonData.name +
                    " - " +
                    jsonData.inpatient_no +
                    " - " +
                    jsonData.sex_name +
                    " - " +
                    jsonData.ages,
                  closeBtn: 1,
                  shadeClose: true,
                  content: _twdurl + "&ticks=" + ticks,
                });
              },
            },
            {
              index: 9,
              title: "手术信息",
              type: "iframe",
              tabId: "tab-opinfo",
              contentId: "opinfo-content",
              src: "oplist.html",
              dynamic: true, // 需要动态创建选项卡
            },
          ];

          // 动态生成选项卡按钮
          function generateTabButtons() {
            var buttonsHtml = "";
            tabConfigs.forEach(function (config) {
              var activeClass = config.active ? " layui-this" : "";
              buttonsHtml +=
                '<button class="tab-btn' +
                activeClass +
                '" data-index="' +
                config.index +
                '">' +
                config.title +
                "</button>";
            });
            $("#tab-btn-bar").html(buttonsHtml);
          }

          // 动态创建选项卡内容
          function createTabContent(config) {
            if (config.dynamic && $("#" + config.tabId).length === 0) {
              $(".layui-tab-content").append(
                '<div class="layui-tab-item" id="' +
                  config.tabId +
                  '">' +
                  '<div id="' +
                  config.contentId +
                  '" class="tab-iframe-container"></div>' +
                  "</div>"
              );
            }
          }

          // 加载iframe内容（支持缓存）
          function loadIframeContent(config, patientParams, forceReload) {
            // 检查是否已经加载过内容（缓存功能）
            var $content = $("#" + config.contentId);
            var existingIframe = $content.find("iframe");

            // 如果已有iframe且不强制重载，则不重新加载
            if (existingIframe.length > 0 && !forceReload) {
              return;
            }

            // 加载新的iframe内容
            $content.html(
              '<iframe src="' + config.src + patientParams + '"></iframe>'
            );
          }

          // 重置iframe为加载状态
          function resetIframeToLoading(config, loadingText) {
            if ($("#" + config.contentId).length > 0) {
              $("#" + config.contentId).html(
                '<div class="loading-container">' +
                  '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop loading-icon"></i>' +
                  '<div class="loading-text">' +
                  loadingText +
                  "</div>" +
                  "</div>"
              );
            }
          }

          // 动态生成患者信息表单
          function generatePatientForm() {
            var formHtml = "";
            patientFields.forEach(function (row) {
              formHtml += '<div class="layui-form-item">';
              row.forEach(function (field) {
                formHtml +=
                  '<label class="layui-form-label">' +
                  field.label +
                  "</label>" +
                  '<div class="layui-input-inline">' +
                  '<input type="text" name="' +
                  field.name +
                  '" autocomplete="off" ' +
                  'placeholder="" class="layui-input" readonly />' +
                  "</div>";
              });
              formHtml += "</div>";
            });
            $("#patient-info-form").html(formHtml);
          }

          // 填充患者信息数据
          function fillPatientData(jsonData) {
            patientFields.forEach(function (row) {
              row.forEach(function (field) {
                var value = jsonData[field.dataKey] || "";
                $("input[name='" + field.name + "']").val(value);
              });
            });
          }

          // 初始化表单和选项卡
          generatePatientForm();
          generateTabButtons();

          if (userData === null) {
            layer.msg("请先选择患者！");
            return;
          } else {
            var jsonData = JSON.parse(userData);
            $("#patient-header-info").html(
              '<i class="layui-icon layui-icon-username" style="font-size: 18px; margin-right: 8px;"></i>' +
                jsonData.name +
                " &nbsp;|&nbsp; " +
                jsonData.inpatient_no +
                " &nbsp;|&nbsp; " +
                jsonData.sex_name +
                " &nbsp;|&nbsp; " +
                jsonData.ages +
                " &nbsp;|&nbsp; " +
                jsonData.bed_no +
                "床"
            );

            // 使用新的填充数据方法
            fillPatientData(jsonData);

            var _twdurl =
              appconfig.twd_webpage +
              "/?patient_id=" +
              jsonData.patient_id +
              "&admiss_times=" +
              jsonData.admiss_times +
              "&api_host=" +
              appconfig.api +
              "/";
            //var _dzblurl = appconfig.twd_webpage + "/test.pdf";
            var _dzblurl = "/lib/pdfjs/test1.pdf";
            //体温单点击
            $("button[name='tiwendan']")
              .off("click")
              .on("click", function () {
                var userData = localStorage.getItem("userData");
                if (!userData) {
                  layer.msg("请先选择患者！");
                  return;
                }
                var jsonData = JSON.parse(userData);
                var _twdurl =
                  appconfig.twd_webpage +
                  "/?patient_id=" +
                  jsonData.patient_id +
                  "&admiss_times=" +
                  jsonData.admiss_times +
                  "&api_host=" +
                  appconfig.api +
                  "/";
                var now = new Date();
                var ticks = now.getTime();
                window.parent.layui.layer.open({
                  type: 2,
                  area: ["100%", "100%"],
                  title:
                    "体温单" +
                    " - " +
                    jsonData.name +
                    " - " +
                    jsonData.inpatient_no +
                    " - " +
                    jsonData.sex_name +
                    " - " +
                    jsonData.ages,
                  closeBtn: 1,
                  shadeClose: true,
                  content: _twdurl + "&ticks=" + ticks,
                });
              });

            $(".layuimini-container").show();

            // 不在页面初始化时加载患者列表，改为按需加载
            // loadPatientList();
          }

          // 优化后的选项卡切换事件
          $("#tab-btn-bar").on("click", ".tab-btn", function () {
            var index = parseInt($(this).data("index"));
            var config = tabConfigs.find(function (c) {
              return c.index === index;
            });

            if (!config) return;

            // 判断点击前是否已激活
            var isCurrent =
              $(this).hasClass("layui-this") || $(this).hasClass("active");

            // 切换按钮样式
            $("#tab-btn-bar .tab-btn").removeClass("layui-this active");
            $(this).addClass("layui-this active");

            // 切换内容显示
            $(".tab-content-area .layui-tab-item").removeClass("layui-show");

            var jsonData = JSON.parse(localStorage.getItem("userData"));
            var patientParams =
              "?patient_id=" +
              jsonData.patient_id +
              "&admiss_times=" +
              jsonData.admiss_times +
              "&ticks=" +
              new Date().getTime();

            // 根据配置类型处理不同逻辑
            switch (config.type) {
              case "form": // 患者信息表单
                $("#" + config.tabId).addClass("layui-show");
                if (isCurrent) {
                  var userData = localStorage.getItem("userData");
                  if (userData) {
                    var currentData = JSON.parse(userData);
                    fillPatientData(currentData);
                  }
                }
                break;

              case "iframe": // iframe页面
                // 动态创建选项卡（如果需要）
                if (config.dynamic) {
                  createTabContent(config);
                }
                $("#" + config.tabId).addClass("layui-show");
                // 首次加载或重复点击时才重新加载iframe
                if (isCurrent) {
                  // 重复点击当前选项卡，强制重新加载
                  loadIframeContent(config, patientParams, true);
                } else {
                  // 首次切换到此选项卡，检查缓存
                  loadIframeContent(config, patientParams, false);
                }
                break;

              case "popup": // 弹窗类型
                var userData = localStorage.getItem("userData");
                if (!userData) {
                  layer.msg("请先选择患者！");
                  return;
                }
                var jsonData = JSON.parse(userData);
                config.handler(jsonData);
                break;
            }
          });

          // 切换患者功能 - 只控制显示隐藏
          $("#btn-switch-patient").on("click", function () {
            var $btn = $(this);
            var $list = $("#patient-switch-list");
            var $body = $("body");

            if ($list.hasClass("show")) {
              // 隐藏列表
              $list.removeClass("show");
              $btn.removeClass("active");
              $body.removeClass("patient-list-open");
            } else {
              // 显示列表
              $list.addClass("show");
              $btn.addClass("active");
              $body.addClass("patient-list-open");

              // 每次显示时都检查是否需要加载
              if (!patientListLoaded) {
                loadPatientList();
              } else {
                // 如果已经加载过，直接更新高亮
                setTimeout(function () {
                  highlightCurrentPatient();
                }, 100);
              }
            }
          });

          // 关闭病人列表
          $("#close-patient-list").on("click", function () {
            $("#patient-switch-list").removeClass("show");
            $("#btn-switch-patient").removeClass("active");
            $("body").removeClass("patient-list-open");
          });

          // 加载病人列表（按需调用）
          function loadPatientList() {
            var wardSn = localStorage.getItem("ward_sn");
            if (!wardSn) {
              layer.msg("未找到病区信息，请重新登录");
              return;
            }

            // 不再显示加载动画和文字

            table.render({
              elem: "#switch-patient-table",
              url:
                appconfig.api +
                "/api/MobileWard/GetActPatientLists?ward=" +
                wardSn +
                "&inout=I",
              response: {
                statusCode: 1,
              },
              parseData: function (res) {
                console.log("患者列表API响应:", res);
                return {
                  code: res.status,
                  msg: res.message,
                  count: res.total,
                  data: res.data,
                };
              },
              cellMinWidth: 60,
              size: "sm",
              cols: [
                [
                  { field: "bed_no", title: "床号", width: 60 },
                  { field: "name", title: "姓名", width: 100 },
                  { field: "sex_name", title: "性别", width: 50 },
                  { field: "ages", title: "年龄", width: 60 },
                  // { field: "admiss_days", title: "住院天数", width: 80 },
                ],
              ],
              done: function (res, curr, count) {
                console.log("患者列表渲染完成:", res);

                // 根据实际API响应格式判断成功状态
                if (
                  (res.code === 0 || res.code === 1) &&
                  res.data &&
                  res.data.length > 0
                ) {
                  // 保存患者列表数据
                  patientListData = res.data;
                  patientListLoaded = true;

                  // 高亮当前患者
                  setTimeout(function () {
                    highlightCurrentPatient();
                  }, 300);

                  // 绑定行点击事件（只绑定一次）
                  bindPatientTableEvents();

                  layer.msg("患者列表加载成功", { icon: 1, time: 1000 });
                } else {
                  patientListLoaded = false;
                  var errorMsg = res.msg || res.message || "加载失败，没有数据";
                  layer.msg("患者列表: " + errorMsg, { icon: 2 });
                  console.error("患者列表数据问题:", res);
                }
              },
              error: function (xhr, status, error) {
                patientListLoaded = false;
                layer.msg("网络错误，无法加载患者列表", { icon: 2 });
                console.error("网络请求失败:", error);
              },
            });
          }

          // 高亮当前患者
          function highlightCurrentPatient() {
            if (!patientListData || !patientListLoaded) return;

            // 延迟执行，确保DOM已经渲染完成
            setTimeout(function () {
              var currentPatient = JSON.parse(localStorage.getItem("userData"));
              if (currentPatient) {
                var trs = document.querySelectorAll(
                  "#switch-patient-table+div .layui-table-body table tbody tr"
                );

                if (trs.length === 0) {
                  // 如果没有找到表格行，再次尝试查找
                  trs = document.querySelectorAll(
                    "#switch-patient-table .layui-table-body tbody tr"
                  );
                }

                patientListData.forEach(function (row, i) {
                  var tr = trs[i];
                  if (tr && row.patient_id === currentPatient.patient_id) {
                    tr.classList.add("selected");
                  } else if (tr) {
                    tr.classList.remove("selected");
                  }
                });
              }
            }, 200);
          }

          // 绑定患者表格事件（避免重复绑定）
          var patientTableEventsBound = false;
          function bindPatientTableEvents() {
            if (patientTableEventsBound) return;
            patientTableEventsBound = true;

            // 监听行点击事件
            table.on("row(switch-patient-table)", function (obj) {
              var data = obj.data;
              var currentPatient = JSON.parse(localStorage.getItem("userData"));

              // 检查是否点击的是当前患者
              if (data.patient_id === currentPatient.patient_id) {
                // 如果是当前患者，仅关闭列表
                $("#patient-switch-list").removeClass("show");
                $("#btn-switch-patient").removeClass("active");
                $("body").removeClass("patient-list-open");
                return;
              }

              // 立即高亮选中行
              var $trs = $(
                "#switch-patient-table+div .layui-table-body table tbody tr"
              );
              $trs.removeClass("selected");
              $trs.eq(obj.tr.data("index")).addClass("selected");

              // 显示切换中的加载提示
              var loadingIndex = layer.load(1, {
                shade: [0.3, "#000"],
                content:
                  '<div style="text-align:center; padding:20px;">正在切换患者...</div>',
                success: function (layero) {
                  layero.find(".layui-layer-content").css({
                    "padding-top": "40px",
                    width: "200px",
                  });
                },
              });

              // 保存新的患者数据
              localStorage.setItem("userData", JSON.stringify(data));
              // 动态更新患者信息而不刷新页面
              switchPatientDynamic(data, loadingIndex);
            });
          }

          // 动态切换患者函数
          function switchPatientDynamic(newPatientData, loadingIndex) {
            try {
              // 1. 更新顶部患者信息显示
              $("#patient-header-info").html(
                '<i class="layui-icon layui-icon-username" style="font-size: 18px; margin-right: 8px;"></i>' +
                  newPatientData.name +
                  " &nbsp;|&nbsp; " +
                  newPatientData.inpatient_no +
                  " &nbsp;|&nbsp; " +
                  newPatientData.sex_name +
                  " &nbsp;|&nbsp; " +
                  newPatientData.ages +
                  " &nbsp;|&nbsp; " +
                  newPatientData.bed_no +
                  "床"
              );

              // 2. 更新患者信息表单
              fillPatientData(newPatientData);

              // 2.5. 更新患者列表中的高亮（如果列表已加载）
              if (patientListLoaded) {
                highlightCurrentPatient();
              }

              // 3. 清空所有iframe内容，重置为加载状态
              tabConfigs.forEach(function (config) {
                if (config.type === "iframe") {
                  var loadingText = "正在加载" + config.title + "信息...";
                  resetIframeToLoading(config, loadingText);
                }
              });

              // 4. 如果当前显示的是非患者信息选项卡，重新加载该选项卡的内容
              var activeTabBtn = $(
                "#tab-btn-bar .tab-btn.layui-this, #tab-btn-bar .tab-btn.active"
              );
              var activeIndex = activeTabBtn.data("index");

              if (activeIndex !== 0) {
                // 延迟一点时间再重新加载iframe，确保DOM更新完成
                setTimeout(function () {
                  // 找到当前激活的选项卡配置
                  var activeConfig = tabConfigs.find(function (c) {
                    return c.index === activeIndex;
                  });
                  if (activeConfig && activeConfig.type === "iframe") {
                    // 切换患者时强制重新加载当前选项卡
                    var patientParams =
                      "?patient_id=" +
                      newPatientData.patient_id +
                      "&admiss_times=" +
                      newPatientData.admiss_times +
                      "&ticks=" +
                      new Date().getTime();
                    loadIframeContent(activeConfig, patientParams, true);
                  }
                }, 100);
              }

              // 5. 显示切换成功提示并关闭加载
              setTimeout(function () {
                layer.close(loadingIndex);
                layer.msg("患者切换成功", { icon: 1, time: 1500 });
              }, 800);
            } catch (error) {
              console.error("切换患者时出错:", error);
              layer.close(loadingIndex);
              layer.msg("切换患者失败，请重试", { icon: 2, time: 2000 });
            }
          }
        }
      );
    </script>
  </body>
</html>
