<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>检验申请</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="/lib/layui-v2.6.3/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/css/table/iframe.css" media="all" />
    <!-- <style>
      html,
      body {
        height: 100%;
        min-height: 100%;
      }

      body {
        background-color: transparent;
        padding: 0;
        margin: 0;
        font-size: 14px;
        height: calc(100vh - 180px);
        overflow: hidden;
      }

      /* Pad端优化样式 */
      .layui-table-cell {
        height: auto;
        white-space: normal;
        padding: 12px 8px;
        font-size: 14px;
        line-height: 1.4;
      }

      /* 容器全宽设置 */
      .layui-container {
        width: 100%;
        max-width: 100%;
        padding: 5px;
        margin: 0;
        height: 100%;
      }

      .layui-row,
      .layui-col-md12 {
        height: 100% !important;
        min-height: 100%;
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }

      /* 状态颜色 */
      .status-pending {
        color: #ff5722;
        font-weight: bold;
      }
      .status-completed {
        color: #009688;
        font-weight: bold;
      }
      .status-cancelled {
        color: #999;
      }

      /* 工具栏按钮优化 */
      .layui-btn-container .layui-btn {
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
        font-size: 13px;
        margin: 0 2px;
      }

      /* 表格头部优化 */
      .layui-table th {
        font-size: 14px;
        font-weight: bold;
        background-color: #f8f9fa;
      }

      /* 患者信息栏优化 */
      .layui-elem-quote {
        padding: 15px;
        font-size: 16px;
        margin-bottom: 0;
        border-radius: 0;
        background-color: #1e9fff;
        color: #fff;
      }

      #patient-info {
        font-size: 14px !important;
        color: #666 !important;
      }

      /* 套餐选择弹窗优化 */
      .package-form .layui-form-label {
        width: 100px;
        font-size: 16px;
        padding: 15px;
      }

      .package-form .layui-input-block {
        margin-left: 100px;
      }

      .package-form .layui-input,
      .package-form .layui-select {
        height: 50px;
        line-height: 50px;
        font-size: 16px;
        border-radius: 8px;
      }

      .package-form .layui-btn {
        height: 50px;
        line-height: 50px;
        padding: 0 30px;
        font-size: 18px;
        border-radius: 8px;
        margin: 0 10px;
      }

      /* 套餐选择器样式 */
      .package-selector {
        display: flex;
        height: 420px;
        border: 1px solid #e6e6e6;
        border-radius: 8px;
        overflow: hidden;
      }

      .package-left {
        width: 35%;
        border-right: 1px solid #e6e6e6;
        background: #f8f9fa;
      }

      .package-right {
        width: 65%;
        background: #fff;
      }

      .package-list {
        height: 100%;
        overflow-y: auto;
        padding: 10px;
      }

      .package-item {
        padding: 12px 15px;
        margin-bottom: 5px;
        border: 1px solid #e6e6e6;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fff;
      }

      .package-item:hover {
        border-color: #1e9fff;
        background-color: #f8fcff;
      }

      .package-item.selected {
        border-color: #1e9fff;
        background-color: #e8f4fd;
        color: #1e9fff;
      }

      .package-title {
        font-size: 15px;
        font-weight: bold;
        color: #333;
        margin-bottom: 3px;
      }

      .package-desc {
        font-size: 12px;
        color: #666;
        line-height: 1.3;
      }

      .package-item.selected .package-title {
        color: #1e9fff;
      }

      /* 项目列表样式 */
      .items-container {
        height: 100%;
        overflow-y: auto;
        padding: 15px;
      }

      .items-header {
        font-size: 16px;
        font-weight: bold;
        color: #333;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #1e9fff;
      }

      .items-list {
        max-height: 320px;
        overflow-y: auto;
      }

      /* 弹窗按钮区域固定在底部 */
      .dialog-buttons {
        background: #fff;
        padding: 15px 20px;
        border-top: 1px solid #e6e6e6;
        text-align: center;
        margin-top: 20px;
      }

      /* 弹窗整体布局 */
      .package-form {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .package-content {
        flex: 1;
        overflow: hidden;
        padding: 20px;
        padding-bottom: 0;
      }

      .item-checkbox {
        display: flex;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
      }

      .item-checkbox:hover {
        background-color: #f8fcff;
      }

      .item-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        margin-right: 10px;
        cursor: pointer;
      }

      .item-name {
        font-size: 14px;
        color: #333;
        flex: 1;
      }

      .no-package-selected {
        text-align: center;
        padding: 100px 20px;
        color: #999;
        font-size: 14px;
      }

      /* 响应式优化 */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .layui-btn-container .layui-btn {
          width: 100%;
          margin-right: 0;
        }
      }

      /* 滚动条优化 */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      #jianyan-table {
        height: 100% !important;
        min-height: 0;
      }

      .layui-table-view {
        height: 100% !important;
        min-height: 0;
        max-height: 100%;
      }

      .layui-table-box,
      .layui-table-body {
        height: 100% !important;
        min-height: 0;
        max-height: 100%;
      }

      .layui-table-tool {
        padding: 5px;
      }

      .layui-btn-container {
        padding: 4px 0;
      }

      .layui-btn i {
        font-size: 13px;
      }

      .layui-table-tool-temp {
        padding-right: 0;
      }

      .layui-table-tool .layui-btn-container .layui-btn {
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
        font-size: 13px;
        margin: 0 2px;
      }

      .layui-table-tool .layui-btn-container .layui-btn i {
        font-size: 13px;
      }
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
    </style> -->
  </head>
  <body>
    <div class="layui-container">
      <div class="layui-row">
        <div class="layui-col-md12">
          <!-- <blockquote class="layui-elem-quote">
                    <i class="layui-icon layui-icon-template-1" style="font-size: 18px; margin-right: 8px;"></i>
                    检验申请信息
                </blockquote> -->

          <!-- 检验申请表格 -->
          <!-- <div class="table-title">检验表单</div> -->
          <table
            class="layui-hide"
            id="jianyan-table"
            lay-filter="jianyan-table"
          ></table>

          <!-- 工具栏模板 -->
          <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-warm" lay-event="newApply">
                <i class="layui-icon layui-icon-add-1"></i> 新建申请
              </button>
            </div>
          </script>
          <script type="text/html" id="rowBar">
            <button
              class="layui-btn layui-btn-danger layui-btn-xs"
              lay-event="delRow"
            >
              删除
            </button>
          </script>
          <!-- 状态模板 -->
          <script type="text/html" id="statusTpl">
            {{# if(d.status == '0'){ }} 申请 {{# } else if(d.status == '1'){ }}
            已登记 {{# } else { }} 未保存 {{# } }}
          </script>

          <!-- 日期格式化模板 -->
          <script type="text/html" id="dateTpl">
            {{# if(d.reg_date){ }} {{# var date = new Date(d.reg_date); var year
            = date.getFullYear(); var month = (date.getMonth() +
            1).toString().padStart(2, '0'); var day =
            date.getDate().toString().padStart(2, '0'); var hours =
            date.getHours().toString().padStart(2, '0'); var minutes =
            date.getMinutes().toString().padStart(2, '0'); var seconds =
            date.getSeconds().toString().padStart(2, '0'); }}
            {{year}}-{{month}}-{{day}} {{hours}}:{{minutes}}:{{seconds}} {{# }
            else { }} - {{# } }}
          </script>
        </div>
      </div>
    </div>

    <script src="/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      layui.use(["table", "appconfig", "layer", "form"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;
        var layer = layui.layer;
        var form = layui.form;

        // 获取URL参数
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");

        // 获取患者信息 (已在顶部显示，此处不再重复)

        // 套餐数据变量
        var testPackages = [];
        var allTestItems = []; // 所有检验项目数据

        // 渲染表格
        table.render({
          elem: "#jianyan-table",
          url:
            appconfig.api +
            "/api/JcJy/GetJianYanApplys?patient_id=" +
            patient_id +
            "&admiss_times=" +
            admiss_times,
          toolbar: "#toolbarDemo",
          defaultToolbar: [],
          cols: [
            [
              {
                field: "jyapply_no",
                title: "申请单号",
                width: 120,
                sort: true,
              },
              {
                field: "status",
                title: "检验状态",
                width: 100,
                templet: "#statusTpl",
              },
              { field: "grp_name", title: "检验项目" },
              { field: "charge_amount", title: "数量", width: 100 },
              {
                field: "reg_date",
                title: "申请日期",
                width: 200,
                templet: "#dateTpl",
              },
              {
                // fixed: "right",
                title: "操作",
                width: 80,
                align: "center",
                toolbar: "#rowBar",
              },
            ],
          ],
          height: "full-10", // 填满父容器，减去极少量边距
          text: {
            none: '<div style="text-align: center; padding: 30px; color: #999; font-size: 16px;"><i class="layui-icon layui-icon-template-1" style="font-size: 48px; display: block; margin-bottom: 10px;"></i>暂无检验申请数据</div>',
          },
          parseData: function (res) {
            return {
              code: res.Status === 1 ? 0 : res.Status,
              msg: res.msg || "",
              count: res.Data ? res.Data.length : 0,
              data: res.Data || [],
            };
          },
        });
        // 删除逻辑
        table.on("tool(jianyan-table)", function (obj) {
          var data = obj.data;
          var layEvent = obj.event;
          if (layEvent === "delRow") {
            if (data.exam_status == 0) {
              layer.msg("该申请已登记，不能删除", { icon: 5 });
              return;
            }
            layer.confirm(
              "确定删除该申请吗？",
              { icon: 3, title: "提示" },
              function (index) {
                $.ajax({
                  url: appconfig.api + "/api/JcJy/DelJianYan",
                  type: "GET",
                  data: {
                    patient_id: data.patient_id,
                    admiss_times: data.admiss_times,
                    exam_no: data.jyapply_no,
                  },
                  dataType: "json",
                  success: function (res) {
                    if (res.status === 1) {
                      layer.msg("删除成功", { icon: 1 });
                      table.reload("jianyan-table");
                    } else {
                      layer.msg("删除失败: " + (res.msg || "未知错误"), {
                        icon: 5,
                      });
                    }
                  },
                  error: function () {
                    layer.msg("网络错误，删除失败", { icon: 5 });
                  },
                });
                layer.close(index);
              }
            );
          }
        });

        // 获取检验项目数据
        function loadTestItems(callback) {
          var wardData = localStorage.getItem("wardData");

          if (wardData === null) {
            layer.msg("请先选择病区！");
            location.href = "view/wardlist.html";
            return;
          }
          var jsonData = JSON.parse(wardData);
          localStorage.ward_sn = jsonData.ward_sn;

          $.ajax({
            url:
              appconfig.api +
              "/api/JcJy/GetJianYanList?ward_sn=" +
              (localStorage.ward_sn || ""),
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.Status === 1 && res.Data) {
                allTestItems = res.Data;
                callback(true);
              } else {
                layer.msg("获取检验项目数据失败: " + (res.Msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取检验项目数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取套餐数据
        function loadPackages(callback) {
          var loginUser = localStorage.getItem("loginUser");

          if (loginUser === null) {
            location.href = "index.html";
            return;
          }
          var loginUserData = JSON.parse(loginUser);
          $.ajax({
            url:
              "http://10.102.41.142:5105" +
              "/api/jcjy/GetCustomerTemplates?type=jianyan&opera=" +
              loginUserData.user_mi,
            type: "GET",
            dataType: "json",
            success: function (res) {
              console.log("获取套餐数据 - 响应:", res);
              if (res.status === 1 && res.data) {
                testPackages = res.data;
                callback(true);
              } else {
                layer.msg("获取套餐数据失败: " + (res.Msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取套餐数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取申请单编号
        function getApplySn(callback) {
          $.ajax({
            url: appconfig.api + "/api/JcJy/GetApplySn",
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.Status === 1 && res.Data) {
                callback(true, res.Data);
              } else {
                layer.msg("获取申请单编号失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false, null);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取申请单编号", { icon: 5 });
              callback(false, null);
            },
          });
        }

        // 提交检验申请
        function submitTestApply(selectedItems, callback) {
          console.log("提交检验申请 - selectedItems:", selectedItems);
          console.log("提交检验申请 - allTestItems长度:", allTestItems.length);

          var loginUser = localStorage.getItem("loginUser");
          var patientData = JSON.parse(
            localStorage.getItem("patientData") || "{}"
          );

          if (!loginUser) {
            layer.msg("登录信息已过期，请重新登录", { icon: 5 });
            callback(false);
            return;
          }

          var loginUserData = JSON.parse(loginUser);
          var todoList = [];
          var completedCount = 0;
          var totalCount = selectedItems.length;

          console.log("开始处理 selectedItems，总数:", totalCount);

          // 为每个选中的项目创建申请记录
          selectedItems.forEach(function (selectedItem) {
            console.log("处理 selectedItem:", selectedItem);

            // 从allTestItems中找到完整的项目信息
            var fullItem = allTestItems.find(function (item) {
              return (
                item.id == selectedItem.id ||
                item.code == selectedItem.id ||
                item.sub_code == selectedItem.id ||
                item.item_id == selectedItem.id
              );
            });

            console.log("找到的 fullItem:", fullItem);

            if (!fullItem) {
              console.log(
                "未找到对应的 fullItem，selectedItem.id:",
                selectedItem.id
              );
              console.log("allTestItems 样例数据:", allTestItems.slice(0, 3));
              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
              return;
            }

            // 获取申请单编号
            getApplySn(function (success, applyData) {
              console.log(
                "getApplySn 结果 - success:",
                success,
                "applyData:",
                applyData
              );

              if (success && applyData) {
                // 获取当前本地时间
                var now = new Date();
                var localDateTime =
                  now.getFullYear() +
                  "-" +
                  (now.getMonth() + 1).toString().padStart(2, "0") +
                  "-" +
                  now.getDate().toString().padStart(2, "0") +
                  " " +
                  now.getHours().toString().padStart(2, "0") +
                  ":" +
                  now.getMinutes().toString().padStart(2, "0") +
                  ":" +
                  now.getSeconds().toString().padStart(2, "0");

                var applyModel = {
                  jyapply_no:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  reg_date: localDateTime,
                  admiss_diag: patientData.admiss_diag || "",
                  admiss_times: admiss_times,
                  age: (patientData.age || "").replace("岁", ""),
                  bed_no: patientData.bed_no || "",
                  birth_date: patientData.birth_date
                    ? new Date(patientData.birth_date)
                        .toLocaleDateString("zh-CN")
                        .replace(/\//g, "-")
                    : "",
                  charge_amount: "1",
                  dept: patientData.dept || "",
                  doctor_code: loginUserData.user_mi,
                  erem_flag: "0", // 默认值，可能需要根据实际情况调整
                  exec_unit: fullItem.exec_unit || "",
                  grp_code: fullItem.code || "",
                  grp_name:
                    fullItem.sub_code_name ||
                    fullItem.name ||
                    fullItem.item_name,
                  inpatient_no: patientData.inpatient_no || "",
                  name: patientData.name || "",
                  patient_id: patient_id,
                  patient_type: "2", // 1:门诊，2：住院
                  purpose: patientData.admiss_diag_name || "",
                  samp_id:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  sample_type: fullItem.sample_type || "",
                  sample_type_name: fullItem.sample_type_name || "",
                  sex: patientData.sex || "",
                  status: "0",
                  add_new: true,
                  ward: patientData.ward || "",
                  status_name: "未保存",
                };

                console.log("创建的 applyModel:", applyModel);
                todoList.push(applyModel);
                console.log("添加到 todoList 后，长度:", todoList.length);
              } else {
                console.log("获取申请单编号失败");
              }

              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
            });
          });

          // 提交所有申请
          function submitAllApplies() {
            console.log("submitAllApplies - todoList长度:", todoList.length);
            console.log("submitAllApplies - todoList内容:", todoList);

            if (todoList.length === 0) {
              layer.msg("没有有效的申请数据", { icon: 5 });
              callback(false);
              return;
            }

            $.ajax({
              url: appconfig.api + "/api/JcJy/JianyanSubmit",
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify(todoList),
              dataType: "json",
              success: function (res) {
                if (res.Status === 1) {
                  callback(true);
                } else {
                  layer.msg("提交申请失败: " + (res.Msg || "未知错误"), {
                    icon: 5,
                  });
                  callback(false);
                }
              },
              error: function () {
                layer.msg("网络错误，申请提交失败", { icon: 5 });
                callback(false);
              },
            });
          }
        }

        // 头工具栏事件
        table.on("toolbar(jianyan-table)", function (obj) {
          switch (obj.event) {
            case "newApply":
              // 显示加载提示
              var loadingIndex = layer.msg("正在加载数据...", {
                icon: 16,
                shade: 0.3,
                time: 0,
              });

              // 先加载检验项目数据，再加载套餐数据
              loadTestItems(function (itemsSuccess) {
                if (!itemsSuccess) {
                  layer.close(loadingIndex);
                  return;
                }

                // 加载套餐数据
                loadPackages(function (packagesSuccess) {
                  layer.close(loadingIndex);

                  if (!packagesSuccess) {
                    return;
                  }

                  // 生成套餐选择HTML
                  var packageHtml = "";
                  testPackages.forEach(function (pkg) {
                    packageHtml +=
                      '<div class="package-item" data-id="' +
                      pkg.id +
                      '">' +
                      '<div class="package-title">' +
                      (pkg.name || "未命名套餐") +
                      "</div>" +
                      '<div class="package-desc">' +
                      (pkg.value || "无描述") +
                      "</div>" +
                      "</div>";
                  });

                  layer.open({
                    type: 1,
                    title:
                      '<i class="layui-icon layui-icon-add-1"></i> 选择检验项目',
                    area: ["85%", "380px"] /* 调整弹窗高度为380px */,
                    maxmin: true,
                    resize: false,
                    content:
                      '<div class="package-form">' +
                      '<div class="package-content">' +
                      '<div class="package-selector">' +
                      '<div class="package-left">' +
                      '<div style="padding: 8px; background: #1e9fff; color: #fff; font-weight: bold; text-align: center; font-size: 13px;">检验套餐</div>' +
                      '<div class="package-list">' +
                      packageHtml +
                      "</div>" +
                      "</div>" +
                      '<div class="package-right">' +
                      '<div class="items-container">' +
                      '<div class="no-package-selected">' +
                      '<i class="layui-icon layui-icon-file" style="font-size: 36px; display: block; margin-bottom: 8px;"></i>' +
                      "请先选择左侧的检验套餐" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      '<div class="dialog-buttons">' +
                      '<button class="layui-btn layui-btn-normal" id="confirm-items">' +
                      '<i class="layui-icon layui-icon-ok"></i> 确认申请' +
                      "</button>" +
                      '<button class="layui-btn layui-btn-primary" id="cancel-items">' +
                      '<i class="layui-icon layui-icon-close"></i> 取消' +
                      "</button>" +
                      "</div>" +
                      "</div>",
                    success: function (layero, index) {
                      var selectedPackage = null;
                      var selectedItems = [];

                      // 显示项目列表
                      function showItems(pkg) {
                        var pkgTitle = pkg.title || pkg.name || "未命名套餐";
                        var itemsHtml =
                          '<div class="items-header">' +
                          pkgTitle +
                          " - 检验项目</div>" +
                          '<div class="items-list">';

                        // 根据套餐的value值过滤项目
                        var packageItems = [];
                        if (pkg.value && allTestItems.length > 0) {
                          var valueIds = pkg.value.split(",");
                          valueIds.forEach(function (id) {
                            var trimmedId = id.trim();
                            var item = allTestItems.find(function (testItem) {
                              return (
                                testItem.id == trimmedId ||
                                testItem.code == trimmedId
                              );
                            });
                            if (item) {
                              packageItems.push(item);
                            }
                          });
                        }

                        if (packageItems.length > 0) {
                          packageItems.forEach(function (item) {
                            console.log("生成checkbox的item数据:", item);

                            // 尝试多个可能的id字段名
                            var itemId =
                              item.id ||
                              item.code ||
                              item.sub_code ||
                              item.item_id ||
                              "";
                            console.log("使用的itemId:", itemId);

                            itemsHtml +=
                              '<label class="item-checkbox">' +
                              '<input type="checkbox" value="' +
                              itemId +
                              '" data-name="' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              '" data-price="' +
                              (item.price || item.charge_amount || "0.00") +
                              '">' +
                              '<span class="item-name">' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              "</span>" +
                              "</label>";
                          });
                        } else {
                          itemsHtml +=
                            '<div style="text-align: center; padding: 50px; color: #999;">该套餐暂无项目数据</div>';
                        }

                        itemsHtml += "</div>";

                        $(layero).find(".items-container").html(itemsHtml);

                        // 监听项目选择
                        $(layero)
                          .find(".item-checkbox input")
                          .change(function () {
                            updateSelectedItems();
                          });
                      }

                      // 更新选中项目列表
                      function updateSelectedItems() {
                        selectedItems = [];
                        $(layero)
                          .find(".item-checkbox input:checked")
                          .each(function () {
                            selectedItems.push({
                              id: $(this).val(),
                              name: $(this).data("name"),
                              price: $(this).data("price"),
                            });
                          });
                      }

                      // 套餐选择事件
                      $(layero)
                        .find(".package-item")
                        .click(function () {
                          $(layero)
                            .find(".package-item")
                            .removeClass("selected");
                          $(this).addClass("selected");
                          selectedPackage = testPackages.find(
                            (pkg) => pkg.id == $(this).data("id")
                          );
                          selectedItems = []; // 切换套餐时清空已选项目
                          showItems(selectedPackage);
                        });

                      // 确认申请
                      $(layero)
                        .find("#confirm-items")
                        .click(function () {
                          if (!selectedPackage) {
                            layer.msg("请先选择一个检验套餐", { icon: 5 });
                            return;
                          }

                          if (selectedItems.length === 0) {
                            layer.msg("请至少选择一个检验项目", { icon: 5 });
                            return;
                          }

                          // 显示提交进度
                          var submitIndex = layer.msg("正在提交申请...", {
                            icon: 16,
                            shade: 0.3,
                            time: 0,
                          });

                          // 提交申请
                          submitTestApply(selectedItems, function (success) {
                            layer.close(submitIndex);
                            if (success) {
                              layer.msg("检验项目申请成功！", {
                                icon: 1,
                                time: 2000,
                                end: function () {
                                  layer.close(index);
                                  table.reload("jianyan-table");
                                },
                              });
                            }
                          });
                        });

                      // 取消申请
                      $(layero)
                        .find("#cancel-items")
                        .click(function () {
                          layer.close(index);
                        });
                    },
                  });
                });
              });
              break;
          }
        });
      });
    </script>
  </body>
</html>
