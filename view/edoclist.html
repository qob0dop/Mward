<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>电子病历</title>
    <!--<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">-->
    <link
      rel="stylesheet"
      href="../lib/layui-v2.6.3/css/layui.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <style>
      .layui-btn:not(.layui-btn-lg):not(.layui-btn-sm):not(.layui-btn-xs) {
        height: 34px;
        line-height: 34px;
        padding: 0 8px;
      }

      .layui-input {
        color: dodgerblue;
      }

      .layui-btn-radius {
        width: 80px;
      }

      body {
        background-color: transparent;
      }

      .layui-elem-quote {
        padding: 5px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .layuimini-main {
        margin: 10px 10px 0px 210px;
      }

      .layui-body {
        padding-left: 200px;
        left: 0px;
      }
      .layui-layout-admin .layui-body {
        padding-bottom: 0px;
      }

      .layui-body .layadmin-tabsbody-item {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        overflow: hidden;
        overflow-y: auto;
      }

      .cmdlist-text .info {
        /*height: 40px;*/
        font-size: 12px;
        width: 100%;
        overflow: hidden;
        color: #5f5f5f;
        margin-bottom: 10px;
      }

      .cmdlist-text .price {
        font-size: 12px;
      }

      .cmdlist-text .price b {
        margin-right: 20px;
      }

      .cmdlist-text .price p {
        display: inline-block;
      }

      .cmdlist-text .flow {
        text-align: right;
        float: right;
      }

      .cmdlist-container img {
        width: 50%;
      }
      .layui-layer-setwin a {
        height: 26px;
        transform: scale(1.5);
      }
    </style>
  </head>
  <body>
    <div class="layuimini-container">
      <div class="layuimini-main">
        <div class="layui-btn-container">
          <blockquote
            class="layui-elem-quote"
            style="
              font-size: 1.1rem;
              display: inline-block;
              line-height: 1;
              padding: 8px;
              font-weight: bold;
            "
          >
            电子病历
          </blockquote>
          <i class="layui-icon layui-icon-form" style="color: blue"></i>
          <button
            type="button"
            id="btn_ward_name"
            class="layui-btn layui-btn-primary"
            style="border-color: transparent"
          >
            病区名称
          </button>
          <i class="layui-icon layui-icon-username" style="color: blue"></i>
          <button
            type="button"
            id="btn_user_name"
            class="layui-btn layui-btn-primary"
            style="border-color: transparent"
          >
            患者姓名
          </button>
          <button
            class="layui-btn layui-btn-sm layui-bg-blue"
            id="reloadTest"
            style="display: none"
          >
            选择病区
            <i class="layui-icon layui-icon-down layui-font-12"></i>
          </button>
          <!--<button class="layui-btn layui-btn-normal" lay-event="allPatient">全部患者</button>
                <button class="layui-btn layui-btn-primary" lay-event="myPatient">我的患者</button>-->

          <button
            type="button"
            class="layui-btn layui-btn-sm layui-btn-normal"
            onclick="javascrript:window.history.back();"
            style="float: right; font-size: 14px"
          >
            <i class="layui-icon"></i>返回
          </button>
        </div>
      </div>
      <ul
        class="layui-nav layui-nav-tree layui-nav-side"
        lay-filter="choice"
        id="doc_menu"
      >
        <li class="layui-nav-item layui-nav-itemed">
          <a href="javascript:;">医生文书</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">病程记录</a></dd>
            <dd><a href="javascript:;">入院记录</a></dd>
            <dd><a href="javascript:;">手术记录</a></dd>
          </dl>
        </li>
        <li class="layui-nav-item">
          <a href="javascript:;">护理文书</a>
          <dl class="layui-nav-child">
            <dd><a href="javascript:;">护理记录</a></dd>
            <dd><a href="javascript:;">护理计划</a></dd>
          </dl>
        </li>
      </ul>
      <div class="layui-body" id="LAY_app_body">
        <!-- 动态内容显示区域 -->
        <div style="padding: 15px; height: 100vh">
          <div class="layui-card" style="height: 100%">
            <div
              id="content-loading"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #999;
                font-size: 14px;
              "
            >
              <i
                class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"
                style="margin-right: 10px"
              ></i>
              请选择左侧菜单项目...
            </div>
            <iframe
              src="about:blank"
              height="100%"
              width="100%"
              frameborder="0"
              class="layui-iframe"
              style="display: none"
            ></iframe>
          </div>
        </div>
      </div>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      // xml转换为js对象
      function xmlToJson(xml) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xml, "text/xml");

        function parseNode(node) {
          const obj = {};
          if (node.nodeType === 1) {
            if (node.attributes.length > 0) {
              obj["@attributes"] = {};
              for (let i = 0; i < node.attributes.length; i++) {
                const attr = node.attributes[i];
                obj["@attributes"][attr.nodeName] = attr.nodeValue;
              }
            }
            if (node.hasChildNodes()) {
              const children = node.childNodes;
              for (let i = 0; i < children.length; i++) {
                const child = children[i];
                const childName = child.nodeName;
                if (childName === "#text") {
                  const text = child.nodeValue.trim();
                  if (text) {
                    obj["#text"] = text;
                  }
                } else {
                  const childObj = parseNode(child);
                  if (obj[childName]) {
                    if (!Array.isArray(obj[childName])) {
                      obj[childName] = [obj[childName]];
                    }
                    obj[childName].push(childObj);
                  } else {
                    obj[childName] = childObj;
                  }
                }
              }
            }
          }
          const keys = Object.keys(obj); //拍平处理
          if (keys.length === 1 && keys[0] === "#text") {
            return obj["#text"];
          }
          return obj;
        }

        return parseNode(xmlDoc.documentElement);
      }
    </script>
    <script>
      layui.use(["tree", "appconfig", "element"], function () {
        var $ = layui.jquery;
        var tree = layui.tree;
        var appconfig = layui.appconfig;
        var element = layui.element;
        var userData = localStorage.getItem("userData");

        // 处理用户数据
        if (userData) {
          userData = JSON.parse(userData);
        } else {
          userData = { patient_id: "001009540800" }; // 默认数据
        }

        // 动态加载菜单数据
        $.ajax({
          url: "http://10.101.199.42:18888/api/Interface/QueryInterfaceXmlToJsonFromForm",
          type: "post",
          data: {
            param: `<Service>
          <Service_Header>
              <Request_Main>gx_YDYZ_GetBLType</Request_Main>
          </Service_Header>
          <Service_Body>
              <Request>
                  <patient_id>001009540800</patient_id>
              </Request>
          </Service_Body>
      </Service>`,
          },
          beforeSend: function () {
            $("#content-loading")
              .show()
              .html(
                '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop" style="margin-right: 10px;"></i>正在加载菜单...'
              );
          },
          success: function (res) {
            try {
              const resobj = xmlToJson(res);
              const records = resobj.record;

              if (!records || records.length === 0) {
                $("#content-loading").html(
                  '<i class="layui-icon layui-icon-face-cry" style="margin-right: 10px;"></i>暂无数据'
                );
                return;
              }

              console.log(records);
              const groupMap = {};
              records.forEach((record) => {
                if (!groupMap[record.parent_name])
                  groupMap[record.parent_name] = [];
                groupMap[record.parent_name].push(record);
              });

              let html = "";
              Object.keys(groupMap).forEach((parent) => {
                html += `<li class="layui-nav-item"><a href="#">${parent}</a><dl class="layui-nav-child">`;
                groupMap[parent].forEach((record) => {
                  html += `<dd data-id="${record.record_serial}"><a>${
                    record.noteTitle || record.name || "未命名"
                  }</a></dd>`;
                });
                html += "</dl></li>";
              });

              document.querySelector("#doc_menu").innerHTML = html;

              // 重新渲染layui导航
              if (layui.element && layui.element.init) layui.element.init();

              $("#content-loading").html(
                '<i class="layui-icon layui-icon-list" style="margin-right: 10px;"></i>请选择左侧菜单项目...'
              );
            } catch (error) {
              console.error("数据解析错误:", error);
              $("#content-loading").html(
                '<i class="layui-icon layui-icon-close" style="color: #ff5722; margin-right: 10px;"></i><span style="color: #ff5722;">数据解析失败</span>'
              );
            }
          },
          error: function (xhr, status, error) {
            console.error("请求失败:", error);
            $("#content-loading").html(
              '<i class="layui-icon layui-icon-close" style="color: #ff5722; margin-right: 10px;"></i><span style="color: #ff5722;">网络请求失败</span>'
            );
          },
        });

        // 使用Layui推荐的element.on方式监听菜单点击
        element.on("nav(choice)", function (elem) {
          // elem 是被点击的jQuery对象
          // 判断是否点击的是子菜单（dd > a）
          if (!elem.parent().is("li")) {
            // 获取data-id属性（应从dd上取）
            var dataId = elem.parent().data("id");
            console.log("你点击了子项：", elem.text(), "data-id:", dataId);

            // 这里可以写点击子项后的操作
            $.ajax({
              url: `http://10.102.41.142:5220/api/Emr2DocFile/GetDocHtmlTextByIdAsync?noteContent=0003464562007${dataId}`,
              type: "get",
              dataType: "json",
              beforeSend: function () {
                $("#content-loading")
                  .show()
                  .html(
                    '<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop" style="margin-right: 10px;"></i>正在加载文档...'
                  );
                $(".layui-iframe").hide();
              },
              success: function (res) {
                try {
                  // 处理返回的数据
                  const binaryString = atob(res.Data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  const htmlString = new TextDecoder("utf-8").decode(bytes);

                  // 创建iframe并显示内容
                  var iframe = document.querySelector(".layui-iframe");
                  iframe.src = "about:blank";
                  iframe.onload = function () {
                    var doc =
                      iframe.contentDocument || iframe.contentWindow.document;
                    doc.open();
                    doc.write(htmlString);
                    doc.close();

                    // 隐藏加载状态，显示iframe
                    $("#content-loading").hide();
                    $(".layui-iframe").show();
                  };
                } catch (error) {
                  console.error("文档解析错误:", error);
                  $("#content-loading").html(
                    '<i class="layui-icon layui-icon-close" style="color: #ff5722; margin-right: 10px;"></i><span style="color: #ff5722;">文档解析失败</span>'
                  );
                }
              },
              error: function (xhr, status, error) {
                console.error("文档加载失败:", error);
                $("#content-loading").html(
                  '<i class="layui-icon layui-icon-close" style="color: #ff5722; margin-right: 10px;"></i><span style="color: #ff5722;">文档加载失败，请重试</span>'
                );
              },
            });
          } else if (elem.parent().is("li")) {
            // 点击的是一级类别
            console.log("你点击了类别：", elem.text());
            // 这里可以写点击类别后的操作
          }
          // 展开/收起逻辑Layui会自动处理
        });

        // 移除旧的静态功能，保留必要的初始化
        $("#btn_ward_name").html(localStorage.ward_name || "病区名称");

        if (userData && userData.name) {
          $("#btn_user_name").html(
            userData.name +
              " " +
              (userData.sex_name || "") +
              " " +
              (userData.ages || "")
          );
        } else {
          $("#btn_user_name").html("患者姓名");
        }

        $(".layuimini-container").show();
      });
    </script>
  </body>
</html>
