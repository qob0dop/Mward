<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>医嘱信息</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="stylesheet" href="/lib/layui-v2.6.3/css/layui.css" media="all" />
    <link rel="stylesheet" href="/css/public.css" media="all" />
    <link rel="stylesheet" href="/css/table/iframe.css" media="all" />
    <!-- <style>
      body {
        background-color: transparent;
        padding: 0;
        margin: 0;
        font-size: 16px;
      }
      .layui-table-cell {
        height: auto;
        white-space: normal;
        padding: 4px 8px;
      }
      /* 移除容器边距，使用全宽 */
      .layui-container {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }
      .layui-row,
      .layui-col-md12 {
        padding: 0;
        margin: 0;
      }
      /* 表格行触摸效果 */
      .layui-table tbody tr:active {
        background-color: #f0f0f0;
      }
      /* 让表格滚动更流畅 */
      .layui-table-body {
        -webkit-overflow-scrolling: touch;
      }
      /* 增大按钮触摸区域 */
      .layui-btn {
        height: 40px;
        line-height: 40px;
      }
      
      /* 按钮选中状态样式 */
      
      
      /* 按钮默认状态 */
      .layui-btn {
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }
      
      /* 按钮容器样式优化 */
      .filter-buttons {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      /* 表格标题样式 */
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      .layui-table-tool-temp {
        padding-right: 0;
      }

      .layui-table-tool {
        padding: 5px;
      }

      .layui-table-view {
        margin: 0;
        width: 100%;
        height: calc(100% - 50px);
      }

      .layui-table-box,
      .layui-table-body {
        height: 100%;
      }

      .layui-table {
        margin: 0;
      }

      /* 统一表头样式 */
      .layui-table thead tr {
        background-color: #f2f2f2;
      }
      .layui-table thead th {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        padding: 8px 0;
        line-height: 1.2;
      }
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      /* 根据医嘱类型设置行背景色 */
      /* .order-type-long {
        background-color: #e6f7ff !important;
      }
      .order-type-once {
        background-color: #fffbe6 !important;
      }
      .order-type-temp {
        background-color: #ffeaea !important;
      }
      .order-type-other {
        background-color: #f4f4f4 !important;
      } */
    </style> -->
    <style>
      .myorder {
        background-color: skyblue;
      }
      /* 选中按钮高亮样式，兼容不同色系 */
      .btn-active {
        position: relative;
        z-index: 1;
        font-weight: bold !important;
        border-width: 2.5px !important;
        box-shadow: 0 2px 8px rgba(30, 185, 90, 0.18), 0 0 0 2px #b2f0c0 inset !important;
        outline: none !important;
      }
      /* 针对绿色按钮（layui-btn-warm）选中时加深色 */
      .layui-btn-warm.btn-active {
        background-color: #3ec97c !important;
        border-color: #1eae5b !important;
        color: #fff !important;
      }
      /* 针对红色按钮（layui-btn-danger）选中时加深色 */
      .layui-btn-danger.btn-active {
        background-color: #e74c3c !important;
        border-color: #c0392b !important;
        color: #fff !important;
      }
      /* 针对蓝色按钮（layui-btn-primary/normal/cyan）选中时加深色 */
      .layui-btn-primary.btn-active,
      .layui-btn-normal.btn-active,
      .layui-btn-cyan.btn-active {
        background-color: #1e9fff !important;
        border-color: #1786d4 !important;
        color: #fff !important;
      }
      /* 兼容小屏幕按钮点击反馈 */
      .btn-active:active {
        box-shadow: 0 1px 4px rgba(30, 185, 90, 0.12) !important;
      }

      /* 按钮悬停效果 */
      .layui-btn:not(.btn-active):hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all 0.2s ease;
      }

      /* select框样式优化 */
      .layui-form-select {
        height: 34px !important;
      }

      .layui-form-select .layui-select-title {
        height: 34px !important;
        line-height: 34px !important;
        font-size: 13px !important;
        color: #333 !important;
        border: 1px solid #e6e6e6 !important;
        border-radius: 2px !important;
      }

      .layui-form-select .layui-select-title input {
        height: 32px !important;
        line-height: 32px !important;
        font-size: 13px !important;
        color: #333 !important;
      }

      .layui-form-select dl {
        font-size: 13px !important;
      }

      .layui-form-select dl dd {
        line-height: 36px !important;
        color: #333 !important;
      }
    </style>
  </head>
  <body>
    <div class="layui-container">
      <!-- 操作栏 -->
      <form class="layui-form">
        <div
          class="layui-btn-container filter-buttons"
          style="
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
          "
        >
          <!-- 录音按钮 -->
          <div style="display: flex; align-items: center; gap: 8px">
            <button
              type="button"
              id="btn-add-order"
              class="layui-btn layui-btn-sm layui-btn-primary"
            >
              <i class="layui-icon layui-icon-add-1"></i> 新增医嘱
            </button>
            <button
              type="button"
              id="btn-record-audio"
              class="layui-btn layui-btn-sm layui-btn-normal"
            >
              <i class="layui-icon layui-icon-mike"></i> 录音
            </button>
            <button
              type="button"
              id="btn-save-audio"
              class="layui-btn layui-btn-sm layui-btn-primary"
              style="display: none"
            >
              <i class="layui-icon layui-icon-download-circle"></i> 保存录音
            </button>
            <audio
              id="audio-preview"
              controls
              style="display: none; max-width: 120px"
            ></audio>
          </div>
          <!-- 医嘱类型筛选 -->
          <div style="display: flex; gap: 8px; align-items: center">
            <span
              style="
                font-size: 13px;
                color: #666;
                font-weight: bold;
                white-space: nowrap;
                text-overflow: ellipsis;
              "
              >医嘱类型：</span
            >
            <select
              id="order-type-select"
              lay-filter="order-type-select"
              class="layui-select"
              style="font-size: 13px; width: 150px"
            >
              <option value="long">长期医嘱</option>
              <option value="temp">临时医嘱</option>
              <option value="all" selected>全部医嘱</option>
            </select>
          </div>
          <!-- 开嘱人筛选 -->
          <div
            style="
              display: flex;
              gap: 8px;
              align-items: center;
              margin-left: 20px;
            "
          >
            <span
              style="
                font-size: 13px;
                color: #666;
                font-weight: bold;
                white-space: nowrap;
                text-overflow: ellipsis;
              "
              >开嘱人：</span
            >
            <select
              id="role-type-select"
              lay-filter="role-type-select"
              class="layui-select"
              style="font-size: 13px; width: 150px"
            >
              <option value="doctor" selected>医生</option>
              <option value="nurse">护士</option>
              <option value="all-role">全部</option>
            </select>
          </div>
        </div>
      </form>
      <!-- 医嘱表格容器 -->
      <div class="table-container">
        <table
          class="layui-hide"
          id="yizhu-table"
          lay-filter="yizhu-table"
        ></table>
      </div>

      <!-- 工具栏模板 -->
      <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
          <button
            class="layui-btn layui-btn-sm layui-btn-primary"
            lay-event="print"
          >
            <i class="layui-icon layui-icon-print"></i> 打印
          </button>
          <button
            class="layui-btn layui-btn-sm layui-btn-normal"
            lay-event="export"
          >
            <i class="layui-icon layui-icon-export"></i>导出
          </button>
        </div>
      </script>

      <!-- 行工具栏 -->
      <script type="text/html" id="barDemo">
        <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
      </script>
    </div>

    <script src="/lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="/js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      // 打印按钮事件
      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("btn-print");
        if (btn) {
          btn.onclick = function () {
            window.print();
          };
        }

        // 录音功能
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob = null;
        const recordBtn = document.getElementById("btn-record-audio");
        const saveBtn = document.getElementById("btn-save-audio");
        const audioPreview = document.getElementById("audio-preview");
        let isRecording = false;

        if (recordBtn && saveBtn && audioPreview) {
          recordBtn.onclick = async function () {
            if (!isRecording) {
              // 开始录音
              if (
                !navigator.mediaDevices ||
                !navigator.mediaDevices.getUserMedia
              ) {
                layer.msg("当前浏览器不支持录音", { icon: 2 });
                return;
              }
              try {
                const stream = await navigator.mediaDevices.getUserMedia({
                  audio: true,
                });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = function (e) {
                  if (e.data.size > 0) audioChunks.push(e.data);
                };
                mediaRecorder.onstop = function () {
                  audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                  audioPreview.src = URL.createObjectURL(audioBlob);
                  audioPreview.style.display = "inline-block";
                  saveBtn.style.display = "inline-block";
                };
                mediaRecorder.start();
                isRecording = true;
                recordBtn.innerHTML =
                  '<i class="layui-icon layui-icon-pause"></i> 停止';
                saveBtn.style.display = "none";
                audioPreview.style.display = "none";
                layer.msg("正在录音...再次点击停止", { icon: 1, time: 1200 });
              } catch (err) {
                layer.msg("无法访问麦克风", { icon: 2 });
              }
            } else {
              // 停止录音
              if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
              }
              isRecording = false;
              recordBtn.innerHTML =
                '<i class="layui-icon layui-icon-mike"></i> 录音';
            }
          };
          saveBtn.onclick = function () {
            if (audioBlob) {
              const url = URL.createObjectURL(audioBlob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = "record.webm";
              document.body.appendChild(a);
              a.click();
              setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }, 100);
            }
          };
        }
      });
      layui.use(["table", "appconfig", "form"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;
        var form = layui.form;

        // 立即渲染表单元素，确保select框能正常工作
        form.render();

        // 获取URL参数
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");

        // 获取患者信息和病区信息
        var patientData = JSON.parse(
          localStorage.getItem("patientData") || "{}"
        );
        var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");
        var ward_sn = wardData.ward_sn || localStorage.ward_sn || "";
        var userData = localStorage.getItem("userData");
        if (userData === null) {
          layer.msg("请先选择患者！");
          return;
        }
        var jsonData = JSON.parse(userData);

        // 缓存全部医嘱数据
        var allYizhuData = [];

        // 当前筛选条件
        var currentFilters = {
          orderType: "all", // 'long', 'temp', 'all'
          roleType: "doctor", // 'doctor', 'nurse', 'all-role'
        };
        var tableCols = [
          [
            { title: "开始", colspan: 7, align: "center" },
            { title: "停止", colspan: 1, align: "center" },
            { title: "录入", colspan: 1, align: "center" },
            { title: "操作", colspan: 1, align: "center" },
          ],
          [
            { field: "long_once_flag", title: "医嘱类型", width: 100 },
            { field: "start_time_mm_dd", title: "日期", width: 80 },
            {
              field: "order_name",
              title: "医嘱",
              align: "center",
            },
            { field: "charge_amount", title: "数量", width: 80 },
            { field: "frequ_name", title: "频率", width: 80 },
            { field: "supply_name", title: "用法", width: 80 },
            { field: "order_doctor_name", title: "医生", width: 80 },
            { field: "end_time_mm_dd", title: "日期", width: 80 },
            { field: "end_time_mm_dd", title: "日期", width: 80 },
            {
              // fixed: "right",
              title: "操作",
              toolbar: "#rowActionBar",
              width: 120,
              align: "center",
            },
          ],
        ];
        // 行操作栏模板
        var rowActionBar = `
          <div class="layui-btn-group">
            <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="revoke">撤销</button>
            <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="stop">停止</button>
          </div>
        `;
        // 动态插入模板到页面底部
        if (!document.getElementById("rowActionBar")) {
          var tpl = document.createElement("script");
          tpl.type = "text/html";
          tpl.id = "rowActionBar";
          tpl.innerHTML = rowActionBar;
          document.body.appendChild(tpl);
        }

        // 首次加载数据
        function loadYizhuData(callback) {
          $.ajax({
            url:
              appconfig.api +
              "/api/MobileWard/GetYzManageEOPOrders?ward_sn=" +
              ward_sn +
              "&inpatient_no=" +
              jsonData.inpatient_no,
            method: "GET",
            dataType: "json",
            success: function (res) {
              allYizhuData = res.Data || [];
              renderYizhuTable(allYizhuData);
              if (typeof callback === "function") callback();
            },
            error: function () {
              allYizhuData = [];
              renderYizhuTable([]);
              if (typeof callback === "function") callback();
            },
          });
        }

        // 停止医嘱功能
        function stopMedicalOrder(orderData) {
          console.log("orderData:", orderData);

          // 获取当前用户信息
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var doctorName =
            currentUser.user_mi || currentUser.user_name || "系统用户";

          // 获取当前时间
          var now = new Date();
          var stopTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // 确认对话框
          layer.confirm(
            "确定要停止此医嘱吗？<br>" +
              '<span style="color: #666; font-size: 12px;">医嘱内容：' +
              (orderData.order_name || "未知") +
              "</span>",
            {
              icon: 3,
              title: "停止医嘱确认",
              btn: ["确定停止", "取消"],
            },
            function (index) {
              // 构建API参数
              var apiParams = {
                patient_id: patient_id || orderData.patient_id,
                admiss_times: admiss_times || orderData.admiss_times,
                act_order_no: orderData.act_order_no || orderData.order_no,
                stop_doctor: doctorName,
                stop_time: stopTime,
              };

              // 调试信息
              console.log("停止医嘱API参数:", apiParams);
              console.log("医嘱数据:", orderData);

              // 验证必要参数
              if (
                !apiParams.patient_id ||
                !apiParams.admiss_times ||
                !apiParams.act_order_no
              ) {
                layer.msg(
                  "缺少必要参数，无法停止医嘱<br>请检查患者ID、住院次数和医嘱编号",
                  {
                    icon: 2,
                    time: 3000,
                  }
                );
                console.error("参数验证失败:", apiParams);
                return;
              }

              // 显示加载提示
              var loadingIndex = layer.load(1, { shade: [0.3, "#000"] });
              console.log("apiParams:", apiParams);

              // 调用停止医嘱API
              $.ajax({
                url: appconfig.api + "/api/MobileWard/StopActYz",
                method: "GET",
                data: apiParams,
                dataType: "json",
                success: function (response) {
                  layer.close(loadingIndex);

                  if (response && response.Status) {
                    layer.msg("医嘱停止成功", { icon: 1 });

                    // 刷新表格数据
                    loadYizhuData(function () {
                      applyFilters(); // 重新应用当前筛选条件
                    });
                  } else {
                    var errorMsg =
                      response && response.Message
                        ? response.Message
                        : "停止医嘱失败";
                    layer.msg(errorMsg, { icon: 2, time: 4000 });
                    console.error("API响应错误:", response);
                  }

                  layer.close(index);
                },
                error: function (xhr, status, error) {
                  layer.close(loadingIndex);
                  layer.close(index);

                  var errorMsg = "网络错误，停止医嘱失败";

                  // 详细的错误处理
                  if (xhr.responseJSON && xhr.responseJSON.Message) {
                    errorMsg = xhr.responseJSON.Message;

                    // 特殊处理SQL文件缺失错误
                    if (
                      errorMsg.indexOf("Could not find file") !== -1 &&
                      errorMsg.indexOf("yz_stop_order.sql") !== -1
                    ) {
                      errorMsg =
                        "服务器配置错误：缺少停止医嘱的SQL文件\n请联系系统管理员检查服务器配置";
                    }
                  } else if (xhr.status === 401) {
                    errorMsg = "权限不足，请重新登录";
                  } else if (xhr.status === 500) {
                    errorMsg = "服务器内部错误";
                  } else if (xhr.status === 404) {
                    errorMsg = "API接口不存在，请检查服务器配置";
                  }

                  layer.msg(errorMsg, { icon: 2, time: 5000 });
                  console.error("AJAX错误详情:", {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error,
                  });
                },
              });
            }
          );
        }

        // 新增医嘱功能
        function addMedicalOrder() {
          // 获取当前用户信息
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var doctorCode = currentUser.user_id || "00000";
          var doctorName =
            currentUser.user_mi || currentUser.user_name || "系统用户";

          // 获取当前时间
          var now = new Date();
          var currentTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // 弹出新增医嘱表单
          layer.open({
            type: 1,
            title: "新增医嘱",
            area: ["600px", "700px"],
            content: `
              <form class="layui-form" style="padding: 20px;" id="add-order-form">
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">医嘱类型</label>
                      <div class="layui-input-block">
                        <select name="long_once_flag" lay-verify="required">
                          <option value="">请选择</option>
                          <option value="1">长期医嘱</option>
                          <option value="0">临时医嘱</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">医嘱类型代码</label>
                      <div class="layui-input-block">
                        <input type="text" name="order_type" placeholder="如：3" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <label class="layui-form-label">医嘱内容</label>
                  <div class="layui-input-block">
                    <input type="text" name="order_name" lay-verify="required" placeholder="请输入医嘱内容" class="layui-input">
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">数量</label>
                      <div class="layui-input-block">
                        <input type="text" name="charge_amount" placeholder="如：1" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">频率代码</label>
                      <div class="layui-input-block">
                        <input type="text" name="frequ_code" placeholder="如：ONCE" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">用法代码</label>
                      <div class="layui-input-block">
                        <input type="text" name="supply_code" placeholder="用法代码" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">执行科室</label>
                      <div class="layui-input-block">
                        <input type="text" name="exec_unit" placeholder="如：2020100" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">药物规格</label>
                      <div class="layui-input-block">
                        <input type="text" name="drug_specification" placeholder="药物规格" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">医嘱代码</label>
                      <div class="layui-input-block">
                        <input type="text" name="order_code" placeholder="如：500004" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">剂量</label>
                      <div class="layui-input-block">
                        <input type="number" name="doseage" placeholder="剂量" class="layui-input">
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">剂量单位</label>
                      <div class="layui-input-block">
                        <input type="text" name="doseage_unit" placeholder="剂量单位" class="layui-input">
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <label class="layui-form-label">说明</label>
                  <div class="layui-input-block">
                    <textarea name="instruction" placeholder="请输入说明" class="layui-textarea"></textarea>
                  </div>
                </div>
                
                <div class="layui-row">
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">是否自费</label>
                      <div class="layui-input-block">
                        <select name="self_buy">
                          <option value="0">否</option>
                          <option value="1">是</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div class="layui-col-md6">
                    <div class="layui-form-item">
                      <label class="layui-form-label">是否皮试</label>
                      <div class="layui-input-block">
                        <select name="skin_test_flag">
                          <option value="">无需皮试</option>
                          <option value="1">需要皮试</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="layui-form-item">
                  <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="add-order">立即提交</button>
                    <button type="button" class="layui-btn layui-btn-primary" onclick="layer.closeAll()">取消</button>
                  </div>
                </div>
              </form>
            `,
            success: function (layero, index) {
              // 重新渲染表单
              form.render();

              // 监听表单提交
              form.on("submit(add-order)", function (data) {
                submitNewOrder(data.field, index);
                return false;
              });
            },
          });
        }

        // 提交新增医嘱
        function submitNewOrder(formData, layerIndex) {
          // 获取当前用户和时间信息
          var currentUser = JSON.parse(
            localStorage.getItem("loginUser") || "{}"
          );
          var doctorCode = currentUser.user_id || "00000";
          var doctorName =
            currentUser.user_mi || currentUser.user_name || "系统用户";

          var now = new Date();
          var currentTime =
            String(now.getMonth() + 1).padStart(2, "0") +
            "/" +
            String(now.getDate()).padStart(2, "0") +
            "/" +
            now.getFullYear() +
            " " +
            String(now.getHours()).padStart(2, "0") +
            ":" +
            String(now.getMinutes()).padStart(2, "0") +
            ":" +
            String(now.getSeconds()).padStart(2, "0");

          // 构建API参数
          var apiParams = {
            long_once_flag: formData.long_once_flag,
            start_time: currentTime,
            end_time: null,
            end_time_2: null,
            order_name: formData.order_name,
            charge_amount: formData.charge_amount || "1",
            frequ_code: formData.frequ_code || "ONCE",
            drug_specification: formData.drug_specification || null,
            order_doctor: doctorCode,
            enter_oper: doctorCode,
            Serial: "**",
            enter_time: currentTime,
            exec_unit: formData.exec_unit || ward_sn,
            order_time: currentTime,
            patient_id: patient_id,
            admiss_times: admiss_times,
            status_flag: "1",
            fit_flag: "1",
            exclusive_type: "1",
            order_type: formData.order_type || "3",
            drug_occ: null,
            discription: null,
            group_no: "000000",
            ca_id_doctor: null,
            order_code: formData.order_code,
            act_order_no: null, // 后端生成
            alter_print_order: null,
            modify_price: null,
            prev_flag: null,
            ward_sn: ward_sn,
            instruction: formData.instruction || null,
            doseage: formData.doseage ? parseFloat(formData.doseage) : null,
            doseage_unit: formData.doseage_unit || null,
            supply_code: formData.supply_code || null,
            parent_no: null,
            self_buy: formData.self_buy || "0",
            skin_test_flag: formData.skin_test_flag || null,
            drop_speed: null,
            spinfo_type: formData.self_buy === "1" ? "0" : "1",
            fua: null,
            add_time: currentTime,
            add_opera: doctorCode,
            is_new: true,
          };

          console.log("新增医嘱API参数:", apiParams);

          // 显示加载提示
          var loadingIndex = layer.load(1, { shade: [0.3, "#000"] });

          // 调用新增医嘱API
          $.ajax({
            url: appconfig.api + "/api/MobileWard/AddActYz",
            method: "POST",
            data: apiParams,
            dataType: "json",
            success: function (response) {
              layer.close(loadingIndex);

              if (response && response.Status) {
                layer.msg("医嘱新增成功", { icon: 1 });
                layer.close(layerIndex); // 关闭表单弹窗

                // 刷新表格数据
                loadYizhuData(function () {
                  applyFilters(); // 重新应用当前筛选条件
                });
              } else {
                var errorMsg =
                  response && response.Message
                    ? response.Message
                    : "新增医嘱失败";
                layer.msg(errorMsg, { icon: 2, time: 4000 });
                console.error("API响应错误:", response);
              }
            },
            error: function (xhr, status, error) {
              layer.close(loadingIndex);

              var errorMsg = "网络错误，新增医嘱失败";

              if (xhr.responseJSON && xhr.responseJSON.Message) {
                errorMsg = xhr.responseJSON.Message;
              } else if (xhr.status === 401) {
                errorMsg = "权限不足，请重新登录";
              } else if (xhr.status === 500) {
                errorMsg = "服务器内部错误";
              } else if (xhr.status === 404) {
                errorMsg = "API接口不存在，请检查服务器配置";
              }

              layer.msg(errorMsg, { icon: 2, time: 5000 });
              console.error("AJAX错误详情:", {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error,
              });
            },
          });
        }

        // 撤销医嘱功能（框架，需要根据实际API调整）
        function revokeMedicalOrder(orderData) {
          layer.confirm(
            "确定要撤销此医嘱吗？<br>" +
              '<span style="color: #ff5722; font-size: 12px;">注意：撤销后医嘱将被永久删除</span><br>' +
              '<span style="color: #666; font-size: 12px;">医嘱内容：' +
              (orderData.order_name || "未知") +
              "</span>",
            {
              icon: 3,
              title: "撤销医嘱确认",
              btn: ["确定撤销", "取消"],
            },
            function (index) {
              // TODO: 根据实际撤销医嘱API调整以下代码
              // 示例API参数结构：
              /*
                         var apiParams = {
                           patient_id: patient_id || orderData.patient_id,
                           admiss_times: admiss_times || orderData.admiss_times,
                           order_no: orderData.order_no,
                           revoke_doctor: doctorName,
                           revoke_reason: "医生撤销"
                         };
                         */

              layer.msg("撤销功能需要根据具体API实现", { icon: 0 });
              layer.close(index);
            }
          );
        }

        // 渲染表格
        function renderYizhuTable(data) {
          table.render({
            elem: "#yizhu-table",
            data: data,
            defaultToolbar: [],
            cols: tableCols,
            height: "full-60", // 减去过滤按钮区域的高度
            text: {
              none: "暂无医嘱数据",
            },
            done: function (res, curr, count) {
              // 根据医嘱类型设置行背景色
              $("#yizhu-table")
                .next(".layui-table-view")
                .find("tbody tr")
                .each(function (i, tr) {
                  var row = data[i];
                  if (!row) return;
                  var type = (row.long_once_flag || "").toLowerCase();
                  if (type.indexOf("长") !== -1 || type === "long") {
                    $(tr).addClass("order-type-long");
                  } else if (type.indexOf("临") !== -1 || type === "once") {
                    $(tr).addClass("order-type-once");
                  } else if (type.indexOf("备") !== -1 || type === "temp") {
                    $(tr).addClass("order-type-temp");
                  } else {
                    $(tr).addClass("order-type-other");
                  }
                  if (row.order_doctor_name) {
                    $(tr).addClass("myorder");
                  }
                });
            },
          });
        }

        // 应用筛选条件
        function applyFilters() {
          var filtered = allYizhuData.filter(function (item) {
            var matchOrderType = true;
            var matchRoleType = true;

            // 医嘱类型筛选
            if (currentFilters.orderType === "long") {
              matchOrderType = String(item.long_once_flag) === "1";
            } else if (currentFilters.orderType === "temp") {
              matchOrderType = String(item.long_once_flag) === "0";
            }
            // 'all' 不需要筛选条件

            // 开嘱人类型筛选
            if (currentFilters.roleType === "doctor") {
              matchRoleType = String(item.fit_flag) === "1";
            } else if (currentFilters.roleType === "nurse") {
              matchRoleType = String(item.fit_flag) === "0";
            }
            // 'all-role' 不需要筛选条件

            return matchOrderType && matchRoleType;
          });

          renderYizhuTable(filtered);

          // 显示筛选结果提示
          var orderTypeText =
            currentFilters.orderType === "long"
              ? "长期医嘱"
              : currentFilters.orderType === "temp"
              ? "临时医嘱"
              : "全部医嘱";
          var roleTypeText =
            currentFilters.roleType === "doctor"
              ? "医生医嘱"
              : currentFilters.roleType === "nurse"
              ? "护士医嘱"
              : "全部";

          if (
            currentFilters.orderType !== "all" ||
            currentFilters.roleType !== "all-role"
          ) {
            layer.msg(`已筛选：${orderTypeText} - ${roleTypeText}`, {
              icon: 1,
              time: 1500,
            });
          } else {
            layer.msg("已显示全部医嘱", { icon: 1, time: 1000 });
          }
        }

        // select框筛选事件 - 医嘱类型
        form.on("select(order-type-select)", function (data) {
          console.log("医嘱类型select触发了:", data.value);
          currentFilters.orderType = data.value;
          applyFilters();
        });

        // select框筛选事件 - 开嘱人类型
        form.on("select(role-type-select)", function (data) {
          console.log("开嘱人类型select触发了:", data.value);
          currentFilters.roleType = data.value;
          applyFilters();
        });

        // 新增医嘱按钮事件
        $(document).on("click", "#btn-add-order", function () {
          addMedicalOrder();
        });

        // 默认加载全部并设置默认选中状态，首次加载后立即应用筛选条件
        loadYizhuData(applyFilters);

        // 头工具栏事件
        table.on("toolbar(yizhu-table)", function (obj) {
          switch (obj.event) {
            case "refresh":
              table.reload("yizhu-table");
              break;
            case "export":
              layer.msg("导出功能开发中...");
              break;
          }
        });

        // 行工具栏事件
        table.on("tool(yizhu-table)", function (obj) {
          var data = obj.data;
          if (obj.event === "detail") {
            layer.open({
              type: 1,
              title: "医嘱详情",
              area: ["600px", "400px"],
              content:
                '<div style="padding: 20px;">' +
                "<p><strong>医嘱日期：</strong>" +
                data.order_date +
                " " +
                data.order_time +
                "</p>" +
                "<p><strong>医嘱类型：</strong>" +
                data.order_type_name +
                "</p>" +
                "<p><strong>医嘱内容：</strong>" +
                data.order_text +
                "</p>" +
                "<p><strong>剂量：</strong>" +
                (data.dosage || "") +
                "</p>" +
                "<p><strong>频次：</strong>" +
                (data.frequency || "") +
                "</p>" +
                "<p><strong>用法：</strong>" +
                (data.usage || "") +
                "</p>" +
                "<p><strong>开嘱医生：</strong>" +
                data.doctor_name +
                "</p>" +
                "<p><strong>状态：</strong>" +
                data.status_name +
                "</p>" +
                "</div>",
            });
          } else if (obj.event === "revoke") {
            revokeMedicalOrder(data);
          } else if (obj.event === "stop") {
            stopMedicalOrder(data);
          }
        });
      });
    </script>
  </body>
</html>
