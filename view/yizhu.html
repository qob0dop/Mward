<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>医嘱信息</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="../lib/layui-v2.6.3/css/layui.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <link rel="stylesheet" href="../css/table/iframe.css" media="all" />
    <!-- <style>
      body {
        background-color: transparent;
        padding: 0;
        margin: 0;
        font-size: 16px;
      }
      .layui-table-cell {
        height: auto;
        white-space: normal;
        padding: 4px 8px;
      }
      /* 移除容器边距，使用全宽 */
      .layui-container {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
      }
      .layui-row,
      .layui-col-md12 {
        padding: 0;
        margin: 0;
      }
      /* 表格行触摸效果 */
      .layui-table tbody tr:active {
        background-color: #f0f0f0;
      }
      /* 让表格滚动更流畅 */
      .layui-table-body {
        -webkit-overflow-scrolling: touch;
      }
      /* 增大按钮触摸区域 */
      .layui-btn {
        height: 40px;
        line-height: 40px;
      }
      
      /* 按钮选中状态样式 */
      .btn-active {
        background-color: #5FB878 !important;
        border: 3px solid #009688 !important;
        color: #fff !important;
        box-shadow: 0 0 10px rgba(0, 150, 136, 0.5) !important;
        font-weight: bold !important;
        transform: scale(1.05);
        transition: all 0.3s ease;
      }
      
      /* 按钮悬停效果 */
      .layui-btn:not(.btn-active):hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: all 0.2s ease;
      }
      
      /* 按钮默认状态 */
      .layui-btn {
        transition: all 0.2s ease;
        border: 2px solid transparent;
      }
      
      /* 按钮容器样式优化 */
      .filter-buttons {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
      }
      /* 表格标题样式 */
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      .layui-table-tool-temp {
        padding-right: 0;
      }

      .layui-table-tool {
        padding: 5px;
      }

      .layui-table-view {
        margin: 0;
        width: 100%;
        height: calc(100% - 50px);
      }

      .layui-table-box,
      .layui-table-body {
        height: 100%;
      }

      .layui-table {
        margin: 0;
      }

      /* 统一表头样式 */
      .layui-table thead tr {
        background-color: #f2f2f2;
      }
      .layui-table thead th {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        padding: 8px 0;
        line-height: 1.2;
      }
      .table-title {
        background-color: #1e9fff;
        color: #fff;
        padding: 10px 15px;
        font-size: 18px;
        font-weight: bold;
      }
      /* 根据医嘱类型设置行背景色 */
      /* .order-type-long {
        background-color: #e6f7ff !important;
      }
      .order-type-once {
        background-color: #fffbe6 !important;
      }
      .order-type-temp {
        background-color: #ffeaea !important;
      }
      .order-type-other {
        background-color: #f4f4f4 !important;
      } */
    </style> -->
  </head>
  <body>
    <div class="layui-container">
      <div class="layui-row">
        <div class="layui-col-md12">
          <!-- 操作栏 -->
          <div
            class="layui-btn-container filter-buttons"
            style="
              margin-bottom: 12px;
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              justify-content: center;
            "
          >
            <!-- 医嘱类型筛选 -->
            <div style="display: flex; gap: 8px; align-items: center">
              <span style="font-size: 13px; color: #666; font-weight: bold"
                >医嘱类型：</span
              >
              <button
                type="button"
                id="btn-long-order"
                class="layui-btn layui-btn-sm layui-btn-warm btn-active"
                data-filter="long"
              >
                长期医嘱
              </button>
              <button
                type="button"
                id="btn-temp-order"
                class="layui-btn layui-btn-sm layui-btn-danger"
                data-filter="temp"
              >
                临时医嘱
              </button>
              <button
                type="button"
                id="btn-all-order"
                class="layui-btn layui-btn-sm layui-btn-primary"
                data-filter="all"
              >
                全部医嘱
              </button>
            </div>

            <!-- 开嘱人筛选 -->
            <div
              style="
                display: flex;
                gap: 8px;
                align-items: center;
                margin-left: 20px;
              "
            >
              <span style="font-size: 13px; color: #666; font-weight: bold"
                >开嘱人：</span
              >
              <button
                type="button"
                id="btn-doctor-order"
                class="layui-btn layui-btn-sm layui-btn-normal"
                data-filter="doctor"
              >
                医生医嘱
              </button>
              <button
                type="button"
                id="btn-nurse-order"
                class="layui-btn layui-btn-sm layui-btn-cyan"
                data-filter="nurse"
              >
                护士医嘱
              </button>
              <button
                type="button"
                id="btn-all-role"
                class="layui-btn layui-btn-sm layui-btn-primary btn-active"
                data-filter="all-role"
              >
                全部
              </button>
            </div>
          </div>
          <!-- 医嘱表格 -->
          <table
            class="layui-hide"
            id="yizhu-table"
            lay-filter="yizhu-table"
          ></table>

          <!-- 工具栏模板 -->
          <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
              <button
                class="layui-btn layui-btn-sm layui-btn-primary"
                lay-event="print"
              >
                <i class="layui-icon layui-icon-print"></i> 打印
              </button>
              <button
                class="layui-btn layui-btn-sm layui-btn-normal"
                lay-event="export"
              >
                <i class="layui-icon layui-icon-export"></i>导出
              </button>
            </div>
          </script>

          <!-- 行工具栏 -->
          <script type="text/html" id="barDemo">
            <a class="layui-btn layui-btn-xs" lay-event="detail">详情</a>
          </script>
        </div>
      </div>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      // 打印按钮事件
      document.addEventListener("DOMContentLoaded", function () {
        var btn = document.getElementById("btn-print");
        if (btn) {
          btn.onclick = function () {
            window.print();
          };
        }
      });
      layui.use(["table", "appconfig"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;

        // 获取URL参数
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");

        // 获取患者信息和病区信息
        var patientData = JSON.parse(
          localStorage.getItem("patientData") || "{}"
        );
        var wardData = JSON.parse(localStorage.getItem("wardData") || "{}");
        var ward_sn = wardData.ward_sn || localStorage.ward_sn || "";
        var userData = localStorage.getItem("userData");
        if (userData === null) {
          layer.msg("请先选择患者！");
          return;
        }
        var jsonData = JSON.parse(userData);

        // 缓存全部医嘱数据
        var allYizhuData = [];

        // 当前筛选条件
        var currentFilters = {
          orderType: "long", // 'long', 'temp', 'all'
          roleType: "all-role", // 'doctor', 'nurse', 'all-role'
        };
        var tableCols = [
          [
            { title: "开始", colspan: 7, align: "center" },
            { title: "停止", colspan: 1, align: "center" },
            { title: "录入", colspan: 1, align: "center" },
            { title: "操作", colspan: 1, align: "center" },
          ],
          [
            { field: "long_once_flag", title: "医嘱类型", width: 100 },
            { field: "start_time_mm_dd", title: "日期", width: 80 },
            {
              field: "order_name",
              title: "医嘱",
              align: "center",
            },
            { field: "charge_amount", title: "数量", width: 80 },
            { field: "frequ_name", title: "频率", width: 80 },
            { field: "supply_name", title: "用法", width: 80 },
            { field: "order_doctor_name", title: "医生", width: 80 },
            { field: "end_time_mm_dd", title: "日期", width: 80 },
            { field: "end_time_mm_dd", title: "日期", width: 80 },
            {
              // fixed: "right",
              title: "操作",
              toolbar: "#rowActionBar",
              width: 120,
              align: "center",
            },
          ],
        ];
        // 行操作栏模板
        var rowActionBar = `
          <div class="layui-btn-group">
            <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="revoke">撤销</button>
            <button class="layui-btn layui-btn-xs layui-btn-warm" lay-event="stop">停止</button>
          </div>
        `;
        // 动态插入模板到页面底部
        if (!document.getElementById("rowActionBar")) {
          var tpl = document.createElement("script");
          tpl.type = "text/html";
          tpl.id = "rowActionBar";
          tpl.innerHTML = rowActionBar;
          document.body.appendChild(tpl);
        }

        // 首次加载数据
        function loadYizhuData(callback) {
          $.ajax({
            url:
              appconfig.api +
              "/api/ActPatient/GetYzManageEOPOrders?ward_sn=" +
              ward_sn +
              "&inpatient_no=" +
              jsonData.inpatient_no,
            method: "GET",
            dataType: "json",
            success: function (res) {
              allYizhuData = res.data || [];
              renderYizhuTable(allYizhuData);
              if (typeof callback === "function") callback();
            },
            error: function () {
              allYizhuData = [];
              renderYizhuTable([]);
              if (typeof callback === "function") callback();
            },
          });
        }

        // 渲染表格
        function renderYizhuTable(data) {
          table.render({
            elem: "#yizhu-table",
            data: data,
            defaultToolbar: [],
            cols: tableCols,
            height: "full-42",
            text: {
              none: "暂无医嘱数据",
            },
            done: function (res, curr, count) {
              // 根据医嘱类型设置行背景色
              $("#yizhu-table")
                .next(".layui-table-view")
                .find("tbody tr")
                .each(function (i, tr) {
                  var row = data[i];
                  if (!row) return;
                  var type = (row.long_once_flag || "").toLowerCase();
                  if (type.indexOf("长") !== -1 || type === "long") {
                    $(tr).addClass("order-type-long");
                  } else if (type.indexOf("临") !== -1 || type === "once") {
                    $(tr).addClass("order-type-once");
                  } else if (type.indexOf("备") !== -1 || type === "temp") {
                    $(tr).addClass("order-type-temp");
                  } else {
                    $(tr).addClass("order-type-other");
                  }
                });
            },
          });
        }

        // 按钮状态管理
        function setActiveButton(groupClass, activeId) {
          // 移除指定组内所有按钮的激活状态
          $(groupClass).removeClass("btn-active");
          // 为当前按钮添加激活状态
          $(activeId).addClass("btn-active");
        }

        // 应用筛选条件
        function applyFilters() {
          var filtered = allYizhuData.filter(function (item) {
            var matchOrderType = true;
            var matchRoleType = true;

            // 医嘱类型筛选
            if (currentFilters.orderType === "long") {
              matchOrderType = String(item.long_once_flag) === "1";
            } else if (currentFilters.orderType === "temp") {
              matchOrderType = String(item.long_once_flag) === "0";
            }
            // 'all' 不需要筛选条件

            // 开嘱人类型筛选
            if (currentFilters.roleType === "doctor") {
              matchRoleType = String(item.fit_flag) === "1";
            } else if (currentFilters.roleType === "nurse") {
              matchRoleType = String(item.fit_flag) === "0";
            }
            // 'all-role' 不需要筛选条件

            return matchOrderType && matchRoleType;
          });

          renderYizhuTable(filtered);

          // 显示筛选结果提示
          var orderTypeText =
            currentFilters.orderType === "long"
              ? "长期医嘱"
              : currentFilters.orderType === "temp"
              ? "临时医嘱"
              : "全部医嘱";
          var roleTypeText =
            currentFilters.roleType === "doctor"
              ? "医生医嘱"
              : currentFilters.roleType === "nurse"
              ? "护士医嘱"
              : "全部";

          if (
            currentFilters.orderType !== "all" ||
            currentFilters.roleType !== "all-role"
          ) {
            layer.msg(`已筛选：${orderTypeText} - ${roleTypeText}`, {
              icon: 1,
              time: 1500,
            });
          } else {
            layer.msg("已显示全部医嘱", { icon: 1, time: 1000 });
          }
        }

        // 按钮筛选事件 - 医嘱类型
        $(document).on("click", "#btn-long-order", function () {
          setActiveButton(
            "#btn-long-order, #btn-temp-order, #btn-all-order",
            "#btn-long-order"
          );
          currentFilters.orderType = "long";
          applyFilters();
        });

        $(document).on("click", "#btn-temp-order", function () {
          setActiveButton(
            "#btn-long-order, #btn-temp-order, #btn-all-order",
            "#btn-temp-order"
          );
          currentFilters.orderType = "temp";
          applyFilters();
        });

        $(document).on("click", "#btn-all-order", function () {
          setActiveButton(
            "#btn-long-order, #btn-temp-order, #btn-all-order",
            "#btn-all-order"
          );
          currentFilters.orderType = "all";
          applyFilters();
        });

        // 按钮筛选事件 - 开嘱人类型
        $(document).on("click", "#btn-doctor-order", function () {
          setActiveButton(
            "#btn-doctor-order, #btn-nurse-order, #btn-all-role",
            "#btn-doctor-order"
          );
          currentFilters.roleType = "doctor";
          applyFilters();
        });

        $(document).on("click", "#btn-nurse-order", function () {
          setActiveButton(
            "#btn-doctor-order, #btn-nurse-order, #btn-all-role",
            "#btn-nurse-order"
          );
          currentFilters.roleType = "nurse";
          applyFilters();
        });

        $(document).on("click", "#btn-all-role", function () {
          setActiveButton(
            "#btn-doctor-order, #btn-nurse-order, #btn-all-role",
            "#btn-all-role"
          );
          currentFilters.roleType = "all-role";
          applyFilters();
        });

        // 默认加载全部并设置默认选中状态
        loadYizhuData();

        // 头工具栏事件
        table.on("toolbar(yizhu-table)", function (obj) {
          switch (obj.event) {
            case "refresh":
              table.reload("yizhu-table");
              break;
            case "export":
              layer.msg("导出功能开发中...");
              break;
          }
        });

        // 行工具栏事件
        table.on("tool(yizhu-table)", function (obj) {
          var data = obj.data;
          if (obj.event === "detail") {
            layer.open({
              type: 1,
              title: "医嘱详情",
              area: ["600px", "400px"],
              content:
                '<div style="padding: 20px;">' +
                "<p><strong>医嘱日期：</strong>" +
                data.order_date +
                " " +
                data.order_time +
                "</p>" +
                "<p><strong>医嘱类型：</strong>" +
                data.order_type_name +
                "</p>" +
                "<p><strong>医嘱内容：</strong>" +
                data.order_text +
                "</p>" +
                "<p><strong>剂量：</strong>" +
                (data.dosage || "") +
                "</p>" +
                "<p><strong>频次：</strong>" +
                (data.frequency || "") +
                "</p>" +
                "<p><strong>用法：</strong>" +
                (data.usage || "") +
                "</p>" +
                "<p><strong>开嘱医生：</strong>" +
                data.doctor_name +
                "</p>" +
                "<p><strong>状态：</strong>" +
                data.status_name +
                "</p>" +
                "</div>",
            });
          } else if (obj.event === "revoke") {
            layer.msg("撤销功能开发中...");
          } else if (obj.event === "stop") {
            layer.msg("停止功能开发中...");
          }
        });
      });
    </script>
  </body>
</html>
