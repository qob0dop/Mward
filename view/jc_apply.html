<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>检查申请</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="../lib/layui-v2.6.3/css/layui.css"
      media="all"
    />
    <link rel="stylesheet" href="../css/public.css" media="all" />
    <style>
      body {
        background-color: transparent;
        padding: 0;
        margin: 0;
        font-size: 14px;
        height: calc(100vh - 180px);
        overflow: hidden;
      }

      /* Pad端优化样式 */
      .layui-table-cell {
        height: auto;
        white-space: normal;
        padding: 0 8px;
        font-size: 13px;
        line-height: 1.4;
      }

      /* 容器全宽设置 */
      .layui-container {
        width: 100%;
        max-width: 100%;
        padding: 5px;
        margin: 0;
        height: 100%;
      }

      .layui-row,
      .layui-col-md12 {
        padding: 0;
        margin: 0;
        height: 100%;
      }

      /* 状态颜色 */
      .status-pending {
        color: #ff5722;
        font-weight: bold;
      }
      .status-completed {
        color: #009688;
        font-weight: bold;
      }
      .status-cancelled {
        color: #999;
      }

      /* 工具栏按钮优化 */
      .layui-btn-container {
        padding: 4px 0;
      }

      .layui-btn-container .layui-btn {
        height: 28px;
        line-height: 28px;
        padding: 0 10px;
        font-size: 13px;
        margin: 0 2px;
      }

      .layui-btn-container .layui-btn i {
        font-size: 13px;
      }

      /* 表格头部优化 */
      .layui-table th {
        font-size: 14px;
        font-weight: bold;
        background-color: #f8f9fa;
      }

      /* 患者信息栏优化 */
      .layui-elem-quote {
        padding: 15px;
        font-size: 16px;
        margin-bottom: 0;
        border-radius: 0;
        background-color: #1e9fff;
        color: #fff;
      }

      #patient-info {
        font-size: 14px !important;
        color: #666 !important;
      }

      /* 套餐选择弹窗优化 */
      .package-form .layui-form-label {
        width: 100px;
        font-size: 16px;
        padding: 15px;
      }

      .package-form .layui-input-block {
        margin-left: 100px;
      }

      .package-form .layui-input,
      .package-form .layui-select {
        height: 50px;
        line-height: 50px;
        font-size: 16px;
        border-radius: 8px;
      }

      .package-form .layui-btn {
        height: 50px;
        line-height: 50px;
        padding: 0 30px;
        font-size: 18px;
        border-radius: 8px;
        margin: 0 10px;
      }

      /* 套餐选择器样式 */
      .package-selector {
        display: flex;
        height: 320px;
        border: 1px solid #e6e6e6;
        border-radius: 6px;
      }

      .package-left {
        width: 35%;
        border-right: 1px solid #e6e6e6;
        background: #f8f9fa;
      }

      .package-right {
        width: 65%;
        background: #fff;
      }

      .package-list {
        height: 100%;
        overflow-y: auto;
        padding: 6px;
      }

      .package-item {
        padding: 6px 8px;
        margin-bottom: 3px;
        border: 1px solid #e6e6e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: #fff;
      }

      .package-item:hover {
        border-color: #1e9fff;
        background-color: #f8fcff;
      }

      .package-item.selected {
        border-color: #1e9fff;
        background-color: #e8f4fd;
        color: #1e9fff;
      }

      .package-title {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        margin-bottom: 2px;
      }

      .package-desc {
        font-size: 12px;
        color: #666;
        line-height: 1.3;
      }

      .package-item.selected .package-title {
        color: #1e9fff;
      }

      /* 项目列表样式 */
      .items-container {
        height: 100%;
        overflow-y: auto;
        padding: 8px;
      }

      .items-header {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        margin-bottom: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #1e9fff;
      }

      .items-list {
        max-height: 240px;
        overflow-y: auto;
      }

      /* 弹窗按钮区域固定在底部 */
      .dialog-buttons {
        background: #fff;
        padding: 8px 12px;
        border-top: 1px solid #e6e6e6;
        text-align: center;
        margin-top: 10px;
      }

      .dialog-buttons .layui-btn {
        height: 30px;
        line-height: 30px;
        padding: 0 12px;
        font-size: 13px;
      }

      /* 弹窗整体布局 */
      .package-form {
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .package-content {
        flex: 1;
        overflow: hidden;
        padding: 20px;
        padding-bottom: 0;
      }

      .item-checkbox {
        display: flex;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
      }

      .item-checkbox:hover {
        background-color: #f8fcff;
      }

      .item-checkbox input[type="checkbox"] {
        width: 16px;
        height: 16px;
        margin-right: 8px;
        cursor: pointer;
      }

      .item-name {
        font-size: 13px;
        color: #333;
        flex: 1;
      }

      .no-package-selected {
        text-align: center;
        padding: 100px 20px;
        color: #999;
        font-size: 14px;
      }

      /* 响应式优化 */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .layui-btn-container .layui-btn {
          width: 100%;
          margin-right: 0;
        }
      }

      /* 滚动条优化 */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
      }

      /* 表格工具栏样式 */
      .layui-table-tool-temp {
        padding-right: 0;
      }

      .layui-table-tool {
        padding: 5px;
      }

      .layui-table-view {
        margin: 0;
        width: 100%;
        height: calc(100% - 50px);
      }

      .layui-table-box,
      .layui-table-body {
        height: 100%;
      }

      .layui-table {
        margin: 0;
      }

      /* 统一表头样式 */
      .layui-table thead tr {
        background-color: #f2f2f2;
      }
      .layui-table thead th {
        font-size: 13px;
        font-weight: bold;
        color: #333;
        padding: 8px 0;
        line-height: 1.2;
      }
    </style>
  </head>
  <body>
    <div class="layui-container">
      <div class="layui-row">
        <div class="layui-col-md12">
          <!-- <blockquote class="layui-elem-quote">
                    <i class="layui-icon layui-icon-list" style="font-size: 18px; margin-right: 8px;"></i>
                    检查申请信息
                </blockquote> -->

          <!-- 检查申请表格 -->
          <table
            class="layui-hide"
            id="jiancha-table"
            lay-filter="jiancha-table"
          ></table>

          <!-- 操作列模板 -->
          <script type="text/html" id="rowBar">
            <button
              class="layui-btn layui-btn-danger layui-btn-xs"
              lay-event="delRow"
            >
              删除
            </button>
          </script>

          <!-- 工具栏模板 -->
          <script type="text/html" id="toolbarDemo">
            <div class="layui-btn-container">
              <button class="layui-btn layui-btn-warm" lay-event="newApply">
                <i class="layui-icon layui-icon-add-1"></i> 新建申请
              </button>
              <button class="layui-btn layui-btn-warm" lay-event="deleteApply">
                <i class="layui-icon layui-icon-delete"></i> 删除申请
              </button>
            </div>
          </script>

          <!-- 状态模板 -->
          <script type="text/html" id="statusTpl">
            {{# if(d.status == '待执行'){ }}
            <span class="status-pending">
              <i class="layui-icon layui-icon-time"></i> {{d.status}}
            </span>
            {{# } else if(d.status == '已完成'){ }}
            <span class="status-completed">
              <i class="layui-icon layui-icon-ok"></i> {{d.status}}
            </span>
            {{# } else { }}
            <span class="status-cancelled">
              <i class="layui-icon layui-icon-close"></i> {{d.status}}
            </span>
            {{# } }}
          </script>

          <!-- 日期格式化模板 -->
          <script type="text/html" id="dateTpl">
            {{# if(d.apply_date){ }} {{# var date = new Date(d.apply_date); var
            year = date.getFullYear(); var month = (date.getMonth() +
            1).toString().padStart(2, '0'); var day =
            date.getDate().toString().padStart(2, '0'); var hours =
            date.getHours().toString().padStart(2, '0'); var minutes =
            date.getMinutes().toString().padStart(2, '0'); var seconds =
            date.getSeconds().toString().padStart(2, '0'); }}
            {{year}}-{{month}}-{{day}} {{hours}}:{{minutes}}:{{seconds}} {{# }
            else { }} - {{# } }}
          </script>
        </div>
      </div>
    </div>

    <script src="../lib/layui-v2.6.3/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js?v=1.0.4" charset="utf-8"></script>
    <script>
      layui.use(["table", "appconfig", "layer", "form"], function () {
        var table = layui.table;
        var $ = layui.jquery;
        var appconfig = layui.appconfig;
        var layer = layui.layer;
        var form = layui.form;

        // 获取URL参数
        function getUrlParam(name) {
          var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
          var r = window.location.search.substr(1).match(reg);
          if (r != null) return unescape(r[2]);
          return null;
        }

        var patient_id = getUrlParam("patient_id");
        var admiss_times = getUrlParam("admiss_times");

        // 获取患者信息 (已在顶部显示，此处不再重复)

        // 套餐数据变量
        var examPackages = [];
        var allExamItems = []; // 所有检查项目数据

        // 获取检查项目数据
        function loadExamItems(callback) {
          var wardData = localStorage.getItem("wardData");

          if (wardData === null) {
            layer.msg("请先选择病区！");
            location.href = "view/wardlist.html";
            return;
          }
          var jsonData = JSON.parse(wardData);
          localStorage.ward_sn = jsonData.ward_sn;

          $.ajax({
            url:
              appconfig.api +
              "/api/jcjy/GetJianChaList?ward_sn=" +
              (localStorage.ward_sn || ""),
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.status === 1 && res.data) {
                allExamItems = res.data;
                callback(true);
              } else {
                layer.msg("获取检查项目数据失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取检查项目数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取套餐数据
        function loadPackages(callback) {
          var loginUser = localStorage.getItem("loginUser");

          if (loginUser === null) {
            location.href = "login.html";
            return;
          }
          var loginUserData = JSON.parse(loginUser);
          $.ajax({
            url:
              appconfig.api +
              "/api/jcjy/GetCustomerTemplates?type=jiancha&opera=" +
              loginUserData.user_mi,
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.status === 1 && res.data) {
                examPackages = res.data;
                callback(true);
              } else {
                layer.msg("获取套餐数据失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取套餐数据", { icon: 5 });
              callback(false);
            },
          });
        }

        // 获取申请单编号
        function getApplySn(callback) {
          $.ajax({
            url: appconfig.api + "/api/jcjy/GetApplySn",
            type: "GET",
            dataType: "json",
            success: function (res) {
              if (res.status === 1 && res.data) {
                callback(true, res.data);
              } else {
                layer.msg("获取申请单编号失败: " + (res.msg || "未知错误"), {
                  icon: 5,
                });
                callback(false, null);
              }
            },
            error: function () {
              layer.msg("网络错误，无法获取申请单编号", { icon: 5 });
              callback(false, null);
            },
          });
        }

        // 提交检查申请
        function submitExamApply(selectedItems, callback) {
          console.log("提交检查申请 - selectedItems:", selectedItems);
          console.log("提交检查申请 - allExamItems长度:", allExamItems.length);

          var loginUser = localStorage.getItem("loginUser");
          var patientData = JSON.parse(
            localStorage.getItem("patientData") || "{}"
          );

          if (!loginUser) {
            layer.msg("登录信息已过期，请重新登录", { icon: 5 });
            callback(false);
            return;
          }

          var loginUserData = JSON.parse(loginUser);
          var todoList = [];
          var completedCount = 0;
          var totalCount = selectedItems.length;

          console.log("开始处理 selectedItems，总数:", totalCount);

          // 为每个选中的项目创建申请记录
          selectedItems.forEach(function (selectedItem) {
            console.log("处理 selectedItem:", selectedItem);

            // 从allExamItems中找到完整的项目信息
            var fullItem = allExamItems.find(function (item) {
              return (
                item.id == selectedItem.id ||
                item.code == selectedItem.id ||
                item.sub_code == selectedItem.id ||
                item.item_id == selectedItem.id
              );
            });

            console.log("找到的 fullItem:", fullItem);

            if (!fullItem) {
              console.log(
                "未找到对应的 fullItem，selectedItem.id:",
                selectedItem.id
              );
              console.log("allExamItems 样例数据:", allExamItems.slice(0, 3));
              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
              return;
            }

            // 获取申请单编号
            getApplySn(function (success, applyData) {
              console.log(
                "getApplySn 结果 - success:",
                success,
                "applyData:",
                applyData
              );

              if (success && applyData) {
                var wardData = JSON.parse(
                  localStorage.getItem("wardData") || "{}"
                );

                // 获取当前本地时间
                var now = new Date();
                var localDateTime =
                  now.getFullYear() +
                  "-" +
                  (now.getMonth() + 1).toString().padStart(2, "0") +
                  "-" +
                  now.getDate().toString().padStart(2, "0") +
                  " " +
                  now.getHours().toString().padStart(2, "0") +
                  ":" +
                  now.getMinutes().toString().padStart(2, "0") +
                  ":" +
                  now.getSeconds().toString().padStart(2, "0");

                var applyModel = {
                  // 申请单编号相关
                  exam_serial:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  apply_date: localDateTime,

                  // 检查项目信息
                  exam_type: fullItem.type_code || fullItem.exam_type || "",
                  exam_type_name:
                    fullItem.type_code_name || fullItem.exam_type_name || "",
                  exam_sub_type: fullItem.sub_code || fullItem.code || "",
                  exam_sub_type_name:
                    fullItem.sub_code_name ||
                    fullItem.name ||
                    fullItem.item_name ||
                    "",
                  exec_unit: fullItem.exec_unit || "",
                  exec_unit_name: fullItem.exec_unit_name || "",

                  // 基础字段
                  exam_no:
                    applyData.apply_date +
                    applyData.apply_sn.toString().padStart(5, "0"),
                  patient_id: patient_id,
                  admiss_times: admiss_times,
                  apply_doctor: loginUserData.user_mi,
                  scheduled_date: localDateTime,
                  inpatient_no: patientData.inpatient_no || "",
                  apply_unit: wardData.ward_sn || localStorage.ward_sn || "",
                  erem_flag: "0", // 默认非急诊
                  exam_status: "0",
                  add_new: true,
                  charge_amount: 1,
                  zy_mz_flag: "1",
                  // 第三方申请信息
                  third_apply_type: fullItem.third_apply_type || "",
                  third_apply_class: fullItem.third_apply_class || "",

                  // 检查附加信息
                  exam_add_info: " ",
                  exam_add_info2: patientData.admiss_diag_name || " ",
                  exam_add_info3: " ",
                  exam_add_info4: " ",
                };

                console.log("创建的 applyModel:", applyModel);
                todoList.push(applyModel);
                console.log("添加到 todoList 后，长度:", todoList.length);
              } else {
                console.log("获取申请单编号失败");
              }

              completedCount++;
              if (completedCount === totalCount) {
                submitAllApplies();
              }
            });
          });

          // 提交所有申请
          function submitAllApplies() {
            console.log("submitAllApplies - todoList长度:", todoList.length);
            console.log("submitAllApplies - todoList内容:", todoList);

            if (todoList.length === 0) {
              layer.msg("没有有效的申请数据", { icon: 5 });
              callback(false);
              return;
            }

            $.ajax({
              url: appconfig.api + "/api/jcjy/JianchaSubmit",
              type: "POST",
              contentType: "application/json",
              data: JSON.stringify(todoList),
              dataType: "json",
              success: function (res) {
                if (res.status === 1) {
                  callback(true);
                } else {
                  layer.msg("提交申请失败: " + (res.msg || "未知错误"), {
                    icon: 5,
                  });
                  callback(false);
                }
              },
              error: function () {
                layer.msg("网络错误，申请提交失败", { icon: 5 });
                callback(false);
              },
            });
          }
        }

        // 渲染表格
        table.render({
          elem: "#jiancha-table",
          url:
            appconfig.api +
            "/api/jcjy/GetJianChaApplys_JZZXYY?patient_id=" +
            patient_id +
            "&admiss_times=" +
            admiss_times +
            "&subsys_id=" +
            (localStorage.subsys_id || ""),
          toolbar: "#toolbarDemo",
          defaultToolbar: [],
          cellMinWidth: 50,
          cols: [
            [
              { field: "exam_serial", title: "申请单号", width: 110 },
              { field: "exam_status", title: "检查状态", width: 80 },
              { field: "exam_type_name", title: "检查类型", width: 100 },
              { field: "exam_sub_type_name", title: "检查项目", minWidth: 180 },
              { field: "charge_amount", title: "数量", width: 60 },
              {
                field: "apply_date",
                title: "申请日期",
                width: 140,
                sort: true,
                templet: "#dateTpl",
              },
              { field: "exam_flag_str", title: "增强或重建", width: 90 },
              { field: "parent_serial", title: "父申请号", width: 100 },
              {
                fixed: "right",
                title: "操作",
                width: 80,
                align: "center",
                toolbar: "#rowBar",
              },
            ],
          ],
          height: "full-42",
          text: {
            none: '<div style="text-align: center; padding: 20px; color: #999; font-size: 13px;"><i class="layui-icon layui-icon-file" style="font-size: 36px; display: block; margin-bottom: 8px;"></i>暂无检查申请数据</div>',
          },
          parseData: function (res) {
            console.log("表格接口返回数据:", res);
            return {
              code: res.status === 1 ? 0 : res.status,
              msg: res.msg || "",
              count: res.data ? res.data.length : 0,
              data: res.data || [],
            };
          },
        });

        // 头工具栏事件
        table.on("toolbar(jiancha-table)", function (obj) {
          switch (obj.event) {
            case "newApply":
              // 显示加载提示
              var loadingIndex = layer.msg("正在加载数据...", {
                icon: 16,
                shade: 0.3,
                time: 0,
              });

              // 先加载检查项目数据，再加载套餐数据
              loadExamItems(function (itemsSuccess) {
                if (!itemsSuccess) {
                  layer.close(loadingIndex);
                  return;
                }

                // 加载套餐数据
                loadPackages(function (packagesSuccess) {
                  layer.close(loadingIndex);

                  if (!packagesSuccess) {
                    return;
                  }

                  // 生成套餐选择HTML
                  var packageHtml = "";
                  examPackages.forEach(function (pkg) {
                    packageHtml +=
                      '<div class="package-item" data-id="' +
                      pkg.id +
                      '">' +
                      '<div class="package-title">' +
                      (pkg.name || "未命名套餐") +
                      "</div>" +
                      '<div class="package-desc">' +
                      (pkg.value || "无描述") +
                      "</div>" +
                      "</div>";
                  });

                  layer.open({
                    type: 1,
                    title:
                      '<i class="layui-icon layui-icon-add-1"></i> 选择检查项目',
                    area: ["85%", "380px"],
                    maxmin: true,
                    resize: false,
                    content:
                      '<div class="package-form">' +
                      '<div class="package-content">' +
                      '<div class="package-selector">' +
                      '<div class="package-left">' +
                      '<div style="padding: 8px; background: #1e9fff; color: #fff; font-weight: bold; text-align: center; font-size: 13px;">检查套餐</div>' +
                      '<div class="package-list">' +
                      packageHtml +
                      "</div>" +
                      "</div>" +
                      '<div class="package-right">' +
                      '<div class="items-container">' +
                      '<div class="no-package-selected">' +
                      '<i class="layui-icon layui-icon-file" style="font-size: 36px; display: block; margin-bottom: 8px;"></i>' +
                      "请先选择左侧的检查套餐" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      "</div>" +
                      '<div class="dialog-buttons">' +
                      '<button class="layui-btn layui-btn-normal" id="confirm-items">' +
                      '<i class="layui-icon layui-icon-ok"></i> 确认申请' +
                      "</button>" +
                      '<button class="layui-btn layui-btn-primary" id="cancel-items">' +
                      '<i class="layui-icon layui-icon-close"></i> 取消' +
                      "</button>" +
                      "</div>" +
                      "</div>",
                    success: function (layero, index) {
                      var selectedPackage = null;
                      var selectedItems = [];

                      // 显示项目列表
                      function showItems(pkg) {
                        var pkgTitle = pkg.title || pkg.name || "未命名套餐";
                        var itemsHtml =
                          '<div class="items-header">' +
                          pkgTitle +
                          " - 检查项目</div>" +
                          '<div class="items-list">';

                        // 根据套餐的value值过滤项目
                        var packageItems = [];
                        if (pkg.value && allExamItems.length > 0) {
                          var valueIds = pkg.value.split(",");
                          valueIds.forEach(function (id) {
                            var trimmedId = id.trim();
                            var item = allExamItems.find(function (examItem) {
                              return (
                                examItem.id == trimmedId ||
                                examItem.code == trimmedId
                              );
                            });
                            if (item) {
                              packageItems.push(item);
                            }
                          });
                        }
                        console.log("过滤后的项目数据:", packageItems);
                        if (packageItems.length > 0) {
                          packageItems.forEach(function (item) {
                            console.log("生成checkbox的item数据:", item);

                            // 尝试多个可能的id字段名
                            var itemId =
                              item.id ||
                              item.code ||
                              item.sub_code ||
                              item.item_id ||
                              "";
                            console.log("使用的itemId:", itemId);

                            itemsHtml +=
                              '<label class="item-checkbox">' +
                              '<input type="checkbox" value="' +
                              itemId +
                              '" data-name="' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              '" data-price="' +
                              (item.price || item.charge_amount || "0.00") +
                              '">' +
                              '<span class="item-name">' +
                              (item.name ||
                                item.item_name ||
                                item.sub_code_name) +
                              "</span>" +
                              "</label>";
                          });
                        } else {
                          itemsHtml +=
                            '<div style="text-align: center; padding: 50px; color: #999;">该套餐暂无项目数据</div>';
                        }

                        itemsHtml += "</div>";

                        $(layero).find(".items-container").html(itemsHtml);

                        // 监听项目选择
                        $(layero)
                          .find(".item-checkbox input")
                          .change(function () {
                            updateSelectedItems();
                          });
                      }

                      // 更新选中项目列表
                      function updateSelectedItems() {
                        selectedItems = [];
                        $(layero)
                          .find(".item-checkbox input:checked")
                          .each(function () {
                            selectedItems.push({
                              id: $(this).val(),
                              name: $(this).data("name"),
                              price: $(this).data("price"),
                            });
                          });
                      }

                      // 套餐选择事件
                      $(layero)
                        .find(".package-item")
                        .click(function () {
                          $(layero)
                            .find(".package-item")
                            .removeClass("selected");
                          $(this).addClass("selected");
                          selectedPackage = examPackages.find(
                            (pkg) => pkg.id == $(this).data("id")
                          );
                          selectedItems = []; // 切换套餐时清空已选项目
                          showItems(selectedPackage);
                        });

                      // 确认申请
                      $(layero)
                        .find("#confirm-items")
                        .click(function () {
                          if (!selectedPackage) {
                            layer.msg("请先选择一个检查套餐", { icon: 5 });
                            return;
                          }

                          if (selectedItems.length === 0) {
                            layer.msg("请至少选择一个检查项目", { icon: 5 });
                            return;
                          }

                          // 显示提交进度
                          var submitIndex = layer.msg("正在提交申请...", {
                            icon: 16,
                            shade: 0.3,
                            time: 0,
                          });

                          // 提交申请
                          submitExamApply(selectedItems, function (success) {
                            layer.close(submitIndex);
                            if (success) {
                              layer.msg("检查项目申请成功！", {
                                icon: 1,
                                time: 2000,
                                end: function () {
                                  layer.close(index);
                                  table.reload("jiancha-table");
                                },
                              });
                            }
                          });
                        });

                      // 取消申请
                      $(layero)
                        .find("#cancel-items")
                        .click(function () {
                          layer.close(index);
                        });
                    },
                  });
                });
              });
              break;
          }
        });

        // 操作列模板
        table.on("tool(jiancha-table)", function (obj) {
          var data = obj.data;
          var layEvent = obj.event;

          if (layEvent === "delRow") {
            // 删除前先检查状态
            if (data.exam_status == 1) {
              layer.confirm(
                "确定删除该申请吗？",
                { icon: 3, title: "提示" },
                function (index) {
                  console.log("本行数据", data);
                  // 执行删除操作的代码
                  $.ajax({
                    url: appconfig.api + "/api/JcJy/DelJianCha",
                    type: "GET",
                    contentType: "application/json",
                    data: {
                      patient_id: data.patient_id,
                      admiss_times: data.admiss_times,
                      exam_no: data.exam_no,
                      // 还有 sybsys_id, opera 如有需要也加上
                    },
                    dataType: "json",
                    success: function (res) {
                      if (res.status === 1) {
                        layer.msg("删除成功", { icon: 1 });
                        console.log(res);
                        table.reload("jiancha-table");
                      } else {
                        console.error("删除失败:", res);
                        layer.msg("删除失败: " + (res.msg || "未知错误"), {
                          icon: 5,
                        });
                      }
                    },
                    error: function (xhr, status, err) {
                      console.error("删除请求异常:", xhr, status, err);
                      layer.msg("网络错误，删除失败", { icon: 5 });
                    },
                  });
                  layer.close(index);
                }
              );
            } else {
              layer.msg("该申请状态不可删除！", { icon: 5 });
            }
          }
        });
      });
    </script>
  </body>
</html>
